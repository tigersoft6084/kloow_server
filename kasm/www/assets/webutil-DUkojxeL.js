(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))i(n);new MutationObserver(n=>{for(const r of n)if(r.type==="childList")for(const a of r.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&i(a)}).observe(document,{childList:!0,subtree:!0});function t(n){const r={};return n.integrity&&(r.integrity=n.integrity),n.referrerPolicy&&(r.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?r.credentials="include":n.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function i(n){if(n.ep)return;n.ep=!0;const r=t(n);fetch(n.href,r)}})();let qt="warn",C=()=>{},I=()=>{},V=()=>{},A=()=>{};function Bt(s){if(typeof s>"u"?s=qt:qt=s,C=I=V=A=()=>{},typeof window.console<"u")switch(s){case"debug":C=console.debug.bind(window.console);case"info":I=console.info.bind(window.console);case"warn":V=console.warn.bind(window.console);case"error":A=console.error.bind(window.console);case"none":break;default:throw new window.Error("invalid logging type '"+s+"'")}}Bt();let _s="ontouchstart"in document.documentElement||document.ontouchstart!==void 0||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0;window.addEventListener("touchstart",function s(){_s=!0,window.removeEventListener("touchstart",s,!1)},!1);let Jt=10*(window.devicePixelRatio||1),fs=!1;try{const s=document.createElement("canvas");s.style.cursor='url("data:image/x-icon;base64,AAACAAEACAgAAAIAAgA4AQAAFgAAACgAAAAIAAAAEAAAAAEAIAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAD/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////AAAAAAAAAAAAAAAAAAAAAA==") 2 2, default',s.style.cursor.indexOf("url")===0?(I("Data URI scheme cursor supported"),fs=!0):V("Data URI scheme cursor not supported")}catch(s){A("Data URI scheme cursor test exception: "+s)}const Ns=fs;let us=!0;try{const s=document.createElement("div");s.style.visibility="hidden",s.style.overflow="scroll",document.body.appendChild(s);const e=document.createElement("div");s.appendChild(e);const t=s.offsetWidth-e.offsetWidth;s.parentNode.removeChild(s),us=t!=0}catch(s){A("Scrollbar test exception: "+s)}const $r=us;function ue(){return navigator&&!!/mac/i.exec(navigator.platform)}function at(){return navigator&&!!/win/i.exec(navigator.platform)}function Ce(){return navigator&&(!!/ipad/i.exec(navigator.platform)||!!/iphone/i.exec(navigator.platform)||!!/ipod/i.exec(navigator.platform))}function Os(){return navigator&&navigator.userAgent.indexOf("Safari")!==-1&&navigator.userAgent.indexOf("Chrome")===-1}function zs(){var s=navigator.userAgent;return Ce()||s.indexOf("OculusBrowser")!=-1||s.indexOf("SamsungBrowser")!=-1?!1:s.indexOf("Windows")!=-1||s.indexOf("Mac")!=-1||s.indexOf("X11")!=-1||s.indexOf("Linux")!=-1}function Vs(){var s=window.navigator.userAgent,e=s.indexOf("MSIE "),t=!1;e>0&&(t=parseInt(s.substring(e+5,s.indexOf(".",e)),10));var i=s.indexOf("Trident/");if(i>0){var n=s.indexOf("rv:");t=parseInt(s.substring(n+3,s.indexOf(".",n)),10)}var r=s.indexOf("Edge/");return r>0&&(t=parseInt(s.substring(r+5,s.indexOf(".",r)),10)),t}function Ws(){return!!window.chrome}function Gs(){return navigator&&!!/firefox/i.exec(navigator.userAgent)}function qr(){return Os()||Gs()?!1:navigator.clipboard&&typeof navigator.clipboard.read=="function"}function Jr(){return Ce()||Vs()?!1:document.exitPointerLock}function ea(s){return s.changedTouches?s.changedTouches[0]:s.touches?s.touches[0]:s}function ge(s){s.stopPropagation(),s.preventDefault()}let mt=!1,xs=null;document.captureElement=null;function _e(s){if(mt)return;const e=new s.constructor(s.type,s);mt=!0,document.captureElement?document.captureElement.dispatchEvent(e):xs.dispatchEvent(e),mt=!1,s.stopPropagation(),e.defaultPrevented&&s.preventDefault(),s.type==="mouseup"&&bs()}function ps(){const s=document.getElementById("noVNC_mouse_capture_elem");s.style.cursor=window.getComputedStyle(document.captureElement).cursor}const gs=new MutationObserver(ps);function Ys(s){if(s.setCapture)s.setCapture(),document.captureElement=s;else{bs();let e=document.getElementById("noVNC_mouse_capture_elem");e===null&&(e=document.createElement("div"),e.id="noVNC_mouse_capture_elem",e.style.position="fixed",e.style.top="0px",e.style.left="0px",e.style.width="100%",e.style.height="100%",e.style.zIndex=1e4,e.style.display="none",document.body.appendChild(e),e.addEventListener("contextmenu",_e),e.addEventListener("mousemove",_e),e.addEventListener("mouseup",_e)),document.captureElement=s,gs.observe(s,{attributes:!0}),ps(),e.style.display="",window.addEventListener("mousemove",_e),window.addEventListener("mouseup",_e)}}function bs(){if(document.releaseCapture)document.releaseCapture(),document.captureElement=null;else{if(!document.captureElement)return;xs=document.captureElement,document.captureElement=null,gs.disconnect();const s=document.getElementById("noVNC_mouse_capture_elem");s.style.display="none",window.removeEventListener("mousemove",_e),window.removeEventListener("mouseup",_e)}}const _={XK_BackSpace:65288,XK_Tab:65289,XK_Clear:65291,XK_Return:65293,XK_Pause:65299,XK_Scroll_Lock:65300,XK_Escape:65307,XK_Delete:65535,XK_Multi_key:65312,XK_Codeinput:65335,XK_SingleCandidate:65340,XK_MultipleCandidate:65341,XK_PreviousCandidate:65342,XK_Kanji:65313,XK_Muhenkan:65314,XK_Henkan:65315,XK_Romaji:65316,XK_Hiragana:65317,XK_Katakana:65318,XK_Hiragana_Katakana:65319,XK_Zenkaku:65320,XK_Hankaku:65321,XK_Zenkaku_Hankaku:65322,XK_Kana_Shift:65326,XK_Eisu_toggle:65328,XK_Home:65360,XK_Left:65361,XK_Up:65362,XK_Right:65363,XK_Down:65364,XK_Prior:65365,XK_Next:65366,XK_End:65367,XK_Select:65376,XK_Print:65377,XK_Execute:65378,XK_Insert:65379,XK_Undo:65381,XK_Redo:65382,XK_Menu:65383,XK_Find:65384,XK_Cancel:65385,XK_Help:65386,XK_Mode_switch:65406,XK_Num_Lock:65407,XK_KP_Space:65408,XK_KP_Enter:65421,XK_KP_Home:65429,XK_KP_Left:65430,XK_KP_Up:65431,XK_KP_Right:65432,XK_KP_Down:65433,XK_KP_Prior:65434,XK_KP_Next:65435,XK_KP_End:65436,XK_KP_Begin:65437,XK_KP_Insert:65438,XK_KP_Delete:65439,XK_KP_Equal:65469,XK_KP_Multiply:65450,XK_KP_Add:65451,XK_KP_Separator:65452,XK_KP_Subtract:65453,XK_KP_Decimal:65454,XK_KP_Divide:65455,XK_KP_0:65456,XK_KP_1:65457,XK_KP_2:65458,XK_KP_3:65459,XK_KP_4:65460,XK_KP_5:65461,XK_KP_6:65462,XK_KP_7:65463,XK_KP_8:65464,XK_KP_9:65465,XK_F1:65470,XK_F2:65471,XK_F3:65472,XK_F4:65473,XK_F5:65474,XK_F6:65475,XK_F7:65476,XK_F8:65477,XK_F9:65478,XK_F10:65479,XK_F11:65480,XK_F12:65481,XK_F13:65482,XK_F14:65483,XK_F15:65484,XK_F16:65485,XK_F17:65486,XK_F18:65487,XK_F19:65488,XK_F20:65489,XK_F21:65490,XK_F22:65491,XK_F23:65492,XK_F24:65493,XK_F25:65494,XK_F26:65495,XK_F27:65496,XK_F28:65497,XK_F29:65498,XK_F30:65499,XK_F31:65500,XK_F32:65501,XK_F33:65502,XK_F34:65503,XK_F35:65504,XK_Shift_L:65505,XK_Shift_R:65506,XK_Control_L:65507,XK_Control_R:65508,XK_Caps_Lock:65509,XK_Meta_L:65511,XK_Meta_R:65512,XK_Alt_L:65513,XK_Alt_R:65514,XK_Super_L:65515,XK_Super_R:65516,XK_ISO_Level3_Shift:65027,XK_ISO_Next_Group:65032,XK_ISO_Prev_Group:65034,XK_ISO_First_Group:65036,XK_ISO_Last_Group:65038,XK_space:32,XK_asterisk:42,XK_plus:43,XK_comma:44,XK_minus:45,XK_period:46,XK_slash:47,XK_0:48,XK_1:49,XK_2:50,XK_3:51,XK_4:52,XK_5:53,XK_6:54,XK_7:55,XK_8:56,XK_9:57,XK_equal:61,XK_Hangul:65329,XK_Hangul_Hanja:65332,XK_Hangul_Jeonja:65336,XF86XK_MonBrightnessUp:269025026,XF86XK_MonBrightnessDown:269025027,XF86XK_Standby:269025040,XF86XK_AudioLowerVolume:269025041,XF86XK_AudioMute:269025042,XF86XK_AudioRaiseVolume:269025043,XF86XK_AudioPlay:269025044,XF86XK_AudioStop:269025045,XF86XK_AudioPrev:269025046,XF86XK_AudioNext:269025047,XF86XK_HomePage:269025048,XF86XK_Mail:269025049,XF86XK_Search:269025051,XF86XK_AudioRecord:269025052,XF86XK_Calculator:269025053,XF86XK_Calendar:269025056,XF86XK_PowerDown:269025057,XF86XK_Back:269025062,XF86XK_Forward:269025063,XF86XK_Stop:269025064,XF86XK_Refresh:269025065,XF86XK_PowerOff:269025066,XF86XK_WakeUp:269025067,XF86XK_Eject:269025068,XF86XK_ScreenSaver:269025069,XF86XK_WWW:269025070,XF86XK_Favorites:269025072,XF86XK_AudioPause:269025073,XF86XK_AudioMedia:269025074,XF86XK_MyComputer:269025075,XF86XK_BrightnessAdjust:269025083,XF86XK_AudioRewind:269025086,XF86XK_Close:269025110,XF86XK_Copy:269025111,XF86XK_Cut:269025112,XF86XK_Excel:269025116,XF86XK_LogOff:269025121,XF86XK_New:269025128,XF86XK_Open:269025131,XF86XK_Paste:269025133,XF86XK_Phone:269025134,XF86XK_Reply:269025138,XF86XK_Save:269025143,XF86XK_Send:269025147,XF86XK_Spell:269025148,XF86XK_SplitScreen:269025149,XF86XK_Word:269025161,XF86XK_ZoomIn:269025163,XF86XK_ZoomOut:269025164,XF86XK_WebCam:269025167,XF86XK_MailForward:269025168,XF86XK_Music:269025170,XF86XK_AudioForward:269025175,XF86XK_AudioRandomPlay:269025177,XF86XK_Subtitle:269025178,XF86XK_AudioCycleTrack:269025179,XF86XK_Hibernate:269025192,XF86XK_AudioMicMute:269025202,XF86XK_Next_VMode:269024802},js={256:960,257:992,258:451,259:483,260:417,261:433,262:454,263:486,264:710,265:742,266:709,267:741,268:456,269:488,270:463,271:495,272:464,273:496,274:938,275:954,278:972,279:1004,280:458,281:490,282:460,283:492,284:728,285:760,286:683,287:699,288:725,289:757,290:939,291:955,292:678,293:694,294:673,295:689,296:933,297:949,298:975,299:1007,302:967,303:999,304:681,305:697,308:684,309:700,310:979,311:1011,312:930,313:453,314:485,315:934,316:950,317:421,318:437,321:419,322:435,323:465,324:497,325:977,326:1009,327:466,328:498,330:957,331:959,332:978,333:1010,336:469,337:501,338:5052,339:5053,340:448,341:480,342:931,343:947,344:472,345:504,346:422,347:438,348:734,349:766,350:426,351:442,352:425,353:441,354:478,355:510,356:427,357:443,358:940,359:956,360:989,361:1021,362:990,363:1022,364:733,365:765,366:473,367:505,368:475,369:507,370:985,371:1017,376:5054,377:428,378:444,379:431,380:447,381:430,382:446,402:2294,466:16777681,711:439,728:418,729:511,731:434,733:445,901:1966,902:1953,904:1954,905:1955,906:1956,908:1959,910:1960,911:1963,912:1974,913:1985,914:1986,915:1987,916:1988,917:1989,918:1990,919:1991,920:1992,921:1993,922:1994,923:1995,924:1996,925:1997,926:1998,927:1999,928:2e3,929:2001,931:2002,932:2004,933:2005,934:2006,935:2007,936:2008,937:2009,938:1957,939:1961,940:1969,941:1970,942:1971,943:1972,944:1978,945:2017,946:2018,947:2019,948:2020,949:2021,950:2022,951:2023,952:2024,953:2025,954:2026,955:2027,956:2028,957:2029,958:2030,959:2031,960:2032,961:2033,962:2035,963:2034,964:2036,965:2037,966:2038,967:2039,968:2040,969:2041,970:1973,971:1977,972:1975,973:1976,974:1979,1025:1715,1026:1713,1027:1714,1028:1716,1029:1717,1030:1718,1031:1719,1032:1720,1033:1721,1034:1722,1035:1723,1036:1724,1038:1726,1039:1727,1040:1761,1041:1762,1042:1783,1043:1767,1044:1764,1045:1765,1046:1782,1047:1786,1048:1769,1049:1770,1050:1771,1051:1772,1052:1773,1053:1774,1054:1775,1055:1776,1056:1778,1057:1779,1058:1780,1059:1781,1060:1766,1061:1768,1062:1763,1063:1790,1064:1787,1065:1789,1066:1791,1067:1785,1068:1784,1069:1788,1070:1760,1071:1777,1072:1729,1073:1730,1074:1751,1075:1735,1076:1732,1077:1733,1078:1750,1079:1754,1080:1737,1081:1738,1082:1739,1083:1740,1084:1741,1085:1742,1086:1743,1087:1744,1088:1746,1089:1747,1090:1748,1091:1749,1092:1734,1093:1736,1094:1731,1095:1758,1096:1755,1097:1757,1098:1759,1099:1753,1100:1752,1101:1756,1102:1728,1103:1745,1105:1699,1106:1697,1107:1698,1108:1700,1109:1701,1110:1702,1111:1703,1112:1704,1113:1705,1114:1706,1115:1707,1116:1708,1118:1710,1119:1711,1168:1725,1169:1709,1488:3296,1489:3297,1490:3298,1491:3299,1492:3300,1493:3301,1494:3302,1495:3303,1496:3304,1497:3305,1498:3306,1499:3307,1500:3308,1501:3309,1502:3310,1503:3311,1504:3312,1505:3313,1506:3314,1507:3315,1508:3316,1509:3317,1510:3318,1511:3319,1512:3320,1513:3321,1514:3322,1548:1452,1563:1467,1567:1471,1569:1473,1570:1474,1571:1475,1572:1476,1573:1477,1574:1478,1575:1479,1576:1480,1577:1481,1578:1482,1579:1483,1580:1484,1581:1485,1582:1486,1583:1487,1584:1488,1585:1489,1586:1490,1587:1491,1588:1492,1589:1493,1590:1494,1591:1495,1592:1496,1593:1497,1594:1498,1600:1504,1601:1505,1602:1506,1603:1507,1604:1508,1605:1509,1606:1510,1607:1511,1608:1512,1609:1513,1610:1514,1611:1515,1612:1516,1613:1517,1614:1518,1615:1519,1616:1520,1617:1521,1618:1522,3585:3489,3586:3490,3587:3491,3588:3492,3589:3493,3590:3494,3591:3495,3592:3496,3593:3497,3594:3498,3595:3499,3596:3500,3597:3501,3598:3502,3599:3503,3600:3504,3601:3505,3602:3506,3603:3507,3604:3508,3605:3509,3606:3510,3607:3511,3608:3512,3609:3513,3610:3514,3611:3515,3612:3516,3613:3517,3614:3518,3615:3519,3616:3520,3617:3521,3618:3522,3619:3523,3620:3524,3621:3525,3622:3526,3623:3527,3624:3528,3625:3529,3626:3530,3627:3531,3628:3532,3629:3533,3630:3534,3631:3535,3632:3536,3633:3537,3634:3538,3635:3539,3636:3540,3637:3541,3638:3542,3639:3543,3640:3544,3641:3545,3642:3546,3647:3551,3648:3552,3649:3553,3650:3554,3651:3555,3652:3556,3653:3557,3654:3558,3655:3559,3656:3560,3657:3561,3658:3562,3659:3563,3660:3564,3661:3565,3664:3568,3665:3569,3666:3570,3667:3571,3668:3572,3669:3573,3670:3574,3671:3575,3672:3576,3673:3577,8194:2722,8195:2721,8196:2723,8197:2724,8199:2725,8200:2726,8201:2727,8202:2728,8210:2747,8211:2730,8212:2729,8213:1967,8215:3295,8216:2768,8217:2769,8218:2813,8220:2770,8221:2771,8222:2814,8224:2801,8225:2802,8226:2790,8229:2735,8230:2734,8240:2773,8242:2774,8243:2775,8248:2812,8254:1150,8361:3839,8364:8364,8453:2744,8470:1712,8471:2811,8478:2772,8482:2761,8531:2736,8532:2737,8533:2738,8534:2739,8535:2740,8536:2741,8537:2742,8538:2743,8539:2755,8540:2756,8541:2757,8542:2758,8592:2299,8593:2300,8594:2301,8595:2302,8658:2254,8660:2253,8706:2287,8711:2245,8728:3018,8730:2262,8733:2241,8734:2242,8743:2270,8744:2271,8745:2268,8746:2269,8747:2239,8756:2240,8764:2248,8771:2249,8773:16785992,8800:2237,8801:2255,8804:2236,8805:2238,8834:2266,8835:2267,8866:3068,8867:3036,8868:3010,8869:3022,8968:3027,8970:3012,8981:2810,8992:2212,8993:2213,9109:3020,9115:2219,9117:2220,9118:2221,9120:2222,9121:2215,9123:2216,9124:2217,9126:2218,9128:2223,9132:2224,9143:2209,9146:2543,9147:2544,9148:2546,9149:2547,9225:2530,9226:2533,9227:2537,9228:2531,9229:2532,9251:2732,9252:2536,9472:2211,9474:2214,9484:2210,9488:2539,9492:2541,9496:2538,9500:2548,9508:2549,9516:2551,9524:2550,9532:2542,9618:2529,9642:2791,9643:2785,9644:2779,9645:2786,9646:2783,9647:2767,9650:2792,9651:2787,9654:2781,9655:2765,9660:2793,9661:2788,9664:2780,9665:2764,9670:2528,9675:2766,9679:2782,9702:2784,9734:2789,9742:2809,9747:2762,9756:2794,9758:2795,9792:2808,9794:2807,9827:2796,9829:2798,9830:2797,9837:2806,9839:2805,10003:2803,10007:2804,10013:2777,10016:2800,10216:2748,10217:2750,12289:1188,12290:1185,12300:1186,12301:1187,12443:1246,12444:1247,12449:1191,12450:1201,12451:1192,12452:1202,12453:1193,12454:1203,12455:1194,12456:1204,12457:1195,12458:1205,12459:1206,12461:1207,12463:1208,12465:1209,12467:1210,12469:1211,12471:1212,12473:1213,12475:1214,12477:1215,12479:1216,12481:1217,12483:1199,12484:1218,12486:1219,12488:1220,12490:1221,12491:1222,12492:1223,12493:1224,12494:1225,12495:1226,12498:1227,12501:1228,12504:1229,12507:1230,12510:1231,12511:1232,12512:1233,12513:1234,12514:1235,12515:1196,12516:1236,12517:1197,12518:1237,12519:1198,12520:1238,12521:1239,12522:1240,12523:1241,12524:1242,12525:1243,12527:1244,12530:1190,12531:1245,12539:1189,12540:1200},Me={lookup(s){if(s>=32&&s<=255)return s;const e=js[s];return e!==void 0?e:16777216|s}},ei={8:"Backspace",9:"Tab",10:"NumpadClear",13:"Enter",16:"ShiftLeft",17:"ControlLeft",18:"AltLeft",19:"Pause",20:"CapsLock",21:"Lang1",25:"Lang2",27:"Escape",28:"Convert",29:"NonConvert",32:"Space",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown",41:"Select",44:"PrintScreen",45:"Insert",46:"Delete",47:"Help",48:"Digit0",49:"Digit1",50:"Digit2",51:"Digit3",52:"Digit4",53:"Digit5",54:"Digit6",55:"Digit7",56:"Digit8",57:"Digit9",91:"MetaLeft",92:"MetaRight",93:"ContextMenu",95:"Sleep",96:"Numpad0",97:"Numpad1",98:"Numpad2",99:"Numpad3",100:"Numpad4",101:"Numpad5",102:"Numpad6",103:"Numpad7",104:"Numpad8",105:"Numpad9",106:"NumpadMultiply",107:"NumpadAdd",108:"NumpadDecimal",109:"NumpadSubtract",110:"NumpadDecimal",111:"NumpadDivide",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",124:"F13",125:"F14",126:"F15",127:"F16",128:"F17",129:"F18",130:"F19",131:"F20",132:"F21",133:"F22",134:"F23",135:"F24",144:"NumLock",145:"ScrollLock",166:"BrowserBack",167:"BrowserForward",168:"BrowserRefresh",169:"BrowserStop",170:"BrowserSearch",171:"BrowserFavorites",172:"BrowserHome",173:"AudioVolumeMute",174:"AudioVolumeDown",175:"AudioVolumeUp",176:"MediaTrackNext",177:"MediaTrackPrevious",178:"MediaStop",179:"MediaPlayPause",180:"LaunchMail",181:"MediaSelect",182:"LaunchApp1",183:"LaunchApp2",225:"AltRight"},ti={Backspace:"Backspace",AltLeft:"Alt",AltRight:"Alt",CapsLock:"CapsLock",ContextMenu:"ContextMenu",ControlLeft:"Control",ControlRight:"Control",Enter:"Enter",MetaLeft:"Meta",MetaRight:"Meta",ShiftLeft:"Shift",ShiftRight:"Shift",Tab:"Tab",Delete:"Delete",End:"End",Help:"Help",Home:"Home",Insert:"Insert",PageDown:"PageDown",PageUp:"PageUp",ArrowDown:"ArrowDown",ArrowLeft:"ArrowLeft",ArrowRight:"ArrowRight",ArrowUp:"ArrowUp",NumLock:"NumLock",NumpadBackspace:"Backspace",NumpadClear:"Clear",Escape:"Escape",F1:"F1",F2:"F2",F3:"F3",F4:"F4",F5:"F5",F6:"F6",F7:"F7",F8:"F8",F9:"F9",F10:"F10",F11:"F11",F12:"F12",F13:"F13",F14:"F14",F15:"F15",F16:"F16",F17:"F17",F18:"F18",F19:"F19",F20:"F20",F21:"F21",F22:"F22",F23:"F23",F24:"F24",F25:"F25",F26:"F26",F27:"F27",F28:"F28",F29:"F29",F30:"F30",F31:"F31",F32:"F32",F33:"F33",F34:"F34",F35:"F35",PrintScreen:"PrintScreen",ScrollLock:"ScrollLock",Pause:"Pause",BrowserBack:"BrowserBack",BrowserFavorites:"BrowserFavorites",BrowserForward:"BrowserForward",BrowserHome:"BrowserHome",BrowserRefresh:"BrowserRefresh",BrowserSearch:"BrowserSearch",BrowserStop:"BrowserStop",Eject:"Eject",LaunchApp1:"LaunchMyComputer",LaunchApp2:"LaunchCalendar",LaunchMail:"LaunchMail",MediaPlayPause:"MediaPlay",MediaStop:"MediaStop",MediaTrackNext:"MediaTrackNext",MediaTrackPrevious:"MediaTrackPrevious",Power:"Power",Sleep:"Sleep",AudioVolumeDown:"AudioVolumeDown",AudioVolumeMute:"AudioVolumeMute",AudioVolumeUp:"AudioVolumeUp",WakeUp:"WakeUp"},ce={};function v(s,e){if(e===void 0)throw new Error('Undefined keysym for key "'+s+'"');if(s in ce)throw new Error('Duplicate entry for key "'+s+'"');ce[s]=[e,e,e,e]}function gt(s,e,t){if(e===void 0)throw new Error('Undefined keysym for key "'+s+'"');if(t===void 0)throw new Error('Undefined keysym for key "'+s+'"');if(s in ce)throw new Error('Duplicate entry for key "'+s+'"');ce[s]=[e,e,t,e]}function U(s,e,t){if(e===void 0)throw new Error('Undefined keysym for key "'+s+'"');if(t===void 0)throw new Error('Undefined keysym for key "'+s+'"');if(s in ce)throw new Error('Duplicate entry for key "'+s+'"');ce[s]=[e,e,e,t]}gt("Alt",_.XK_Alt_L,_.XK_Alt_R);v("AltGraph",_.XK_ISO_Level3_Shift);v("CapsLock",_.XK_Caps_Lock);gt("Control",_.XK_Control_L,_.XK_Control_R);gt("Meta",_.XK_Super_L,_.XK_Super_R);v("NumLock",_.XK_Num_Lock);v("ScrollLock",_.XK_Scroll_Lock);gt("Shift",_.XK_Shift_L,_.XK_Shift_R);U("Enter",_.XK_Return,_.XK_KP_Enter);v("Tab",_.XK_Tab);U(" ",_.XK_space,_.XK_KP_Space);U("ArrowDown",_.XK_Down,_.XK_KP_Down);U("ArrowLeft",_.XK_Left,_.XK_KP_Left);U("ArrowRight",_.XK_Right,_.XK_KP_Right);U("ArrowUp",_.XK_Up,_.XK_KP_Up);U("End",_.XK_End,_.XK_KP_End);U("Home",_.XK_Home,_.XK_KP_Home);U("PageDown",_.XK_Next,_.XK_KP_Next);U("PageUp",_.XK_Prior,_.XK_KP_Prior);v("Backspace",_.XK_BackSpace);U("Clear",_.XK_Clear,_.XK_KP_Begin);v("Copy",_.XF86XK_Copy);v("Cut",_.XF86XK_Cut);U("Delete",_.XK_Delete,_.XK_KP_Delete);U("Insert",_.XK_Insert,_.XK_KP_Insert);v("Paste",_.XF86XK_Paste);v("Redo",_.XK_Redo);v("Undo",_.XK_Undo);v("Cancel",_.XK_Cancel);v("ContextMenu",_.XK_Menu);v("Escape",_.XK_Escape);v("Execute",_.XK_Execute);v("Find",_.XK_Find);v("Help",_.XK_Help);v("Pause",_.XK_Pause);v("Select",_.XK_Select);v("ZoomIn",_.XF86XK_ZoomIn);v("ZoomOut",_.XF86XK_ZoomOut);v("BrightnessDown",_.XF86XK_MonBrightnessDown);v("BrightnessUp",_.XF86XK_MonBrightnessUp);v("Eject",_.XF86XK_Eject);v("LogOff",_.XF86XK_LogOff);v("Power",_.XF86XK_PowerOff);v("PowerOff",_.XF86XK_PowerDown);v("PrintScreen",_.XK_Print);v("Hibernate",_.XF86XK_Hibernate);v("Standby",_.XF86XK_Standby);v("WakeUp",_.XF86XK_WakeUp);v("AllCandidates",_.XK_MultipleCandidate);v("Alphanumeric",_.XK_Eisu_toggle);v("CodeInput",_.XK_Codeinput);v("Compose",_.XK_Multi_key);v("Convert",_.XK_Henkan);v("GroupFirst",_.XK_ISO_First_Group);v("GroupLast",_.XK_ISO_Last_Group);v("GroupNext",_.XK_ISO_Next_Group);v("GroupPrevious",_.XK_ISO_Prev_Group);v("NonConvert",_.XK_Muhenkan);v("PreviousCandidate",_.XK_PreviousCandidate);v("SingleCandidate",_.XK_SingleCandidate);v("HangulMode",_.XK_Hangul);v("HanjaMode",_.XK_Hangul_Hanja);v("JunjaMode",_.XK_Hangul_Jeonja);v("Eisu",_.XK_Eisu_toggle);v("Hankaku",_.XK_Hankaku);v("Hiragana",_.XK_Hiragana);v("HiraganaKatakana",_.XK_Hiragana_Katakana);v("KanaMode",_.XK_Kana_Shift);v("KanjiMode",_.XK_Kanji);v("Katakana",_.XK_Katakana);v("Romaji",_.XK_Romaji);v("Zenkaku",_.XK_Zenkaku);v("ZenkakuHankaku",_.XK_Zenkaku_Hankaku);v("F1",_.XK_F1);v("F2",_.XK_F2);v("F3",_.XK_F3);v("F4",_.XK_F4);v("F5",_.XK_F5);v("F6",_.XK_F6);v("F7",_.XK_F7);v("F8",_.XK_F8);v("F9",_.XK_F9);v("F10",_.XK_F10);v("F11",_.XK_F11);v("F12",_.XK_F12);v("F13",_.XK_F13);v("F14",_.XK_F14);v("F15",_.XK_F15);v("F16",_.XK_F16);v("F17",_.XK_F17);v("F18",_.XK_F18);v("F19",_.XK_F19);v("F20",_.XK_F20);v("F21",_.XK_F21);v("F22",_.XK_F22);v("F23",_.XK_F23);v("F24",_.XK_F24);v("F25",_.XK_F25);v("F26",_.XK_F26);v("F27",_.XK_F27);v("F28",_.XK_F28);v("F29",_.XK_F29);v("F30",_.XK_F30);v("F31",_.XK_F31);v("F32",_.XK_F32);v("F33",_.XK_F33);v("F34",_.XK_F34);v("F35",_.XK_F35);v("Close",_.XF86XK_Close);v("MailForward",_.XF86XK_MailForward);v("MailReply",_.XF86XK_Reply);v("MailSend",_.XF86XK_Send);v("MediaFastForward",_.XF86XK_AudioForward);v("MediaPause",_.XF86XK_AudioPause);v("MediaPlay",_.XF86XK_AudioPlay);v("MediaRecord",_.XF86XK_AudioRecord);v("MediaRewind",_.XF86XK_AudioRewind);v("MediaStop",_.XF86XK_AudioStop);v("MediaTrackNext",_.XF86XK_AudioNext);v("MediaTrackPrevious",_.XF86XK_AudioPrev);v("New",_.XF86XK_New);v("Open",_.XF86XK_Open);v("Print",_.XK_Print);v("Save",_.XF86XK_Save);v("SpellCheck",_.XF86XK_Spell);v("AudioVolumeDown",_.XF86XK_AudioLowerVolume);v("AudioVolumeUp",_.XF86XK_AudioRaiseVolume);v("AudioVolumeMute",_.XF86XK_AudioMute);v("MicrophoneVolumeMute",_.XF86XK_AudioMicMute);v("LaunchApplication1",_.XF86XK_MyComputer);v("LaunchApplication2",_.XF86XK_Calculator);v("LaunchCalendar",_.XF86XK_Calendar);v("LaunchMail",_.XF86XK_Mail);v("LaunchMediaPlayer",_.XF86XK_AudioMedia);v("LaunchMusicPlayer",_.XF86XK_Music);v("LaunchPhone",_.XF86XK_Phone);v("LaunchScreenSaver",_.XF86XK_ScreenSaver);v("LaunchSpreadsheet",_.XF86XK_Excel);v("LaunchWebBrowser",_.XF86XK_WWW);v("LaunchWebCam",_.XF86XK_WebCam);v("LaunchWordProcessor",_.XF86XK_Word);v("BrowserBack",_.XF86XK_Back);v("BrowserFavorites",_.XF86XK_Favorites);v("BrowserForward",_.XF86XK_Forward);v("BrowserHome",_.XF86XK_HomePage);v("BrowserRefresh",_.XF86XK_Refresh);v("BrowserSearch",_.XF86XK_Search);v("BrowserStop",_.XF86XK_Stop);v("Dimmer",_.XF86XK_BrightnessAdjust);v("MediaAudioTrack",_.XF86XK_AudioCycleTrack);v("RandomToggle",_.XF86XK_AudioRandomPlay);v("SplitScreenToggle",_.XF86XK_SplitScreen);v("Subtitle",_.XF86XK_Subtitle);v("VideoModeNext",_.XF86XK_Next_VMode);U("=",_.XK_equal,_.XK_KP_Equal);U("+",_.XK_plus,_.XK_KP_Add);U("-",_.XK_minus,_.XK_KP_Subtract);U("*",_.XK_asterisk,_.XK_KP_Multiply);U("/",_.XK_slash,_.XK_KP_Divide);U(".",_.XK_period,_.XK_KP_Decimal);U(",",_.XK_comma,_.XK_KP_Separator);U("0",_.XK_0,_.XK_KP_0);U("1",_.XK_1,_.XK_KP_1);U("2",_.XK_2,_.XK_KP_2);U("3",_.XK_3,_.XK_KP_3);U("4",_.XK_4,_.XK_KP_4);U("5",_.XK_5,_.XK_KP_5);U("6",_.XK_6,_.XK_KP_6);U("7",_.XK_7,_.XK_KP_7);U("8",_.XK_8,_.XK_KP_8);U("9",_.XK_9,_.XK_KP_9);function Te(s){if(s.code){switch(s.code){case"OSLeft":return"MetaLeft";case"OSRight":return"MetaRight"}return s.code}if(s.keyCode in ei){let e=ei[s.keyCode];if(ue()&&e==="ContextMenu"&&(e="MetaRight"),s.location===2)switch(e){case"ShiftLeft":return"ShiftRight";case"ControlLeft":return"ControlRight";case"AltLeft":return"AltRight"}if(s.location===3)switch(e){case"Delete":return"NumpadDecimal";case"Insert":return"Numpad0";case"End":return"Numpad1";case"ArrowDown":return"Numpad2";case"PageDown":return"Numpad3";case"ArrowLeft":return"Numpad4";case"ArrowRight":return"Numpad6";case"Home":return"Numpad7";case"ArrowUp":return"Numpad8";case"PageUp":return"Numpad9";case"Enter":return"NumpadEnter"}return e}return"Unidentified"}function Zs(s){if(s.key!==void 0&&s.key!=="Unidentified"){switch(s.key){case"OS":return"Meta";case"LaunchMyComputer":return"LaunchApplication1";case"LaunchCalculator":return"LaunchApplication2"}switch(s.key){case"UIKeyInputUpArrow":return"ArrowUp";case"UIKeyInputDownArrow":return"ArrowDown";case"UIKeyInputLeftArrow":return"ArrowLeft";case"UIKeyInputRightArrow":return"ArrowRight";case"UIKeyInputEscape":return"Escape"}return s.key==="\0"&&s.code==="NumpadDecimal"?"Delete":s.key}const e=Te(s);return e in ti?ti[e]:s.charCode?String.fromCharCode(s.charCode):"Unidentified"}function $s(s){const e=Zs(s);if(e==="Unidentified")return null;if(e in ce){let i=s.location;if(e==="Meta"&&i===0&&(i=2),e==="Clear"&&i===3&&Te(s)==="NumLock"&&(i=0),(i===void 0||i>3)&&(i=0),e==="Meta"){let n=Te(s);if(n==="AltLeft")return _.XK_Meta_L;if(n==="AltRight")return _.XK_Meta_R}if(e==="Clear"&&Te(s)==="NumLock")return _.XK_Num_Lock;if(at())switch(e){case"Zenkaku":case"Hankaku":return _.XK_Zenkaku_Hankaku;case"Romaji":case"KanaMode":return _.XK_Romaji}return ce[e][i]}if(e.length!==1)return null;const t=e.charCodeAt();return t?Me.lookup(t):null}const qs={48:"Digit0",49:"Digit1",50:"Digit2",51:"Digit3",52:"Digit4",53:"Digit5",54:"Digit6",55:"Digit7",56:"Digit8",57:"Digit9",96:"Numpad0",97:"Numpad1",98:"Numpad2",99:"Numpad3",100:"Numpad4",101:"Numpad5",102:"Numpad6",103:"Numpad7",104:"Numpad8",105:"Numpad9"};class Js{constructor(e,t){this._screenInput=e,this._touchInput=t,this._keyDownList={},this._altGrArmed=!1,this._eventHandlers={keyup:this._handleKeyUp.bind(this),keydown:this._handleKeyDown.bind(this),blur:this._allKeysUp.bind(this),compositionstart:this._handleCompositionStart.bind(this),compositionend:this._handleCompositionEnd.bind(this),input:this._handleInput.bind(this)},this.onkeyevent=()=>{},this._enableIME=!1,this._imeHold=!1,this._imeInProgress=!1,this._lastKeyboardInput=null,this._defaultKeyboardInputLen=100,this._keyboardInputReset(),this._translateShortcuts=!0}get enableIME(){return this._enableIME}set enableIME(e){this._enableIME=e,this.focus()}get translateShortcuts(){return this._translateShortcuts}set translateShortcuts(e){this._translateShortcuts=e}clearKeysDown(e){if(e)for(const[t,i]of Object.entries(this._keyDownList))switch(t){case"ControlLeft":case"ControlRight":e.ctrlKey||(A("A control key is stuck down, sending up."),this._sendKeyEvent(i,t,!1));break;case"MetaLeft":case"MetaRight":e.metaKey||(A("A meta key is stuck down, sending up."),this._sendKeyEvent(i,t,!1));break;case"AltLeft":case"AltRight":e.altKey||(A("A alt key is stuck down, sending up. "),this._sendKeyEvent(i,t,!1));break;case"ShiftRight":case"ShiftLeft":e.shiftKey||(A("A shift key is stuck down, sending up."),this._sendKeyEvent(i,t,!1));break}}_sendKeyEvent(e,t,i){if(i)this._keyDownList[t]=e;else{if(!(t in this._keyDownList))return;delete this._keyDownList[t]}C("onkeyevent "+(i?"down":"up")+", keysym: "+e,", code: "+t),this.onkeyevent(e,t,i)}_getKeyCode(e){const t=Te(e);if(t!=="Unidentified")return t;if(e.keyCode&&e.keyCode!==229)return"Platform"+e.keyCode;if(e.keyIdentifier){if(e.keyIdentifier.substr(0,2)!=="U+")return e.keyIdentifier;const i=parseInt(e.keyIdentifier.substr(2),16);return"Platform"+String.fromCharCode(i).toUpperCase().charCodeAt()}return"Unidentified"}_handleCompositionStart(e){C("composition started"),this._enableIME&&(this._imeHold=!0,this._imeInProgress=!0)}_handleCompositionEnd(e){C("Composition ended"),this._enableIME&&(this._imeInProgress=!1),Ws()&&(this._imeHold=!1)}_handleInput(e){if(this._enableIME&&this._imeHold){C("IME input change, sending differential"),this._imeInProgress||(this._imeHold=!1);const t=this._lastKeyboardInput,i=e.target.value;let n=0;for(let r=0;r<Math.min(t.length,i.length)&&i.charAt(r)==t.charAt(r);r++)n++;for(let r=t.length-n;r>0;r--)this._sendKeyEvent(_.XK_BackSpace,"Backspace",!0),this._sendKeyEvent(_.XK_BackSpace,"Backspace",!1);for(let r=n;r<i.length;r++)this._sendKeyEvent(Me.lookup(i.charCodeAt(r)),"Unidentified",!0),this._sendKeyEvent(Me.lookup(i.charCodeAt(r)),"Unidentified",!1);this._lastKeyboardInput=i}else{C("Non-IME input change, sending new characters");const t=e.target.value;this._lastKeyboardInput||this._keyboardInputReset();const i=this._lastKeyboardInput;let n;try{n=Math.max(e.target.selectionStart,t.length)}catch{n=t.length}const r=i.length;let a=n-r,h=a<0?-a:0;for(let l=0;l<Math.min(r,n);l++)if(t.charAt(l)!=i.charAt(l)){a=n-l,h=r-l;break}for(let l=0;l<h;l++)this._sendKeyEvent(_.XK_BackSpace,"Backspace",!0),this._sendKeyEvent(_.XK_BackSpace,"Backspace",!1);for(let l=n-a;l<n;l++)this._sendKeyEvent(Me.lookup(t.charCodeAt(l)),"Unidentified",!0),this._sendKeyEvent(Me.lookup(t.charCodeAt(l)),"Unidentified",!1);n>2*this._defaultKeyboardInputLen?this._keyboardInputReset():n<1?(this._keyboardInputReset(),e.target.blur(),setTimeout(e.target.focus.bind(e.target),0)):this._lastKeyboardInput=t}}_keyboardInputReset(){this._touchInput.value=new Array(this._defaultKeyboardInputLen).join("_"),this._lastKeyboardInput=this._touchInput.value}_handleKeyDown(e){const t=this._getKeyCode(e);let i=$s(e);if(this.clearKeysDown(e),this._isIMEInteraction(e)){C("Skipping keydown, IME interaction, code: "+t+" keysym: "+i+" keycode: "+e.keyCode);return}if(this._altGrArmed&&(this._altGrArmed=!1,clearTimeout(this._altGrTimeout),t==="AltRight"&&e.timeStamp-this._altGrCtrlTime<50?i=_.XK_ISO_Level3_Shift:this._sendKeyEvent(_.XK_Control_L,"ControlLeft",!0)),t==="Unidentified"){i&&(this._sendKeyEvent(i,t,!0),this._sendKeyEvent(i,t,!1)),ge(e);return}if(ue()&&this._translateShortcuts&&t!=="MetaLeft"&&t!=="MetaRight"&&e.metaKey&&!e.ctrlKey&&!e.altKey){this._sendKeyEvent(this._keyDownList.MetaLeft,"MetaLeft",!1),this._sendKeyEvent(this._keyDownList.MetaRight,"MetaRight",!1),this._sendKeyEvent(_.XK_Control_L,"ControlLeft",!0),this._sendKeyEvent(i,t,!0),ge(e);return}if(ue()||Ce())switch(i){case _.XK_Super_L:i=_.XK_Alt_L;break;case _.XK_Super_R:i=_.XK_Super_L;break;case _.XK_Alt_L:i=_.XK_Mode_switch;break;case _.XK_Alt_R:i=_.XK_ISO_Level3_Shift;break}if(t in this._keyDownList&&(i=this._keyDownList[t]),(ue()||Ce())&&t==="CapsLock"){this._sendKeyEvent(_.XK_Caps_Lock,"CapsLock",!0),this._sendKeyEvent(_.XK_Caps_Lock,"CapsLock",!1),ge(e);return}const n=[_.XK_Zenkaku_Hankaku,_.XK_Eisu_toggle,_.XK_Katakana,_.XK_Hiragana,_.XK_Romaji];if(at()&&n.includes(i)){this._sendKeyEvent(i,t,!0),this._sendKeyEvent(i,t,!1),ge(e);return}if(ge(e),t==="ControlLeft"&&at()&&!("ControlLeft"in this._keyDownList)){this._altGrArmed=!0,this._altGrTimeout=setTimeout(this._handleAltGrTimeout.bind(this),100),this._altGrCtrlTime=e.timeStamp;return}this._sendKeyEvent(i,t,!0)}_handleKeyUp(e){const t=this._getKeyCode(e);if(this._isIMEInteraction(e)){C("Skipping keyup, IME interaction, code: "+t+" keycode: "+e.keyCode);return}if(ge(e),this._altGrArmed&&(this._altGrArmed=!1,clearTimeout(this._altGrTimeout),this._sendKeyEvent(_.XK_Control_L,"ControlLeft",!0)),(ue()||Ce())&&t==="CapsLock"){this._sendKeyEvent(_.XK_Caps_Lock,"CapsLock",!0),this._sendKeyEvent(_.XK_Caps_Lock,"CapsLock",!1);return}this._sendKeyEvent(this._keyDownList[t],t,!1),at()&&(t==="ShiftLeft"||t==="ShiftRight")&&("ShiftRight"in this._keyDownList&&this._sendKeyEvent(this._keyDownList.ShiftRight,"ShiftRight",!1),"ShiftLeft"in this._keyDownList&&this._sendKeyEvent(this._keyDownList.ShiftLeft,"ShiftLeft",!1))}_handleAltGrTimeout(){this._altGrArmed=!1,clearTimeout(this._altGrTimeout),this._sendKeyEvent(_.XK_Control_L,"ControlLeft",!0)}_allKeysUp(){C(">> Keyboard.allKeysUp");for(let e in this._keyDownList)this._sendKeyEvent(this._keyDownList[e],e,!1);C("<< Keyboard.allKeysUp")}_isIMEInteraction(e){return e.target!=this._touchInput||!this._enableIME?!1:e.keyCode==229||e.keyCode in qs}focus(){this._enableIME?this._touchInput.focus():this._screenInput.focus()}blur(){this._enableIME?this._touchInput.blur():this._screenInput.blur()}grab(){this._screenInput.addEventListener("keydown",this._eventHandlers.keydown),this._screenInput.addEventListener("keyup",this._eventHandlers.keyup),this._touchInput.addEventListener("keydown",this._eventHandlers.keydown),this._touchInput.addEventListener("keyup",this._eventHandlers.keyup),this._touchInput.addEventListener("compositionstart",this._eventHandlers.compositionstart),this._touchInput.addEventListener("compositionend",this._eventHandlers.compositionend),this._touchInput.addEventListener("input",this._eventHandlers.input),window.addEventListener("blur",this._eventHandlers.blur)}ungrab(){this._screenInput.removeEventListener("keydown",this._eventHandlers.keydown),this._screenInput.removeEventListener("keyup",this._eventHandlers.keyup),this._touchInput.removeEventListener("keydown",this._eventHandlers.keydown),this._touchInput.removeEventListener("keyup",this._eventHandlers.keyup),this._touchInput.removeEventListener("compositionstart",this._eventHandlers.compositionstart),this._touchInput.removeEventListener("compositionend",this._eventHandlers.compositionend),this._touchInput.removeEventListener("input",this._eventHandlers.input),window.removeEventListener("blur",this._eventHandlers.blur),this._allKeysUp()}}function en(s){return s>>>0}function Re(s){return s|0}function ii(s){var e=32768,t=1<<31,i=16384,n=s|0;return(s&t)!=0&&(n*=-1,n|=e),n|=i,n}function Ae(s){typeof s=="string"&&(s=[...s].map(t=>t.charCodeAt(0)));let e=0;for(let t=0;t<s.length;t++)e=Math.imul(31,e)+s[t]|0;return e}function yt(s,e=!1){try{return decodeURIComponent(escape(s))}catch(t){if(t instanceof URIError&&e)return s;throw t}}function Ht(s){return unescape(encodeURIComponent(s))}function tn(){return("10000000-1000-4000-8000"+-1e11).replace(/[018]/g,s=>(s^crypto.getRandomValues(new Uint8Array(1))[0]&15>>s/4).toString(16))}function Xe(s,e,t){const i=t.getBoundingClientRect();let n={x:0,y:0};return s<i.left?n.x=0:s>=i.right?n.x=i.width-1:n.x=s-i.left,e<i.top?n.y=0:e>=i.bottom?n.y=i.height-1:n.y=e-i.top,s>window.innerWidth?n.x+=s-window.innerWidth:s<0&&(n.x=s+i.left),e>window.innerHeight?n.y+=e-window.innerHeight:e<0&&(n.y=e+i.top),n}class sn{constructor(){this._listeners=new Map}addEventListener(e,t){this._listeners.has(e)||this._listeners.set(e,new Set),this._listeners.get(e).add(t)}removeEventListener(e,t){this._listeners.has(e)&&this._listeners.get(e).delete(t)}dispatchEvent(e){return this._listeners.has(e.type)?(this._listeners.get(e.type).forEach(t=>t.call(this,e)),!e.defaultPrevented):!0}}const nn="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",je=Object.fromEntries(Array.from(nn).map((s,e)=>[e,s.charCodeAt(0)])),rn=new TextDecoder,si={base64Pad:"=",encode(s){let e=s.length,t=e%3,i=Math.floor(e/3)*4+(t&&t+1),n=Math.ceil(e/3)*4,r=new Uint8Array(n);for(let h=0,l=0;l<e;h+=4,l+=3){let o=(s[l]<<16)+(s[l+1]<<8)+(s[l+2]|0);r[h]=je[o>>18],r[h+1]=je[o>>12&63],r[h+2]=je[o>>6&63],r[h+3]=je[o&63]}let a=rn.decode(new Uint8Array(r.buffer,0,i));return t===1&&(a+="=="),t===2&&(a+="="),a},toBinaryTable:[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,62,-1,-1,-1,63,52,53,54,55,56,57,58,59,60,61,-1,-1,-1,0,-1,-1,-1,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,-1,-1,-1,-1,-1,-1,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,-1,-1,-1,-1,-1],decode(s,e=0){let t=s.indexOf("=")-e;t<0&&(t=s.length-e);const i=(t>>2)*3+Math.floor(t%4/1.5),n=new Uint8Array(i);let r=0,a=0;for(let h=0,l=e;l<s.length;l++){const o=this.toBinaryTable[s.charCodeAt(l)&127],c=s.charAt(l)===this.base64Pad;if(o===-1){A("Illegal character code "+s.charCodeAt(l)+" at position "+l);continue}a=a<<6|o,r+=6,r>=8&&(r-=8,c||(n[h++]=a>>r&255),a&=(1<<r)-1)}if(r){const h=new Error("Corrupted base64 string");throw h.name="Base64-Error",h}return n}};class an{constructor(e,t){if(C(">> Display.constructor"),this._asyncFrameQueue=[],this._maxAsyncFrameQueue=3,this._clearAsyncQueue(),this._syncFrameQueue=[],this._transparentOverlayImg=null,this._transparentOverlayRect=null,this._lastTransparentRectId="",this._flushing=!1,this._fbWidth=0,this._fbHeight=0,this._renderMs=0,this._prevDrawStyle="",this._target=e,!this._target)throw new Error("Target must be set");if(typeof this._target=="string")throw new Error("target must be a DOM element");if(!this._target.getContext)throw new Error("no getContext method");this._targetCtx=this._target.getContext("2d"),C("User Agent: "+navigator.userAgent),this._flipCnt=0,this._lastFlip=Date.now(),this._droppedFrames=0,this._droppedRects=0,this._forcedFrameCnt=0,this._missingFlipRect=0,this._lateFlipRect=0,this._frameStatsInterval=setInterval((function(){let i=Date.now()-this._lastFlip;i>0&&(this._fps=(this._flipCnt/(i/1e3)).toFixed(2)),C("Dropped Frames: "+this._droppedFrames+" Dropped Rects: "+this._droppedRects+" Forced Frames: "+this._forcedFrameCnt+" Missing Flips: "+this._missingFlipRect+" Late Flips: "+this._lateFlipRect),this._flipCnt=0,this._lastFlip=Date.now()}).bind(this),5e3),this._maxScreens=4,this._scale=1,this._clipViewport=!1,this._antiAliasing=0,this._fps=0,this._isPrimaryDisplay=t,this._screenID=tn(),this._screens=[{screenID:this._screenID,screenIndex:0,width:this._target.width,height:this._target.height,serverWidth:0,serverHeight:0,serverReportedWidth:0,serverReportedHeight:0,x:0,y:0,scale:1,relativePosition:0,relativePositionX:0,relativePositionY:0,pixelRatio:window.devicePixelRatio,containerHeight:this._target.parentNode.offsetHeight,containerWidth:this._target.parentNode.offsetWidth,channel:null,x2:0,y2:0}],this._enableCanvasBuffer=!1,this._backbuffer=document.createElement("canvas"),this._drawCtx=this._backbuffer.getContext("2d"),this._damageBounds={left:0,top:0,right:this._backbuffer.width,bottom:this._backbuffer.height},this.onflush=()=>{},this._isPrimaryDisplay||(this._screens[0].channel=new BroadcastChannel(`screen_${this._screenID}_channel`),this._screens[0].channel.addEventListener("message",this._handleSecondaryDisplayMessage.bind(this))),C("<< Display.constructor")}get enableCanvasBuffer(){return this._enableCanvasBuffer}set enableCanvasBuffer(e){if(e!==this._enableCanvasBuffer){if(this._enableCanvasBuffer=e,e&&this._target){let t=this._targetCtx.getImageData(0,0,this._target.width,this._target.height);this._drawCtx.putImageData(t,0,0),this._transparentOverlayImg&&this.drawImage(this._transparentOverlayImg,this._transparentOverlayRect.x,this._transparentOverlayRect.y,this._transparentOverlayRect.width,this._transparentOverlayRect.height,!0)}else if(!e&&this._target){let t=this._targetCtx.getImageData(0,0,this._target.width,this._target.height);this._drawCtx.putImageData(t,0,0)}}}get screens(){return this._screens}get screenID(){return this._screenID}get screenIndex(){return!this._isPrimaryDisplay&&this._screens[0].screenIndex==0?-1:this._screens[0].screenIndex}get antiAliasing(){return this._antiAliasing}set antiAliasing(e){this._antiAliasing=e,this._rescale(this._scale)}get scale(){return this._scale}set scale(e){this._rescale(e)}get clipViewport(){return this._clipViewport}set clipViewport(e){this._clipViewport=e;const t=this._screens[0];this.viewportChangeSize(t.width,t.height),this.viewportChangePos(0,0)}get width(){return this._fbWidth}get height(){return this._fbHeight}get renderMs(){return this._renderMs}set renderMs(e){this._renderMs=e}get fps(){return this._fps}getClientRelativeCoordinates(e,t){for(let i=0;i<this._screens.length;i++)if(e>=this._screens[i].x&&e<=this._screens[i].x+this._screens[i].serverWidth&&t>=this._screens[i].y&&t<=this._screens[i].y+this._screens[i].serverHeight)return{screenIndex:i,x:e-this._screens[i].x,y:t-this._screens[i].y}}getServerRelativeCoordinates(e,t,i){return e>=0&&e<this._screens.length&&(t=Re(t/this._screens[e].scale+this._screens[e].x),i=Re(i/this._screens[e].scale+this._screens[e].y)),[t,i]}getScreenSize(e,t,i,n,r,a){let h={screens:null,serverWidth:0,serverHeight:0},l=0;this._screens[l].containerHeight=this._target.parentNode.offsetHeight,this._screens[l].containerWidth=this._target.parentNode.offsetWidth,this._screens[l].pixelRatio=window.devicePixelRatio,this._screens[l].width=this._target.parentNode.offsetWidth,this._screens[l].height=this._target.parentNode.offsetHeight;let o=t||this._screens[l].containerWidth,c=i||this._screens[l].containerHeight;if(this._screens[l].serverReportedWidth>0&&this._screens[l].serverReportedHeight>0&&(a||this._screens[l].serverReportedWidth!==this._screens[l].serverWidth||this._screens[l].serverReportedHeight!==this._screens[l].serverHeight)&&!t&&!i)c=this._screens[l].serverReportedHeight,o=this._screens[l].serverReportedWidth;else if(o>1280&&!r&&e==1)c=Math.floor(1280*(c/o)),o=1280;else if(e==0&&!r)o=1280,c=720;else if(n)o=Math.floor(o*this._screens[l].pixelRatio),c=Math.floor(c*this._screens[l].pixelRatio),1/this._screens[l].pixelRatio;else if(this._antiAliasing===0&&this._screens[l].pixelRatio>1&&o<1e3&o>0){I("Device Pixel ratio: "+this._screens[l].pixelRatio+" Reported Resolution: "+o+"x"+c);let f=1.5;this._screens[l].pixelRatio>2&&(f=2);let F=o*this._screens[l].pixelRatio*(1/f)/o;o=o*F,c=c*F,I("Small device with hDPI screen detected, auto scaling at "+F+" to "+o+"x"+c)}let u=this._screens[l].containerHeight/c,x=this._screens[l].containerWidth/o;for(this._screens[l].height=Math.floor(c*u),this._screens[l].width=Math.floor(o*x),this._screens[l].serverWidth=o,this._screens[l].serverHeight=c,this._screens[l].scale=Math.min(u,x),l=0;l<this._screens.length;l++)this._screens[l].x2=this._screens[l].x+this._screens[l].serverWidth,this._screens[l].y2=this._screens[l].y+this._screens[l].serverHeight,h.serverWidth=Math.max(h.serverWidth,this._screens[l].x+this._screens[l].serverWidth),h.serverHeight=Math.max(h.serverHeight,this._screens[l].y+this._screens[l].serverHeight);return h.screens=this._screens,h}applyServerResolution(e,t,i){for(let n=0;n<this._screens.length;n++)i===this._screens[n].screenIndex&&(this._screens[n].serverReportedWidth=e,this._screens[n].serverReportedHeight=t)}applyScreenPlan(e){let t=!1;for(let i=0;i<e.screens.length;i++)for(let n=0;n<this._screens.length;n++)e.screens[i].screenID===this._screens[n].screenID&&((this._screens[n].x!==e.screens[i].x||this._screens[n].y!==e.screens[i].y)&&(n==0&&(this._screens[n].x=e.screens[i].x,this._screens[n].y=e.screens[i].y),t=!0),(this._screens[n].x2!==this._screens[n].x+this._screens[n].serverWidth||this._screens[n].y2!==this._screens[n].y+this._screens[n].serverHeight)&&(n==0&&(this._screens[n].x2=this._screens[n].x+this._screens[n].serverWidth,this._screens[n].y2=this._screens[n].y+this._screens[n].serverHeight),t=!0));return t}addScreen(e,t,i,n,r,a,h,l,o,c,u){if(this._isPrimaryDisplay)(r===0||a===0||n===0)&&V("Invalid screen configuration.");else throw new Error("Cannot add a screen to a secondary display.");let x=-1;for(let p=0;p<this._screens.length;p++)this._screens[p].screenID===e&&(x=p);if(x>0){const p=this._screens[x];if(p.serverHeight!==o||p.serverWidth!==l||p.width!==t||p.height!==i||p.containerHeight!==r||p.containerWidth!==a||p.scale!==h||p.pixelRatio!==n||p.x!==c||p.y!==u)return p.width=t,p.height=i,p.containerHeight=r,p.containerWidth=a,p.pixelRatio=n,p.scale=h,p.serverWidth=l,p.serverHeight=o,p.x=c,p.y=u,p.x2=p.x+p.serverWidth,p.y2=p.y+p.serverHeight,!0}else{for(let p=0;p<this._screens.length;p++)c=Math.max(c,this._screens[p].x+this._screens[p].serverWidth);var f={screenID:e,screenIndex:this.screens.length,width:t,height:i,serverWidth:l,serverHeight:o,serverReportedWidth:0,serverReportedHeight:0,x:c,y:0,pixelRatio:n,containerHeight:r,containerWidth:a,channel:null,scale:h,x2:c+l,y2:o};return f.channel=new BroadcastChannel(`screen_${e}_channel`),this._screens.push(f),f.channel.postMessage({eventType:"registered",screenIndex:f.screenIndex}),f.screenIndex}return!1}removeScreen(e){let t=!1;if(this._isPrimaryDisplay){for(let i=1;i<this._screens.length;i++)if(this._screens[i].screenID==e){this._flushRectsScreen(i),this._screens[i].channel.close(),this._screens.splice(i,1),t=!0;break}for(let i=1;i<this._screens.length;i++)this.screens[i].screenIndex=i,i>0&&this._screens[i].channel.postMessage({eventType:"registered",screenIndex:i});return t}else throw new Error("Secondary screens only allowed on primary display.")}viewportChangePos(e,t){const i=this._screens[0];e=Math.floor(e),t=Math.floor(t),this._clipViewport||(e=-i.width,t=-i.height);const n=i.x+i.width-1,r=i.y+i.height-1;e<0&&i.x+e<0&&(e=-i.x),n+e>=this._fbWidth&&(e-=n+e-this._fbWidth+1),i.y+t<0&&(t=-i.y),r+t>=this._fbHeight&&(t-=r+t-this._fbHeight+1),!(e===0&&t===0)&&C("viewportChange deltaX: "+e+", deltaY: "+t)}viewportChangeSize(e,t){(!this._clipViewport&&this._screens.length===1||typeof e>"u"||typeof t>"u")&&(C("Setting viewport to full display region"),e=this._fbWidth,t=this._fbHeight),e=Math.floor(e),t=Math.floor(t),e>this._fbWidth&&(e=this._fbWidth),t>this._fbHeight&&(t=this._fbHeight);const i=this._screens[0],n=this._target;if(n.width!==e||n.height!==t){let r=null;n.width>0&&n.height>0&&(r=this._targetCtx.getImageData(0,0,n.width,n.height)),i.serverWidth=e,i.serverHeight=t,n.width=e,n.height=t,r&&this._targetCtx.putImageData(r,0,0),this.viewportChangePos(0,0),this._rescale(this._scale)}}absX(e){return this._scale===0?0:Re(e/this._scale+this._screens[0].x)}absY(e){return this._scale===0?0:Re(e/this._scale+this._screens[0].y)}resize(e,t){this._prevDrawStyle="",this._fbWidth=e,this._fbHeight=t;let i=this._backbuffer;if(i==null)return;if(this._screens.length>0&&(e=this._screens[0].serverWidth,t=this._screens[0].serverHeight),i.width!==e||i.height!==t){let r=null;i.width>0&&i.height>0&&(r=this._drawCtx.getImageData(0,0,i.width,i.height)),i.width!==e&&(i.width=e),i.height!==t&&(i.height=t),r&&this._drawCtx.putImageData(r,0,0)}const n=this._screens[0];this.viewportChangeSize(n.serverWidth,n.serverHeight),this.viewportChangePos(0,0)}flip(e,t){this._asyncRenderQPush({type:"flip",frame_id:e,rect_cnt:t,screenLocations:[{screenIndex:0,x:0,y:0}]})}pending(){return this._asyncFrameQueue[this._maxAsyncFrameQueue-1][0]>0}flush(e=!0){this._asyncFrameComplete(0,!0),e&&this.onflush()}clear(){this._clearAsyncQueue()}dispose(){clearInterval(this._frameStatsInterval),this.clear()}fillRect(e,t,i,n,r,a,h){if(h)this._setFillColor(r),this._enableCanvasBuffer?this._drawCtx.fillRect(e,t,i,n):this._targetCtx.fillRect(e,t,i,n);else{let l={type:"fill",x:e,y:t,width:i,height:n,color:r,frame_id:a};this._processRectScreens(l),this._asyncRenderQPush(l)}}copyImage(e,t,i,n,r,a,h,l){if(l){let o=this._enableCanvasBuffer?this._drawCtx:this._targetCtx,c=this._enableCanvasBuffer?this._backbuffer:this._target;o.mozImageSmoothingEnabled=!1,o.webkitImageSmoothingEnabled=!1,o.msImageSmoothingEnabled=!1,o.imageSmoothingEnabled=!1,o.drawImage(c,e,t,r,a,i,n,r,a)}else{let o={type:"copy",oldX:e,oldY:t,x:i,y:n,width:r,height:a,frame_id:h};this._processRectScreens(o),this._asyncRenderQPush(o)}}imageRect(e,t,i,n,r,a,h){if(i===0||n===0)return;let l={type:"img",img:null,x:e,y:t,width:i,height:n,frame_id:h};if(this._processRectScreens(l),l.inPrimary){const o=new Image;o.src="data: "+r+";base64,"+si.encode(a),l.img=o}else l.type="_img";l.inSecondary&&(l.mime=r,l.src="data: "+r+";base64,"+si.encode(a)),this._asyncRenderQPush(l)}transparentRect(e,t,i,n,r,a,h){if(!(i===0||n===0)){var l={type:"transparent",img:null,x:e,y:t,width:i,height:n,frame_id:a,arr:r,hash_id:h};this._processRectScreens(l),l.inPrimary&&createImageBitmap(r).then((function(c){this._transparentOverlayImg=c,this.enableCanvasBuffer=!0}).bind(this)),this._transparentOverlayRect=l,this._asyncRenderQPush(l)}}dummyRect(e,t,i,n,r){let a={type:"dummy",img:null,x:e,y:t,width:i,height:n,frame_id:r};this._processRectScreens(a),this._asyncRenderQPush(a)}blitImage(e,t,i,n,r,a,h,l){if(l){let o=new Uint8ClampedArray(r.buffer,r.byteOffset+a,i*n*4),c=new ImageData(o,i,n);this._enableCanvasBuffer?this._drawCtx.putImageData(c,e,t):this._targetCtx.putImageData(c,e,t)}else{const o=new Uint8Array(i*n*4);o.set(new Uint8Array(r.buffer,0,o.length));let c={type:"blit",data:o,x:e,y:t,width:i,height:n,frame_id:h};this._processRectScreens(c),this._asyncRenderQPush(c)}}blitQoi(e,t,i,n,r,a,h,l){if(l)this._enableCanvasBuffer?this._drawCtx.putImageData(r,e,t):this._targetCtx.putImageData(r,e,t);else{let o={type:"blitQ",data:r,x:e,y:t,width:i,height:n,frame_id:h};this._processRectScreens(o),this._asyncRenderQPush(o)}}drawImage(e,t,i,n,r,a=!1){try{let h=this._enableCanvasBuffer&&!a?this._drawCtx:this._targetCtx;e.width!=n||e.height!=r?h.drawImage(e,t,i,n,r):h.drawImage(e,t,i)}catch{A("Invalid image recieved.")}}autoscale(e,t,i=0){if(e===0||t===0)i=0;else if(i===0){const n=this._screens[0],r=e/t;n.width/n.height>=r?i=e/n.serverWidth:i=t/n.serverHeight}this._rescale(i)}_writeCtxBuffer(){this._backbuffer.width>0&&this._targetCtx.drawImage(this._backbuffer,0,0)}_handleSecondaryDisplayMessage(e){if(!this._isPrimaryDisplay&&e.data)switch(e.data.eventType){case"rect":let t=e.data.rect;switch(t.screenLocations=[t.screenLocations[e.data.screenLocationIndex]],t.screenLocations[0].screenIndex=0,t.type){case"img":case"_img":t.img=new Image,t.img.src=t.src,t.type="img";break;case"transparent":createImageBitmap(t.arr).then((function(n){this._transparentOverlayImg=n,this.enableCanvasBuffer||(this._enableCanvasBuffer=!0)}).bind(this)),this._transparentOverlayRect=t;break}this._syncFrameQueue.push(t),this._syncFrameQueue.length>5e3&&(this._syncFrameQueue.shift(),this._droppedRects++);break;case"frameComplete":window.requestAnimationFrame(()=>{this._pushSyncRects()});break;case"registered":this._isPrimaryDisplay||(this._screens[0].screenIndex=e.data.screenIndex,I(`Screen with index (${e.data.screenIndex}) successfully registered with the primary display.`),this._screens.length>0&&this.resize(this._screens[0].serverWidth,this._screens[0].serverHeight));break}}_pushSyncRects(){let e=0;e:for(;this._syncFrameQueue.length>0;){const t=this._syncFrameQueue[0],i=t.screenLocations[0];switch(t.type){case"copy":this.copyImage(i.oldX,i.oldY,i.x,i.y,t.width,t.height,t.frame_id,!0);break;case"fill":this.fillRect(i.x,i.y,t.width,t.height,t.color,t.frame_id,!0);break;case"blit":this.blitImage(i.x,i.y,t.width,t.height,t.data,0,t.frame_id,!0);break;case"blitQ":this.blitQoi(i.x,i.y,t.width,t.height,t.data,0,t.frame_id,!0);break;case"img":if(t.img.complete)this.drawImage(t.img,i.x,i.y,t.width,t.height);else if(this._syncFrameQueue.length>5e3)this._syncFrameQueue.shift(),this._droppedRects++;else break e;break;default:this._syncFrameQueue.shift();continue}e++,this._syncFrameQueue.shift()}this._enableCanvasBuffer&&e>0&&(this._writeCtxBuffer(),this._transparentOverlayImg&&this.drawImage(this._transparentOverlayImg,this._transparentOverlayRect.x,this._transparentOverlayRect.y,this._transparentOverlayRect.width,this._transparentOverlayRect.height,!0)),this._syncFrameQueue.length>0&&window.requestAnimationFrame(()=>{this._pushSyncRects()})}_flushRectsScreen(e){for(let t=0;t<this._asyncFrameQueue.length;t++){const i=this._asyncFrameQueue[t];for(let n=0;n<i[2].length;n++){const r=i[2][n];for(let a=0;a<r.screenLocations.length;a++)if(r.screenLocations[a].screenIndex===e){r.screenLocations.splice(a,1);break}}}}_asyncRenderQPush(e){let t=-1,i=Number.MAX_SAFE_INTEGER,n=0;for(let r=0;r<this._asyncFrameQueue.length;r++){if(e.frame_id==this._asyncFrameQueue[r][0]){this._asyncFrameQueue[r][2].push(e),t=r;break}else if(this._asyncFrameQueue[r][0]==0){let a=e.type=="flip"?e.rect_cnt:0;this._asyncFrameQueue[r][0]=e.frame_id,this._asyncFrameQueue[r][2].push(e),this._asyncFrameQueue[r][3]=a==1,t=r;break}i=Math.min(i,this._asyncFrameQueue[r][0]),n=Math.max(n,this._asyncFrameQueue[r][0])}if(this._firstRect||(this._firstRect=!0,I("First rect received.")),t>=0)e.type=="flip"&&(this._asyncFrameQueue[t][1]!==0&&V("Redundant flip rect, current rect_cnt: "+this._asyncFrameQueue[t][1]+", new rect_cnt: "+e.rect_cnt),this._asyncFrameQueue[t][1]+=e.rect_cnt,e.rect_cnt==0&&V("Invalid rect count")),this._asyncFrameQueue[t][1]>0&&this._asyncFrameQueue[t][2].length>=this._asyncFrameQueue[t][1]&&this._asyncFrameComplete(t);else if(e.frame_id<i){this._droppedRects++,e.type=="flip"&&this._lateFlipRect++;return}else if(e.frame_id>n){this._asyncFrameQueue[0][3]==!0?(V("Forced frame to canvas"),this._pushAsyncFrame(!0),this._droppedFrames+=e.frame_id-(n+1),this._forcedFrameCnt++):(V("Old frame dropped"),this._asyncFrameQueue.shift(),this._droppedFrames+=e.frame_id-n);let r=e.type=="flip"?e.rect_cnt:0;this._asyncFrameQueue.push([e.frame_id,r,[e],r==1,0,0])}}_clearAsyncQueue(){this._droppedFrames+=this._asyncFrameQueue.length,this._asyncFrameQueue=[];for(let e=0;e<this._maxAsyncFrameQueue;e++)this._asyncFrameQueue.push([0,0,[],!1,0,0])}_asyncFrameComplete(e,t=!1){if(e>=this._asyncFrameQueue.length)return;let i=this._asyncFrameQueue[e][4];if(t)for(this._asyncFrameQueue[e][1]==0?this._missingFlipRect++:this._asyncFrameQueue[e][1]!==this._asyncFrameQueue[e][2].length&&(this._droppedRects+=this._asyncFrameQueue[e][1]-this._asyncFrameQueue[e][2].length,this._asyncFrameQueue[e][2].length>this._asyncFrameQueue[e][1]&&V("Frame has more rects than the reported rect_cnt."));i<this._asyncFrameQueue[e][2].length;)this._asyncFrameQueue[e][2][i].type=="img"&&this._asyncFrameQueue[e][2][i].img&&!this._asyncFrameQueue[e][2][i].img.complete&&(this._asyncFrameQueue[e][2][i].type="skip",this._droppedRects++),i++;else for(;i<this._asyncFrameQueue[e][2].length;){if(this._asyncFrameQueue[e][2][i].type=="img"&&!this._asyncFrameQueue[e][2][i].img.complete){this._asyncFrameQueue[e][2][i].img.addEventListener("load",()=>{this._asyncFrameComplete(e)}),this._asyncFrameQueue[e][4]=i;return}i++}this._asyncFrameQueue[e][4]=i,this._asyncFrameQueue[e][3]=!0,t&&e==0?this._pushAsyncFrame(!0):window.requestAnimationFrame(()=>{this._pushAsyncFrame()})}_pushAsyncFrame(e=!1){if(this._asyncFrameQueue[0][3]||e){let t=this._asyncFrameQueue[0][2],i=this._asyncFrameQueue.shift()[0];this._asyncFrameQueue.length<this._maxAsyncFrameQueue&&this._asyncFrameQueue.push([0,0,[],!1,0,0]);let n=0,r=0;for(let a=0;a<t.length;a++){const h=t[a];for(let l=0;l<h.screenLocations.length;l++){let o=h.screenLocations[l];if(o.screenIndex==0){switch(h.type){case"copy":this.copyImage(o.oldX,o.oldY,o.x,o.y,h.width,h.height,h.frame_id,!0);break;case"fill":this.fillRect(o.x,o.y,h.width,h.height,h.color,h.frame_id,!0);break;case"blit":this.blitImage(o.x,o.y,h.width,h.height,h.data,0,h.frame_id,!0);break;case"blitQ":this.blitQoi(o.x,o.y,h.width,h.height,h.data,0,h.frame_id,!0);break;case"img":this.drawImage(h.img,o.x,o.y,h.width,h.height);break;default:continue}r++}else switch(h.type){case"dummy":case"transparent":case"flip":break;default:n++,h.img=null,this._screens[o.screenIndex].channel&&this._screens[o.screenIndex].channel.postMessage({eventType:"rect",rect:h,screenLocationIndex:l})}}}if(this._enableCanvasBuffer&&(r>0&&this._writeCtxBuffer(),this._transparentOverlayImg)){if(r>0&&this.drawImage(this._transparentOverlayImg,this._transparentOverlayRect.x,this._transparentOverlayRect.y,this._transparentOverlayRect.width,this._transparentOverlayRect.height,!0),n>0&&this._lastTransparentRectId!==this._transparentOverlayRect.hash_id)for(let a=1;a<this._transparentOverlayRect.screenLocations.length;a++)this._screens[this._transparentOverlayRect.screenLocations[a].screenIndex].channel&&this._screens[this._transparentOverlayRect.screenLocations[a].screenIndex].channel.postMessage({eventType:"rect",rect:this._transparentOverlayRect,screenLocationIndex:a});this._lastTransparentRectId=this._transparentOverlayRect.hash_id}if(n>0)for(let a=1;a<this.screens.length;a++)this._screens[a].channel&&this._screens[a].channel.postMessage({eventType:"frameComplete",frameId:i,rectCnt:n});this._flipCnt+=1,this._flushing&&(this._flushing=!1,this.onflush()),this._asyncFrameQueue[0][2].length>0&&window.requestAnimationFrame(()=>{this._pushAsyncFrame()})}else this._asyncFrameQueue[0][1]>0&&this._asyncFrameQueue[0][1]==this._asyncFrameQueue[0][2].length&&(this._asyncFrameQueue[0][5]+=1,this._asyncFrameQueue[0][5]>5&&this._pushAsyncFrame(!0))}_processRectScreens(e){let t=[];e.inPrimary=!1,e.inSecondary=!1;for(let i=0;i<this._screens.length;i++){let n=this._screens[i];if(!((e.x>n.x2||n.x>e.x+e.width)&&(e.y>n.y2||n.y>e.y+e.height))){let r={x:0-(n.x-e.x),y:0-(n.y-e.y),screenIndex:i};e.type==="copy"&&(r.oldX=0-(n.x-e.oldX),r.oldY=0-(n.y-e.oldY)),t.push(r),i==0?e.inPrimary=!0:e.inSecondary=!0}}e.screenLocations=t}_rescale(e){this._scale=e;const t=this._screens[0],i=e*t.serverWidth+"px",n=e*t.serverHeight+"px";(this._target.style.width!==i||this._target.style.height!==n)&&(this._target.style.width=i,this._target.style.height=n),I("Pixel Ratio: "+window.devicePixelRatio+", VNC Scale: "+e+"VNC Res: "+t.serverWidth+"x"+t.serverHeight);var r=Math.abs(Math.ceil(window.devicePixelRatio)),a=navigator.userAgent.toLowerCase().indexOf("firefox")>-1;this.antiAliasing===2||this.antiAliasing===0&&e===1&&this._target.style.imageRendering!=="pixelated"&&r===window.devicePixelRatio&&t.width>0?(this._target.style.imageRendering=a?"crisp-edges":"pixelated",C("Smoothing disabled")):(this.antiAliasing===1||this.antiAliasing===0&&e!==1&&this._target.style.imageRendering!=="auto")&&(this._target.style.imageRendering="auto",C("Smoothing enabled"))}_setFillColor(e){const t="rgb("+e[0]+","+e[1]+","+e[2]+")";let i=this._enableCanvasBuffer?this._drawCtx:this._targetCtx;t!==this._prevDrawStyle&&(i.fillStyle=t,this._prevDrawStyle=t)}}function ne(s,e,t,i,n){if(e.subarray&&s.subarray){s.set(e.subarray(t,t+i),n);return}for(var r=0;r<i;r++)s[n+r]=e[t+r]}var dt=Uint8Array,$=Uint16Array,_t=Int32Array;function Nt(s,e,t,i){for(var n=s&65535|0,r=s>>>16&65535|0,a=0;t!==0;){a=t>2e3?2e3:t,t-=a;do n=n+e[i++]|0,r=r+n|0;while(--a);n%=65521,r%=65521}return n|r<<16|0}function G(){for(var s,e=[],t=0;t<256;t++){s=t;for(var i=0;i<8;i++)s=s&1?3988292384^s>>>1:s>>>1;e[t]=s}return e}G();var Ze=30,on=12;function hn(s,e){var t,i,n,r,a,h,l,o,c,u,x,f,p,F,E,K,Q,D,S,L,z,M,B,H,T;t=s.state,i=s.next_in,H=s.input,n=i+(s.avail_in-5),r=s.next_out,T=s.output,a=r-(e-s.avail_out),h=r+(s.avail_out-257),l=t.dmax,o=t.wsize,c=t.whave,u=t.wnext,x=t.window,f=t.hold,p=t.bits,F=t.lencode,E=t.distcode,K=(1<<t.lenbits)-1,Q=(1<<t.distbits)-1;e:do{p<15&&(f+=H[i++]<<p,p+=8,f+=H[i++]<<p,p+=8),D=F[f&K];t:for(;;){if(S=D>>>24,f>>>=S,p-=S,S=D>>>16&255,S===0)T[r++]=D&65535;else if(S&16){L=D&65535,S&=15,S&&(p<S&&(f+=H[i++]<<p,p+=8),L+=f&(1<<S)-1,f>>>=S,p-=S),p<15&&(f+=H[i++]<<p,p+=8,f+=H[i++]<<p,p+=8),D=E[f&Q];i:for(;;){if(S=D>>>24,f>>>=S,p-=S,S=D>>>16&255,S&16){if(z=D&65535,S&=15,p<S&&(f+=H[i++]<<p,p+=8,p<S&&(f+=H[i++]<<p,p+=8)),z+=f&(1<<S)-1,z>l){s.msg="invalid distance too far back",t.mode=Ze;break e}if(f>>>=S,p-=S,S=r-a,z>S){if(S=z-S,S>c&&t.sane){s.msg="invalid distance too far back",t.mode=Ze;break e}if(M=0,B=x,u===0){if(M+=o-S,S<L){L-=S;do T[r++]=x[M++];while(--S);M=r-z,B=T}}else if(u<S){if(M+=o+u-S,S-=u,S<L){L-=S;do T[r++]=x[M++];while(--S);if(M=0,u<L){S=u,L-=S;do T[r++]=x[M++];while(--S);M=r-z,B=T}}}else if(M+=u-S,S<L){L-=S;do T[r++]=x[M++];while(--S);M=r-z,B=T}for(;L>2;)T[r++]=B[M++],T[r++]=B[M++],T[r++]=B[M++],L-=3;L&&(T[r++]=B[M++],L>1&&(T[r++]=B[M++]))}else{M=r-z;do T[r++]=T[M++],T[r++]=T[M++],T[r++]=T[M++],L-=3;while(L>2);L&&(T[r++]=T[M++],L>1&&(T[r++]=T[M++]))}}else if((S&64)===0){D=E[(D&65535)+(f&(1<<S)-1)];continue i}else{s.msg="invalid distance code",t.mode=Ze;break e}break}}else if((S&64)===0){D=F[(D&65535)+(f&(1<<S)-1)];continue t}else if(S&32){t.mode=on;break e}else{s.msg="invalid literal/length code",t.mode=Ze;break e}break}}while(i<n&&r<h);L=p>>3,i-=L,p-=L<<3,f&=(1<<p)-1,s.next_in=i,s.next_out=r,s.avail_in=i<n?5+(n-i):5-(i-n),s.avail_out=r<h?257+(h-r):257-(r-h),t.hold=f,t.bits=p}var be=15,ni=852,ri=592,ai=0,vt=1,oi=2,ln=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],cn=[16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78],dn=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0],_n=[16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64];function Le(s,e,t,i,n,r,a,h){var l=h.bits,o=0,c=0,u=0,x=0,f=0,p=0,F=0,E=0,K=0,Q=0,D,S,L,z,M,B=null,H=0,T,W=new $(be+1),te=new $(be+1),We=null,Zt=0,$t,Ge,Ye;for(o=0;o<=be;o++)W[o]=0;for(c=0;c<i;c++)W[e[t+c]]++;for(f=l,x=be;x>=1&&W[x]===0;x--);if(f>x&&(f=x),x===0)return n[r++]=1<<24|64<<16|0,n[r++]=1<<24|64<<16|0,h.bits=1,0;for(u=1;u<x&&W[u]===0;u++);for(f<u&&(f=u),E=1,o=1;o<=be;o++)if(E<<=1,E-=W[o],E<0)return-1;if(E>0&&(s===ai||x!==1))return-1;for(te[1]=0,o=1;o<be;o++)te[o+1]=te[o]+W[o];for(c=0;c<i;c++)e[t+c]!==0&&(a[te[e[t+c]]++]=c);if(s===ai?(B=We=a,T=19):s===vt?(B=ln,H-=257,We=cn,Zt-=257,T=256):(B=dn,We=_n,T=-1),Q=0,c=0,o=u,M=r,p=f,F=0,L=-1,K=1<<f,z=K-1,s===vt&&K>ni||s===oi&&K>ri)return 1;for(;;){$t=o-F,a[c]<T?(Ge=0,Ye=a[c]):a[c]>T?(Ge=We[Zt+a[c]],Ye=B[H+a[c]]):(Ge=96,Ye=0),D=1<<o-F,S=1<<p,u=S;do S-=D,n[M+(Q>>F)+S]=$t<<24|Ge<<16|Ye|0;while(S!==0);for(D=1<<o-1;Q&D;)D>>=1;if(D!==0?(Q&=D-1,Q+=D):Q=0,c++,--W[o]===0){if(o===x)break;o=e[t+a[c]]}if(o>f&&(Q&z)!==L){for(F===0&&(F=f),M+=u,p=o-F,E=1<<p;p+F<x&&(E-=W[p+F],!(E<=0));)p++,E<<=1;if(K+=1<<p,s===vt&&K>ni||s===oi&&K>ri)return 1;L=Q&z,n[L]=f<<24|p<<16|M-r|0}}return Q!==0&&(n[M+Q]=o-F<<24|64<<16|0),h.bits=f,0}var fn=0,ms=1,ys=2;const hi=4,ft=0,un=1,xn=2,pe=-2,pn=-3,gn=-4,bn=-5,li=8;var vs=1,ci=2,di=3,_i=4,fi=5,ui=6,xi=7,pi=8,gi=9,bi=10,mi=11,ie=12,wt=13,yi=14,kt=15,vi=16,wi=17,ki=18,Si=19,$e=20,qe=21,Ci=22,Fi=23,Ei=24,Ki=25,Xi=26,St=27,Mi=28,Ri=29,N=30,mn=31,yn=32,vn=852,wn=592,kn=15,Sn=kn;function Ai(s){return(s>>>24&255)+(s>>>8&65280)+((s&65280)<<8)+((s&255)<<24)}function Cn(){this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new $(320),this.work=new $(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}function Fn(s){var e;return!s||!s.state?pe:(e=s.state,s.total_in=s.total_out=e.total=0,s.msg="",e.wrap&&(s.adler=e.wrap&1),e.mode=vs,e.last=0,e.havedict=0,e.dmax=32768,e.head=null,e.hold=0,e.bits=0,e.lencode=e.lendyn=new _t(vn),e.distcode=e.distdyn=new _t(wn),e.sane=1,e.back=-1,ft)}function ws(s){var e;return!s||!s.state?pe:(e=s.state,e.wsize=0,e.whave=0,e.wnext=0,Fn(s))}function En(s,e){var t,i;return!s||!s.state||(i=s.state,e<0?(t=0,e=-e):(t=(e>>4)+1,e<48&&(e&=15)),e&&(e<8||e>15))?pe:(i.window!==null&&i.wbits!==e&&(i.window=null),i.wrap=t,i.wbits=e,ws(s))}function Kn(s,e){var t,i;return s?(i=new Cn,s.state=i,i.window=null,t=En(s,e),t!==ft&&(s.state=null),t):pe}function Xn(s){return Kn(s,Sn)}var Di=!0,Ct,Ft;function Mn(s){if(Di){var e;for(Ct=new _t(512),Ft=new _t(32),e=0;e<144;)s.lens[e++]=8;for(;e<256;)s.lens[e++]=9;for(;e<280;)s.lens[e++]=7;for(;e<288;)s.lens[e++]=8;for(Le(ms,s.lens,0,288,Ct,0,s.work,{bits:9}),e=0;e<32;)s.lens[e++]=5;Le(ys,s.lens,0,32,Ft,0,s.work,{bits:5}),Di=!1}s.lencode=Ct,s.lenbits=9,s.distcode=Ft,s.distbits=5}function Rn(s,e,t,i){var n,r=s.state;return r.window===null&&(r.wsize=1<<r.wbits,r.wnext=0,r.whave=0,r.window=new dt(r.wsize)),i>=r.wsize?(ne(r.window,e,t-r.wsize,r.wsize,0),r.wnext=0,r.whave=r.wsize):(n=r.wsize-r.wnext,n>i&&(n=i),ne(r.window,e,t-i,n,r.wnext),i-=n,i?(ne(r.window,e,t-i,i,0),r.wnext=i,r.whave=r.wsize):(r.wnext+=n,r.wnext===r.wsize&&(r.wnext=0),r.whave<r.wsize&&(r.whave+=n))),0}function An(s,e){var t,i,n,r,a,h,l,o,c,u,x,f,p,F,E=0,K,Q,D,S,L,z,M,B,H=new dt(4),T,W,te=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];if(!s||!s.state||!s.output||!s.input&&s.avail_in!==0)return pe;t=s.state,t.mode===ie&&(t.mode=wt),a=s.next_out,n=s.output,l=s.avail_out,r=s.next_in,i=s.input,h=s.avail_in,o=t.hold,c=t.bits,u=h,x=l,B=ft;e:for(;;)switch(t.mode){case vs:if(t.wrap===0){t.mode=wt;break}for(;c<16;){if(h===0)break e;h--,o+=i[r++]<<c,c+=8}if(t.wrap&2&&o===35615){t.check=0,H[0]=o&255,H[1]=o>>>8&255,t.check=G(t.check),o=0,c=0,t.mode=ci;break}if(t.flags=0,t.head&&(t.head.done=!1),!(t.wrap&1)||(((o&255)<<8)+(o>>8))%31){s.msg="incorrect header check",t.mode=N;break}if((o&15)!==li){s.msg="unknown compression method",t.mode=N;break}if(o>>>=4,c-=4,M=(o&15)+8,t.wbits===0)t.wbits=M;else if(M>t.wbits){s.msg="invalid window size",t.mode=N;break}t.dmax=1<<M,s.adler=t.check=1,t.mode=o&512?bi:ie,o=0,c=0;break;case ci:for(;c<16;){if(h===0)break e;h--,o+=i[r++]<<c,c+=8}if(t.flags=o,(t.flags&255)!==li){s.msg="unknown compression method",t.mode=N;break}if(t.flags&57344){s.msg="unknown header flags set",t.mode=N;break}t.head&&(t.head.text=o>>8&1),t.flags&512&&(H[0]=o&255,H[1]=o>>>8&255,t.check=G(t.check)),o=0,c=0,t.mode=di;case di:for(;c<32;){if(h===0)break e;h--,o+=i[r++]<<c,c+=8}t.head&&(t.head.time=o),t.flags&512&&(H[0]=o&255,H[1]=o>>>8&255,H[2]=o>>>16&255,H[3]=o>>>24&255,t.check=G(t.check)),o=0,c=0,t.mode=_i;case _i:for(;c<16;){if(h===0)break e;h--,o+=i[r++]<<c,c+=8}t.head&&(t.head.xflags=o&255,t.head.os=o>>8),t.flags&512&&(H[0]=o&255,H[1]=o>>>8&255,t.check=G(t.check)),o=0,c=0,t.mode=fi;case fi:if(t.flags&1024){for(;c<16;){if(h===0)break e;h--,o+=i[r++]<<c,c+=8}t.length=o,t.head&&(t.head.extra_len=o),t.flags&512&&(H[0]=o&255,H[1]=o>>>8&255,t.check=G(t.check)),o=0,c=0}else t.head&&(t.head.extra=null);t.mode=ui;case ui:if(t.flags&1024&&(f=t.length,f>h&&(f=h),f&&(t.head&&(M=t.head.extra_len-t.length,t.head.extra||(t.head.extra=new Array(t.head.extra_len)),ne(t.head.extra,i,r,f,M)),t.flags&512&&(t.check=G(t.check)),h-=f,r+=f,t.length-=f),t.length))break e;t.length=0,t.mode=xi;case xi:if(t.flags&2048){if(h===0)break e;f=0;do M=i[r+f++],t.head&&M&&t.length<65536&&(t.head.name+=String.fromCharCode(M));while(M&&f<h);if(t.flags&512&&(t.check=G(t.check)),h-=f,r+=f,M)break e}else t.head&&(t.head.name=null);t.length=0,t.mode=pi;case pi:if(t.flags&4096){if(h===0)break e;f=0;do M=i[r+f++],t.head&&M&&t.length<65536&&(t.head.comment+=String.fromCharCode(M));while(M&&f<h);if(t.flags&512&&(t.check=G(t.check)),h-=f,r+=f,M)break e}else t.head&&(t.head.comment=null);t.mode=gi;case gi:if(t.flags&512){for(;c<16;){if(h===0)break e;h--,o+=i[r++]<<c,c+=8}if(o!==(t.check&65535)){s.msg="header crc mismatch",t.mode=N;break}o=0,c=0}t.head&&(t.head.hcrc=t.flags>>9&1,t.head.done=!0),s.adler=t.check=0,t.mode=ie;break;case bi:for(;c<32;){if(h===0)break e;h--,o+=i[r++]<<c,c+=8}s.adler=t.check=Ai(o),o=0,c=0,t.mode=mi;case mi:if(t.havedict===0)return s.next_out=a,s.avail_out=l,s.next_in=r,s.avail_in=h,t.hold=o,t.bits=c,xn;s.adler=t.check=1,t.mode=ie;case ie:case wt:if(t.last){o>>>=c&7,c-=c&7,t.mode=St;break}for(;c<3;){if(h===0)break e;h--,o+=i[r++]<<c,c+=8}switch(t.last=o&1,o>>>=1,c-=1,o&3){case 0:t.mode=yi;break;case 1:Mn(t),t.mode=$e;break;case 2:t.mode=wi;break;case 3:s.msg="invalid block type",t.mode=N}o>>>=2,c-=2;break;case yi:for(o>>>=c&7,c-=c&7;c<32;){if(h===0)break e;h--,o+=i[r++]<<c,c+=8}if((o&65535)!==(o>>>16^65535)){s.msg="invalid stored block lengths",t.mode=N;break}t.length=o&65535,o=0,c=0,t.mode=kt;case kt:t.mode=vi;case vi:if(f=t.length,f){if(f>h&&(f=h),f>l&&(f=l),f===0)break e;ne(n,i,r,f,a),h-=f,r+=f,l-=f,a+=f,t.length-=f;break}t.mode=ie;break;case wi:for(;c<14;){if(h===0)break e;h--,o+=i[r++]<<c,c+=8}if(t.nlen=(o&31)+257,o>>>=5,c-=5,t.ndist=(o&31)+1,o>>>=5,c-=5,t.ncode=(o&15)+4,o>>>=4,c-=4,t.nlen>286||t.ndist>30){s.msg="too many length or distance symbols",t.mode=N;break}t.have=0,t.mode=ki;case ki:for(;t.have<t.ncode;){for(;c<3;){if(h===0)break e;h--,o+=i[r++]<<c,c+=8}t.lens[te[t.have++]]=o&7,o>>>=3,c-=3}for(;t.have<19;)t.lens[te[t.have++]]=0;if(t.lencode=t.lendyn,t.lenbits=7,T={bits:t.lenbits},B=Le(fn,t.lens,0,19,t.lencode,0,t.work,T),t.lenbits=T.bits,B){s.msg="invalid code lengths set",t.mode=N;break}t.have=0,t.mode=Si;case Si:for(;t.have<t.nlen+t.ndist;){for(;E=t.lencode[o&(1<<t.lenbits)-1],K=E>>>24,Q=E>>>16&255,D=E&65535,!(K<=c);){if(h===0)break e;h--,o+=i[r++]<<c,c+=8}if(D<16)o>>>=K,c-=K,t.lens[t.have++]=D;else{if(D===16){for(W=K+2;c<W;){if(h===0)break e;h--,o+=i[r++]<<c,c+=8}if(o>>>=K,c-=K,t.have===0){s.msg="invalid bit length repeat",t.mode=N;break}M=t.lens[t.have-1],f=3+(o&3),o>>>=2,c-=2}else if(D===17){for(W=K+3;c<W;){if(h===0)break e;h--,o+=i[r++]<<c,c+=8}o>>>=K,c-=K,M=0,f=3+(o&7),o>>>=3,c-=3}else{for(W=K+7;c<W;){if(h===0)break e;h--,o+=i[r++]<<c,c+=8}o>>>=K,c-=K,M=0,f=11+(o&127),o>>>=7,c-=7}if(t.have+f>t.nlen+t.ndist){s.msg="invalid bit length repeat",t.mode=N;break}for(;f--;)t.lens[t.have++]=M}}if(t.mode===N)break;if(t.lens[256]===0){s.msg="invalid code -- missing end-of-block",t.mode=N;break}if(t.lenbits=9,T={bits:t.lenbits},B=Le(ms,t.lens,0,t.nlen,t.lencode,0,t.work,T),t.lenbits=T.bits,B){s.msg="invalid literal/lengths set",t.mode=N;break}if(t.distbits=6,t.distcode=t.distdyn,T={bits:t.distbits},B=Le(ys,t.lens,t.nlen,t.ndist,t.distcode,0,t.work,T),t.distbits=T.bits,B){s.msg="invalid distances set",t.mode=N;break}t.mode=$e;case $e:t.mode=qe;case qe:if(h>=6&&l>=258){s.next_out=a,s.avail_out=l,s.next_in=r,s.avail_in=h,t.hold=o,t.bits=c,hn(s,x),a=s.next_out,n=s.output,l=s.avail_out,r=s.next_in,i=s.input,h=s.avail_in,o=t.hold,c=t.bits,t.mode===ie&&(t.back=-1);break}for(t.back=0;E=t.lencode[o&(1<<t.lenbits)-1],K=E>>>24,Q=E>>>16&255,D=E&65535,!(K<=c);){if(h===0)break e;h--,o+=i[r++]<<c,c+=8}if(Q&&(Q&240)===0){for(S=K,L=Q,z=D;E=t.lencode[z+((o&(1<<S+L)-1)>>S)],K=E>>>24,Q=E>>>16&255,D=E&65535,!(S+K<=c);){if(h===0)break e;h--,o+=i[r++]<<c,c+=8}o>>>=S,c-=S,t.back+=S}if(o>>>=K,c-=K,t.back+=K,t.length=D,Q===0){t.mode=Xi;break}if(Q&32){t.back=-1,t.mode=ie;break}if(Q&64){s.msg="invalid literal/length code",t.mode=N;break}t.extra=Q&15,t.mode=Ci;case Ci:if(t.extra){for(W=t.extra;c<W;){if(h===0)break e;h--,o+=i[r++]<<c,c+=8}t.length+=o&(1<<t.extra)-1,o>>>=t.extra,c-=t.extra,t.back+=t.extra}t.was=t.length,t.mode=Fi;case Fi:for(;E=t.distcode[o&(1<<t.distbits)-1],K=E>>>24,Q=E>>>16&255,D=E&65535,!(K<=c);){if(h===0)break e;h--,o+=i[r++]<<c,c+=8}if((Q&240)===0){for(S=K,L=Q,z=D;E=t.distcode[z+((o&(1<<S+L)-1)>>S)],K=E>>>24,Q=E>>>16&255,D=E&65535,!(S+K<=c);){if(h===0)break e;h--,o+=i[r++]<<c,c+=8}o>>>=S,c-=S,t.back+=S}if(o>>>=K,c-=K,t.back+=K,Q&64){s.msg="invalid distance code",t.mode=N;break}t.offset=D,t.extra=Q&15,t.mode=Ei;case Ei:if(t.extra){for(W=t.extra;c<W;){if(h===0)break e;h--,o+=i[r++]<<c,c+=8}t.offset+=o&(1<<t.extra)-1,o>>>=t.extra,c-=t.extra,t.back+=t.extra}if(t.offset>t.dmax){s.msg="invalid distance too far back",t.mode=N;break}t.mode=Ki;case Ki:if(l===0)break e;if(f=x-l,t.offset>f){if(f=t.offset-f,f>t.whave&&t.sane){s.msg="invalid distance too far back",t.mode=N;break}f>t.wnext?(f-=t.wnext,p=t.wsize-f):p=t.wnext-f,f>t.length&&(f=t.length),F=t.window}else F=n,p=a-t.offset,f=t.length;f>l&&(f=l),l-=f,t.length-=f;do n[a++]=F[p++];while(--f);t.length===0&&(t.mode=qe);break;case Xi:if(l===0)break e;n[a++]=t.length,l--,t.mode=qe;break;case St:if(t.wrap){for(;c<32;){if(h===0)break e;h--,o|=i[r++]<<c,c+=8}if(x-=l,s.total_out+=x,t.total+=x,x&&(s.adler=t.check=t.flags?G(t.check):Nt(t.check,n,x,a-x)),x=l,(t.flags?o:Ai(o))!==t.check){s.msg="incorrect data check",t.mode=N;break}o=0,c=0}t.mode=Mi;case Mi:if(t.wrap&&t.flags){for(;c<32;){if(h===0)break e;h--,o+=i[r++]<<c,c+=8}if(o!==(t.total&4294967295)){s.msg="incorrect length check",t.mode=N;break}o=0,c=0}t.mode=Ri;case Ri:B=un;break e;case N:B=pn;break e;case mn:return gn;case yn:default:return pe}return s.next_out=a,s.avail_out=l,s.next_in=r,s.avail_in=h,t.hold=o,t.bits=c,(t.wsize||x!==s.avail_out&&t.mode<N&&(t.mode<St||e!==hi))&&Rn(s,s.output,s.next_out,x-s.avail_out),u-=s.avail_in,x-=s.avail_out,s.total_in+=u,s.total_out+=x,t.total+=x,t.wrap&&x&&(s.adler=t.check=t.flags?G(t.check,n,x,s.next_out-x):Nt(t.check,n,x,s.next_out-x)),s.data_type=t.bits+(t.last?64:0)+(t.mode===ie?128:0)+(t.mode===$e||t.mode===kt?256:0),(u===0&&x===0||e===hi)&&B===ft&&(B=bn),B}function ks(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}class ut{constructor(){this.strm=new ks,this.chunkSize=1024*10*10,this.strm.output=new Uint8Array(this.chunkSize),this.windowBits=5,Xn(this.strm,this.windowBits)}setInput(e){e?(this.strm.input=e,this.strm.avail_in=this.strm.input.length,this.strm.next_in=0):(this.strm.input=null,this.strm.avail_in=0,this.strm.next_in=0)}inflate(e){if(e>this.chunkSize&&(this.chunkSize=e,this.strm.output=new Uint8Array(this.chunkSize)),this.strm.next_out=0,this.strm.avail_out=e,An(this.strm,0)<0)throw new Error("zlib inflate failed");if(this.strm.next_out!=e)throw new Error("Incomplete zlib block, got "+this.strm.next_out+" expected "+e);return new Uint8Array(this.strm.output.buffer,0,this.strm.next_out)}reset(){ws(this.strm)}}var Dn=4,Ti=0,Li=1,Tn=2;function Ke(s){for(var e=s.length;--e>=0;)s[e]=0}var Ln=0,Qn=1,In=2,Pn=3,Un=258,Wt=29,Ne=256,Ie=Ne+1+Wt,Fe=30,Gt=19,Ss=2*Ie+1,xe=15,Et=16,Bn=7,Cs=256,Fs=16,Es=17,Ks=18,Ot=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0],ot=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],Hn=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7],Xs=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],Nn=512,oe=new Array((Ie+2)*2);Ke(oe);var Qe=new Array(Fe*2);Ke(Qe);var Pe=new Array(Nn);Ke(Pe);var Ue=new Array(Un-Pn+1);Ke(Ue);var Yt=new Array(Wt);Ke(Yt);var xt=new Array(Fe);Ke(xt);function Kt(s,e,t,i,n){this.static_tree=s,this.extra_bits=e,this.extra_base=t,this.elems=i,this.max_length=n,this.has_stree=s&&s.length}var Ms,Rs,As;function Xt(s,e){this.dyn_tree=s,this.max_code=0,this.stat_desc=e}function Ds(s){return s<256?Pe[s]:Pe[256+(s>>>7)]}function pt(s,e){s.pending_buf[s.pending++]=e&255,s.pending_buf[s.pending++]=e>>>8&255}function Z(s,e,t){s.bi_valid>Et-t?(s.bi_buf|=e<<s.bi_valid&65535,pt(s,s.bi_buf),s.bi_buf=e>>Et-s.bi_valid,s.bi_valid+=t-Et):(s.bi_buf|=e<<s.bi_valid&65535,s.bi_valid+=t)}function se(s,e,t){Z(s,t[e*2],t[e*2+1])}function Ts(s,e){var t=0;do t|=s&1,s>>>=1,t<<=1;while(--e>0);return t>>>1}function On(s,e){var t=e.dyn_tree,i=e.max_code,n=e.stat_desc.static_tree,r=e.stat_desc.has_stree,a=e.stat_desc.extra_bits,h=e.stat_desc.extra_base,l=e.stat_desc.max_length,o,c,u,x,f,p,F=0;for(x=0;x<=xe;x++)s.bl_count[x]=0;for(t[s.heap[s.heap_max]*2+1]=0,o=s.heap_max+1;o<Ss;o++)c=s.heap[o],x=t[t[c*2+1]*2+1]+1,x>l&&(x=l,F++),t[c*2+1]=x,!(c>i)&&(s.bl_count[x]++,f=0,c>=h&&(f=a[c-h]),p=t[c*2],s.opt_len+=p*(x+f),r&&(s.static_len+=p*(n[c*2+1]+f)));if(F!==0){do{for(x=l-1;s.bl_count[x]===0;)x--;s.bl_count[x]--,s.bl_count[x+1]+=2,s.bl_count[l]--,F-=2}while(F>0);for(x=l;x!==0;x--)for(c=s.bl_count[x];c!==0;)u=s.heap[--o],!(u>i)&&(t[u*2+1]!==x&&(s.opt_len+=(x-t[u*2+1])*t[u*2],t[u*2+1]=x),c--)}}function Ls(s,e,t){var i=new Array(xe+1),n=0,r,a;for(r=1;r<=xe;r++)i[r]=n=n+t[r-1]<<1;for(a=0;a<=e;a++){var h=s[a*2+1];h!==0&&(s[a*2]=Ts(i[h]++,h))}}function zn(){var s,e,t,i,n,r=new Array(xe+1);for(t=0,i=0;i<Wt-1;i++)for(Yt[i]=t,s=0;s<1<<Ot[i];s++)Ue[t++]=i;for(Ue[t-1]=i,n=0,i=0;i<16;i++)for(xt[i]=n,s=0;s<1<<ot[i];s++)Pe[n++]=i;for(n>>=7;i<Fe;i++)for(xt[i]=n<<7,s=0;s<1<<ot[i]-7;s++)Pe[256+n++]=i;for(e=0;e<=xe;e++)r[e]=0;for(s=0;s<=143;)oe[s*2+1]=8,s++,r[8]++;for(;s<=255;)oe[s*2+1]=9,s++,r[9]++;for(;s<=279;)oe[s*2+1]=7,s++,r[7]++;for(;s<=287;)oe[s*2+1]=8,s++,r[8]++;for(Ls(oe,Ie+1,r),s=0;s<Fe;s++)Qe[s*2+1]=5,Qe[s*2]=Ts(s,5);Ms=new Kt(oe,Ot,Ne+1,Ie,xe),Rs=new Kt(Qe,ot,0,Fe,xe),As=new Kt(new Array(0),Hn,0,Gt,Bn)}function Qs(s){var e;for(e=0;e<Ie;e++)s.dyn_ltree[e*2]=0;for(e=0;e<Fe;e++)s.dyn_dtree[e*2]=0;for(e=0;e<Gt;e++)s.bl_tree[e*2]=0;s.dyn_ltree[Cs*2]=1,s.opt_len=s.static_len=0,s.last_lit=s.matches=0}function Is(s){s.bi_valid>8?pt(s,s.bi_buf):s.bi_valid>0&&(s.pending_buf[s.pending++]=s.bi_buf),s.bi_buf=0,s.bi_valid=0}function Vn(s,e,t,i){Is(s),pt(s,t),pt(s,~t),ne(s.pending_buf,s.window,e,t,s.pending),s.pending+=t}function Qi(s,e,t,i){var n=e*2,r=t*2;return s[n]<s[r]||s[n]===s[r]&&i[e]<=i[t]}function Mt(s,e,t){for(var i=s.heap[t],n=t<<1;n<=s.heap_len&&(n<s.heap_len&&Qi(e,s.heap[n+1],s.heap[n],s.depth)&&n++,!Qi(e,i,s.heap[n],s.depth));)s.heap[t]=s.heap[n],t=n,n<<=1;s.heap[t]=i}function Ii(s,e,t){var i,n,r=0,a,h;if(s.last_lit!==0)do i=s.pending_buf[s.d_buf+r*2]<<8|s.pending_buf[s.d_buf+r*2+1],n=s.pending_buf[s.l_buf+r],r++,i===0?se(s,n,e):(a=Ue[n],se(s,a+Ne+1,e),h=Ot[a],h!==0&&(n-=Yt[a],Z(s,n,h)),i--,a=Ds(i),se(s,a,t),h=ot[a],h!==0&&(i-=xt[a],Z(s,i,h)));while(r<s.last_lit);se(s,Cs,e)}function zt(s,e){var t=e.dyn_tree,i=e.stat_desc.static_tree,n=e.stat_desc.has_stree,r=e.stat_desc.elems,a,h,l=-1,o;for(s.heap_len=0,s.heap_max=Ss,a=0;a<r;a++)t[a*2]!==0?(s.heap[++s.heap_len]=l=a,s.depth[a]=0):t[a*2+1]=0;for(;s.heap_len<2;)o=s.heap[++s.heap_len]=l<2?++l:0,t[o*2]=1,s.depth[o]=0,s.opt_len--,n&&(s.static_len-=i[o*2+1]);for(e.max_code=l,a=s.heap_len>>1;a>=1;a--)Mt(s,t,a);o=r;do a=s.heap[1],s.heap[1]=s.heap[s.heap_len--],Mt(s,t,1),h=s.heap[1],s.heap[--s.heap_max]=a,s.heap[--s.heap_max]=h,t[o*2]=t[a*2]+t[h*2],s.depth[o]=(s.depth[a]>=s.depth[h]?s.depth[a]:s.depth[h])+1,t[a*2+1]=t[h*2+1]=o,s.heap[1]=o++,Mt(s,t,1);while(s.heap_len>=2);s.heap[--s.heap_max]=s.heap[1],On(s,e),Ls(t,l,s.bl_count)}function Pi(s,e,t){var i,n=-1,r,a=e[0*2+1],h=0,l=7,o=4;for(a===0&&(l=138,o=3),e[(t+1)*2+1]=65535,i=0;i<=t;i++)r=a,a=e[(i+1)*2+1],!(++h<l&&r===a)&&(h<o?s.bl_tree[r*2]+=h:r!==0?(r!==n&&s.bl_tree[r*2]++,s.bl_tree[Fs*2]++):h<=10?s.bl_tree[Es*2]++:s.bl_tree[Ks*2]++,h=0,n=r,a===0?(l=138,o=3):r===a?(l=6,o=3):(l=7,o=4))}function Ui(s,e,t){var i,n=-1,r,a=e[0*2+1],h=0,l=7,o=4;for(a===0&&(l=138,o=3),i=0;i<=t;i++)if(r=a,a=e[(i+1)*2+1],!(++h<l&&r===a)){if(h<o)do se(s,r,s.bl_tree);while(--h!==0);else r!==0?(r!==n&&(se(s,r,s.bl_tree),h--),se(s,Fs,s.bl_tree),Z(s,h-3,2)):h<=10?(se(s,Es,s.bl_tree),Z(s,h-3,3)):(se(s,Ks,s.bl_tree),Z(s,h-11,7));h=0,n=r,a===0?(l=138,o=3):r===a?(l=6,o=3):(l=7,o=4)}}function Wn(s){var e;for(Pi(s,s.dyn_ltree,s.l_desc.max_code),Pi(s,s.dyn_dtree,s.d_desc.max_code),zt(s,s.bl_desc),e=Gt-1;e>=3&&s.bl_tree[Xs[e]*2+1]===0;e--);return s.opt_len+=3*(e+1)+5+5+4,e}function Gn(s,e,t,i){var n;for(Z(s,e-257,5),Z(s,t-1,5),Z(s,i-4,4),n=0;n<i;n++)Z(s,s.bl_tree[Xs[n]*2+1],3);Ui(s,s.dyn_ltree,e-1),Ui(s,s.dyn_dtree,t-1)}function Yn(s){var e=4093624447,t;for(t=0;t<=31;t++,e>>>=1)if(e&1&&s.dyn_ltree[t*2]!==0)return Ti;if(s.dyn_ltree[9*2]!==0||s.dyn_ltree[10*2]!==0||s.dyn_ltree[13*2]!==0)return Li;for(t=32;t<Ne;t++)if(s.dyn_ltree[t*2]!==0)return Li;return Ti}var Bi=!1;function jn(s){Bi||(zn(),Bi=!0),s.l_desc=new Xt(s.dyn_ltree,Ms),s.d_desc=new Xt(s.dyn_dtree,Rs),s.bl_desc=new Xt(s.bl_tree,As),s.bi_buf=0,s.bi_valid=0,Qs(s)}function Ps(s,e,t,i){Z(s,(Ln<<1)+(i?1:0),3),Vn(s,e,t)}function Zn(s,e,t,i){var n,r,a=0;s.level>0?(s.strm.data_type===Tn&&(s.strm.data_type=Yn(s)),zt(s,s.l_desc),zt(s,s.d_desc),a=Wn(s),n=s.opt_len+3+7>>>3,r=s.static_len+3+7>>>3,r<=n&&(n=r)):n=r=t+5,t+4<=n&&e!==-1?Ps(s,e,t,i):s.strategy===Dn||r===n?(Z(s,(Qn<<1)+(i?1:0),3),Ii(s,oe,Qe)):(Z(s,(In<<1)+(i?1:0),3),Gn(s,s.l_desc.max_code+1,s.d_desc.max_code+1,a+1),Ii(s,s.dyn_ltree,s.dyn_dtree)),Qs(s),i&&Is(s)}function le(s,e,t){return s.pending_buf[s.d_buf+s.last_lit*2]=e>>>8&255,s.pending_buf[s.d_buf+s.last_lit*2+1]=e&255,s.pending_buf[s.l_buf+s.last_lit]=t&255,s.last_lit++,e===0?s.dyn_ltree[t*2]++:(s.matches++,e--,s.dyn_ltree[(Ue[t]+Ne+1)*2]++,s.dyn_dtree[Ds(e)*2]++),s.last_lit===s.lit_bufsize-1}const $n={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"},Oe=0,Hi=3,Be=4,qn=5,we=0,Ee=-2,Rt=-5,Jn=-1,er=1,Je=2,tr=3,ir=4,sr=0,nr=2,jt=8;var rr=15,ar=8,or=29,hr=256,Vt=hr+1+or,lr=30,cr=19,dr=2*Vt+1,_r=15,P=3,he=258,q=he+P+1,fr=32,Us=42,Ni=69,At=73,Dt=91,Tt=103,De=113,et=666,Y=1,ze=2,He=3,bt=4,ur=3;function ke(s,e){return s.msg=$n[e],e}function Oi(s){return(s<<1)-(s>4?9:0)}function fe(s){for(var e=s.length;--e>=0;)s[e]=0}function de(s){var e=s.state,t=e.pending;t>s.avail_out&&(t=s.avail_out),t!==0&&(ne(s.output,e.pending_buf,e.pending_out,t,s.next_out),s.next_out+=t,e.pending_out+=t,s.total_out+=t,s.avail_out-=t,e.pending-=t,e.pending===0&&(e.pending_out=0))}function j(s,e){Zn(s,s.block_start>=0?s.block_start:-1,s.strstart-s.block_start,e),s.block_start=s.strstart,de(s.strm)}function O(s,e){s.pending_buf[s.pending++]=e}function Lt(s,e){s.pending_buf[s.pending++]=e>>>8&255,s.pending_buf[s.pending++]=e&255}function xr(s,e,t,i){var n=s.avail_in;return n>i&&(n=i),n===0?0:(s.avail_in-=n,ne(e,s.input,s.next_in,n,t),s.state.wrap===1?s.adler=Nt(s.adler,e,n,t):s.state.wrap===2&&(s.adler=G(s.adler)),s.next_in+=n,s.total_in+=n,n)}function Bs(s,e){var t=s.max_chain_length,i=s.strstart,n,r,a=s.prev_length,h=s.nice_match,l=s.strstart>s.w_size-q?s.strstart-(s.w_size-q):0,o=s.window,c=s.w_mask,u=s.prev,x=s.strstart+he,f=o[i+a-1],p=o[i+a];s.prev_length>=s.good_match&&(t>>=2),h>s.lookahead&&(h=s.lookahead);do if(n=e,!(o[n+a]!==p||o[n+a-1]!==f||o[n]!==o[i]||o[++n]!==o[i+1])){i+=2,n++;do;while(o[++i]===o[++n]&&o[++i]===o[++n]&&o[++i]===o[++n]&&o[++i]===o[++n]&&o[++i]===o[++n]&&o[++i]===o[++n]&&o[++i]===o[++n]&&o[++i]===o[++n]&&i<x);if(r=he-(x-i),i=x-he,r>a){if(s.match_start=e,a=r,r>=h)break;f=o[i+a-1],p=o[i+a]}}while((e=u[e&c])>l&&--t!==0);return a<=s.lookahead?a:s.lookahead}function Ve(s){var e=s.w_size,t,i,n,r,a;do{if(r=s.window_size-s.lookahead-s.strstart,s.strstart>=e+(e-q)){ne(s.window,s.window,e,e,0),s.match_start-=e,s.strstart-=e,s.block_start-=e,i=s.hash_size,t=i;do n=s.head[--t],s.head[t]=n>=e?n-e:0;while(--i);i=e,t=i;do n=s.prev[--t],s.prev[t]=n>=e?n-e:0;while(--i);r+=e}if(s.strm.avail_in===0)break;if(i=xr(s.strm,s.window,s.strstart+s.lookahead,r),s.lookahead+=i,s.lookahead+s.insert>=P)for(a=s.strstart-s.insert,s.ins_h=s.window[a],s.ins_h=(s.ins_h<<s.hash_shift^s.window[a+1])&s.hash_mask;s.insert&&(s.ins_h=(s.ins_h<<s.hash_shift^s.window[a+P-1])&s.hash_mask,s.prev[a&s.w_mask]=s.head[s.ins_h],s.head[s.ins_h]=a,a++,s.insert--,!(s.lookahead+s.insert<P)););}while(s.lookahead<q&&s.strm.avail_in!==0)}function pr(s,e){var t=65535;for(t>s.pending_buf_size-5&&(t=s.pending_buf_size-5);;){if(s.lookahead<=1){if(Ve(s),s.lookahead===0&&e===Oe)return Y;if(s.lookahead===0)break}s.strstart+=s.lookahead,s.lookahead=0;var i=s.block_start+t;if((s.strstart===0||s.strstart>=i)&&(s.lookahead=s.strstart-i,s.strstart=i,j(s,!1),s.strm.avail_out===0)||s.strstart-s.block_start>=s.w_size-q&&(j(s,!1),s.strm.avail_out===0))return Y}return s.insert=0,e===Be?(j(s,!0),s.strm.avail_out===0?He:bt):(s.strstart>s.block_start&&(j(s,!1),s.strm.avail_out===0),Y)}function Qt(s,e){for(var t,i;;){if(s.lookahead<q){if(Ve(s),s.lookahead<q&&e===Oe)return Y;if(s.lookahead===0)break}if(t=0,s.lookahead>=P&&(s.ins_h=(s.ins_h<<s.hash_shift^s.window[s.strstart+P-1])&s.hash_mask,t=s.prev[s.strstart&s.w_mask]=s.head[s.ins_h],s.head[s.ins_h]=s.strstart),t!==0&&s.strstart-t<=s.w_size-q&&(s.match_length=Bs(s,t)),s.match_length>=P)if(i=le(s,s.strstart-s.match_start,s.match_length-P),s.lookahead-=s.match_length,s.match_length<=s.max_lazy_match&&s.lookahead>=P){s.match_length--;do s.strstart++,s.ins_h=(s.ins_h<<s.hash_shift^s.window[s.strstart+P-1])&s.hash_mask,t=s.prev[s.strstart&s.w_mask]=s.head[s.ins_h],s.head[s.ins_h]=s.strstart;while(--s.match_length!==0);s.strstart++}else s.strstart+=s.match_length,s.match_length=0,s.ins_h=s.window[s.strstart],s.ins_h=(s.ins_h<<s.hash_shift^s.window[s.strstart+1])&s.hash_mask;else i=le(s,0,s.window[s.strstart]),s.lookahead--,s.strstart++;if(i&&(j(s,!1),s.strm.avail_out===0))return Y}return s.insert=s.strstart<P-1?s.strstart:P-1,e===Be?(j(s,!0),s.strm.avail_out===0?He:bt):s.last_lit&&(j(s,!1),s.strm.avail_out===0)?Y:ze}function me(s,e){for(var t,i,n;;){if(s.lookahead<q){if(Ve(s),s.lookahead<q&&e===Oe)return Y;if(s.lookahead===0)break}if(t=0,s.lookahead>=P&&(s.ins_h=(s.ins_h<<s.hash_shift^s.window[s.strstart+P-1])&s.hash_mask,t=s.prev[s.strstart&s.w_mask]=s.head[s.ins_h],s.head[s.ins_h]=s.strstart),s.prev_length=s.match_length,s.prev_match=s.match_start,s.match_length=P-1,t!==0&&s.prev_length<s.max_lazy_match&&s.strstart-t<=s.w_size-q&&(s.match_length=Bs(s,t),s.match_length<=5&&(s.strategy===er||s.match_length===P&&s.strstart-s.match_start>4096)&&(s.match_length=P-1)),s.prev_length>=P&&s.match_length<=s.prev_length){n=s.strstart+s.lookahead-P,i=le(s,s.strstart-1-s.prev_match,s.prev_length-P),s.lookahead-=s.prev_length-1,s.prev_length-=2;do++s.strstart<=n&&(s.ins_h=(s.ins_h<<s.hash_shift^s.window[s.strstart+P-1])&s.hash_mask,t=s.prev[s.strstart&s.w_mask]=s.head[s.ins_h],s.head[s.ins_h]=s.strstart);while(--s.prev_length!==0);if(s.match_available=0,s.match_length=P-1,s.strstart++,i&&(j(s,!1),s.strm.avail_out===0))return Y}else if(s.match_available){if(i=le(s,0,s.window[s.strstart-1]),i&&j(s,!1),s.strstart++,s.lookahead--,s.strm.avail_out===0)return Y}else s.match_available=1,s.strstart++,s.lookahead--}return s.match_available&&(i=le(s,0,s.window[s.strstart-1]),s.match_available=0),s.insert=s.strstart<P-1?s.strstart:P-1,e===Be?(j(s,!0),s.strm.avail_out===0?He:bt):s.last_lit&&(j(s,!1),s.strm.avail_out===0)?Y:ze}function gr(s,e){for(var t,i,n,r,a=s.window;!(s.lookahead<=he&&(Ve(s),s.lookahead<=he,s.lookahead===0));){if(s.match_length=0,s.lookahead>=P&&s.strstart>0&&(n=s.strstart-1,i=a[n],i===a[++n]&&i===a[++n]&&i===a[++n])){r=s.strstart+he;do;while(i===a[++n]&&i===a[++n]&&i===a[++n]&&i===a[++n]&&i===a[++n]&&i===a[++n]&&i===a[++n]&&i===a[++n]&&n<r);s.match_length=he-(r-n),s.match_length>s.lookahead&&(s.match_length=s.lookahead)}if(s.match_length>=P?(t=le(s,1,s.match_length-P),s.lookahead-=s.match_length,s.strstart+=s.match_length,s.match_length=0):(t=le(s,0,s.window[s.strstart]),s.lookahead--,s.strstart++),t&&(j(s,!1),s.strm.avail_out===0))return Y}return s.insert=0,s.last_lit&&(j(s,!1),s.strm.avail_out===0)?Y:ze}function br(s,e){for(var t;!(s.lookahead===0&&(Ve(s),s.lookahead===0));)if(s.match_length=0,t=le(s,0,s.window[s.strstart]),s.lookahead--,s.strstart++,t&&(j(s,!1),s.strm.avail_out===0))return Y;return s.insert=0,s.last_lit&&(j(s,!1),s.strm.avail_out===0)?Y:ze}function J(s,e,t,i,n){this.good_length=s,this.max_lazy=e,this.nice_length=t,this.max_chain=i,this.func=n}var Se;Se=[new J(0,0,0,0,pr),new J(4,4,8,4,Qt),new J(4,5,16,8,Qt),new J(4,6,32,32,Qt),new J(4,4,16,16,me),new J(8,16,32,32,me),new J(8,16,128,128,me),new J(8,32,128,256,me),new J(32,128,258,1024,me),new J(32,258,258,4096,me)];function mr(s){s.window_size=2*s.w_size,fe(s.head),s.max_lazy_match=Se[s.level].max_lazy,s.good_match=Se[s.level].good_length,s.nice_match=Se[s.level].nice_length,s.max_chain_length=Se[s.level].max_chain,s.strstart=0,s.block_start=0,s.lookahead=0,s.insert=0,s.match_length=s.prev_length=P-1,s.match_available=0,s.ins_h=0}function yr(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=jt,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new $(dr*2),this.dyn_dtree=new $((2*lr+1)*2),this.bl_tree=new $((2*cr+1)*2),fe(this.dyn_ltree),fe(this.dyn_dtree),fe(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new $(_r+1),this.heap=new $(2*Vt+1),fe(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new $(2*Vt+1),fe(this.depth),this.l_buf=0,this.lit_bufsize=0,this.last_lit=0,this.d_buf=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}function vr(s){var e;return!s||!s.state?ke(s,Ee):(s.total_in=s.total_out=0,s.data_type=nr,e=s.state,e.pending=0,e.pending_out=0,e.wrap<0&&(e.wrap=-e.wrap),e.status=e.wrap?Us:De,s.adler=e.wrap===2?0:1,e.last_flush=Oe,jn(e),we)}function wr(s){var e=vr(s);return e===we&&mr(s.state),e}function kr(s,e,t,i,n,r){if(!s)return Ee;var a=1;if(e===Jn&&(e=6),e<0||e>9||r<0||r>ir)return ke(s,Ee);var h=new yr;return s.state=h,h.strm=s,h.wrap=a,h.gzhead=null,h.w_bits=i,h.w_size=1<<h.w_bits,h.w_mask=h.w_size-1,h.hash_bits=n+7,h.hash_size=1<<h.hash_bits,h.hash_mask=h.hash_size-1,h.hash_shift=~~((h.hash_bits+P-1)/P),h.window=new dt(h.w_size*2),h.head=new $(h.hash_size),h.prev=new $(h.w_size),h.lit_bufsize=1<<n+6,h.pending_buf_size=h.lit_bufsize*4,h.pending_buf=new dt(h.pending_buf_size),h.d_buf=1*h.lit_bufsize,h.l_buf=3*h.lit_bufsize,h.level=e,h.strategy=r,h.method=t,wr(s)}function Sr(s,e){return kr(s,e,jt,rr,ar,sr)}function zi(s,e){var t,i,n,r;if(!s||!s.state||e>qn||e<0)return s?ke(s,Ee):Ee;if(i=s.state,!s.output||!s.input&&s.avail_in!==0||i.status===et&&e!==Be)return ke(s,s.avail_out===0?Rt:Ee);if(i.strm=s,t=i.last_flush,i.last_flush=e,i.status===Us)if(i.wrap===2)s.adler=0,O(i,31),O(i,139),O(i,8),i.gzhead?(O(i,(i.gzhead.text?1:0)+(i.gzhead.hcrc?2:0)+(i.gzhead.extra?4:0)+(i.gzhead.name?8:0)+(i.gzhead.comment?16:0)),O(i,i.gzhead.time&255),O(i,i.gzhead.time>>8&255),O(i,i.gzhead.time>>16&255),O(i,i.gzhead.time>>24&255),O(i,i.level===9?2:i.strategy>=Je||i.level<2?4:0),O(i,i.gzhead.os&255),i.gzhead.extra&&i.gzhead.extra.length&&(O(i,i.gzhead.extra.length&255),O(i,i.gzhead.extra.length>>8&255)),i.gzhead.hcrc&&(s.adler=G(s.adler,i.pending_buf,i.pending)),i.gzindex=0,i.status=Ni):(O(i,0),O(i,0),O(i,0),O(i,0),O(i,0),O(i,i.level===9?2:i.strategy>=Je||i.level<2?4:0),O(i,ur),i.status=De);else{var a=jt+(i.w_bits-8<<4)<<8,h=-1;i.strategy>=Je||i.level<2?h=0:i.level<6?h=1:i.level===6?h=2:h=3,a|=h<<6,i.strstart!==0&&(a|=fr),a+=31-a%31,i.status=De,Lt(i,a),i.strstart!==0&&(Lt(i,s.adler>>>16),Lt(i,s.adler&65535)),s.adler=1}if(i.status===Ni)if(i.gzhead.extra){for(n=i.pending;i.gzindex<(i.gzhead.extra.length&65535)&&!(i.pending===i.pending_buf_size&&(i.gzhead.hcrc&&i.pending>n&&(s.adler=G(s.adler,i.pending_buf,i.pending-n)),de(s),n=i.pending,i.pending===i.pending_buf_size));)O(i,i.gzhead.extra[i.gzindex]&255),i.gzindex++;i.gzhead.hcrc&&i.pending>n&&(s.adler=G(s.adler,i.pending_buf,i.pending-n)),i.gzindex===i.gzhead.extra.length&&(i.gzindex=0,i.status=At)}else i.status=At;if(i.status===At)if(i.gzhead.name){n=i.pending;do{if(i.pending===i.pending_buf_size&&(i.gzhead.hcrc&&i.pending>n&&(s.adler=G(s.adler,i.pending_buf,i.pending-n)),de(s),n=i.pending,i.pending===i.pending_buf_size)){r=1;break}i.gzindex<i.gzhead.name.length?r=i.gzhead.name.charCodeAt(i.gzindex++)&255:r=0,O(i,r)}while(r!==0);i.gzhead.hcrc&&i.pending>n&&(s.adler=G(s.adler,i.pending_buf,i.pending-n)),r===0&&(i.gzindex=0,i.status=Dt)}else i.status=Dt;if(i.status===Dt)if(i.gzhead.comment){n=i.pending;do{if(i.pending===i.pending_buf_size&&(i.gzhead.hcrc&&i.pending>n&&(s.adler=G(s.adler,i.pending_buf,i.pending-n)),de(s),n=i.pending,i.pending===i.pending_buf_size)){r=1;break}i.gzindex<i.gzhead.comment.length?r=i.gzhead.comment.charCodeAt(i.gzindex++)&255:r=0,O(i,r)}while(r!==0);i.gzhead.hcrc&&i.pending>n&&(s.adler=G(s.adler,i.pending_buf,i.pending-n)),r===0&&(i.status=Tt)}else i.status=Tt;if(i.status===Tt&&(i.gzhead.hcrc?(i.pending+2>i.pending_buf_size&&de(s),i.pending+2<=i.pending_buf_size&&(O(i,s.adler&255),O(i,s.adler>>8&255),s.adler=0,i.status=De)):i.status=De),i.pending!==0){if(de(s),s.avail_out===0)return i.last_flush=-1,we}else if(s.avail_in===0&&Oi(e)<=Oi(t)&&e!==Be)return ke(s,Rt);if(i.status===et&&s.avail_in!==0)return ke(s,Rt);if(s.avail_in!==0||i.lookahead!==0||i.status!==et){var l=i.strategy===Je?br(i):i.strategy===tr?gr(i,e):Se[i.level].func(i,e);if((l===He||l===bt)&&(i.status=et),l===Y||l===He)return s.avail_out===0&&(i.last_flush=-1),we;if(l===ze&&(Ps(i,0,0,!1),fe(i.head),i.lookahead===0&&(i.strstart=0,i.block_start=0,i.insert=0),de(s),s.avail_out===0))return i.last_flush=-1,we}return we}class Cr{constructor(){this.strm=new ks,this.chunkSize=1024*10*10,this.outputBuffer=new Uint8Array(this.chunkSize),this.windowBits=5,Sr(this.strm,this.windowBits)}deflate(e){this.strm.input=e,this.strm.avail_in=this.strm.input.length,this.strm.next_in=0,this.strm.output=this.outputBuffer,this.strm.avail_out=this.chunkSize,this.strm.next_out=0;let t=zi(this.strm,Hi),i=new Uint8Array(this.strm.output.buffer,0,this.strm.next_out);if(t<0)throw new Error("zlib deflate failed");if(this.strm.avail_in>0){let n=[i],r=i.length;do{if(this.strm.output=new Uint8Array(this.chunkSize),this.strm.next_out=0,this.strm.avail_out=this.chunkSize,t=zi(this.strm,Hi),t<0)throw new Error("zlib deflate failed");let l=new Uint8Array(this.strm.output.buffer,0,this.strm.next_out);r+=l.length,n.push(l)}while(this.strm.avail_in>0);let a=new Uint8Array(r),h=0;for(let l=0;l<n.length;l++)a.set(n[l],h),h+=n[l].length;i=a}return this.strm.input=null,this.strm.avail_in=0,this.strm.next_in=0,i}}const It={DOCUMENT_START:0,DOCUMENT_CHUNK:1,DOCUMENT_END:2},Fr=async s=>{const e=document.createElement("iframe");e.style.display="none",document.body.appendChild(e),e.onload=()=>{setTimeout(()=>{e.focus(),e.contentWindow.print()},1)};const t=new Blob([new Uint8Array(s)],{type:"application/pdf"});e.src=URL.createObjectURL(t)},Er=s=>{let e=0,t=0,i=[];const n=r=>{const a=Array.from(r),h=new Uint8Array(a).buffer,l=new DataView(h),o=l.getUint32(0,!1);switch(o){case It.DOCUMENT_START:e=l.getUint32(4,!1),t=0,console.log(`Downloading document for printing (${e}B)`);break;case It.DOCUMENT_CHUNK:let c=l.getUint32(4,!1),u=new Uint8Array(h,8);t+=c,i.push(...u),console.log(`Downloading document for printing (${t}/${e}B)`);break;case It.DOCUMENT_END:console.log(`Downloaded document for printing (${t}/${e}B)`),Fr(i),t=0,e=0;break;default:console.error(`Unknown packet id: ${o}`);break}};s.subscribeUnixRelay("printer",n)},ee=0,Vi=1,Wi=2,Gi=4,Kr=8,Yi=16,tt=32,it=64,Pt=127,ji=50,Xr=90,Zi=250,Mr=1e3,Rr=1e3,Ar=50;class Dr{constructor(){this._target=null,this._state=Pt,this._tracked=[],this._ignored=[],this._waitingRelease=!1,this._releaseStart=0,this._longpressTimeoutId=null,this._twoTouchTimeoutId=null,this._boundEventHandler=this._eventHandler.bind(this)}attach(e){this.detach(),this._target=e,this._target.addEventListener("touchstart",this._boundEventHandler),this._target.addEventListener("touchmove",this._boundEventHandler),this._target.addEventListener("touchend",this._boundEventHandler),this._target.addEventListener("touchcancel",this._boundEventHandler)}detach(){this._target&&(this._stopLongpressTimeout(),this._stopTwoTouchTimeout(),this._target.removeEventListener("touchstart",this._boundEventHandler),this._target.removeEventListener("touchmove",this._boundEventHandler),this._target.removeEventListener("touchend",this._boundEventHandler),this._target.removeEventListener("touchcancel",this._boundEventHandler),this._target=null)}_eventHandler(e){let t;switch(e.stopPropagation(),e.preventDefault(),e.type){case"touchstart":t=this._touchStart;break;case"touchmove":t=this._touchMove;break;case"touchend":case"touchcancel":t=this._touchEnd;break}for(let i=0;i<e.changedTouches.length;i++){let n=e.changedTouches[i];t.call(this,n.identifier,n.clientX,n.clientY)}}_touchStart(e,t,i){if(this._hasDetectedGesture()||this._state===ee){this._ignored.push(e);return}if(this._tracked.length>0&&Date.now()-this._tracked[0].started>Zi){this._state=ee,this._ignored.push(e);return}if(this._waitingRelease){this._state=ee,this._ignored.push(e);return}switch(this._tracked.push({id:e,started:Date.now(),active:!0,firstX:t,firstY:i,lastX:t,lastY:i,angle:0}),this._tracked.length){case 1:this._startLongpressTimeout();break;case 2:this._state&=-26,this._stopLongpressTimeout();break;case 3:this._state&=-99;break;default:this._state=ee}}_touchMove(e,t,i){let n=this._tracked.find(h=>h.id===e);if(n===void 0)return;n.lastX=t,n.lastY=i;let r=t-n.firstX,a=i-n.firstY;if((n.firstX!==n.lastX||n.firstY!==n.lastY)&&(n.angle=Math.atan2(a,r)*180/Math.PI),!this._hasDetectedGesture()){if(Math.hypot(r,a)<ji)return;if(this._state&=-24,this._stopLongpressTimeout(),this._tracked.length!==1&&(this._state&=-9),this._tracked.length!==2&&(this._state&=-97),this._tracked.length===2){let h=this._tracked.find(o=>o.id!==e);if(Math.hypot(h.firstX-h.lastX,h.firstY-h.lastY)>ji){let o=Math.abs(n.angle-h.angle);o=Math.abs((o+180)%360-180),o>Xr?this._state&=-33:this._state&=-65,this._isTwoTouchTimeoutRunning()&&this._stopTwoTouchTimeout()}else this._isTwoTouchTimeoutRunning()||this._startTwoTouchTimeout()}if(!this._hasDetectedGesture())return;this._pushEvent("gesturestart")}this._pushEvent("gesturemove")}_touchEnd(e,t,i){if(this._ignored.indexOf(e)!==-1){this._ignored.splice(this._ignored.indexOf(e),1),this._ignored.length===0&&this._tracked.length===0&&(this._state=Pt,this._waitingRelease=!1);return}if(!this._hasDetectedGesture()&&this._isTwoTouchTimeoutRunning()&&(this._stopTwoTouchTimeout(),this._state=ee),!this._hasDetectedGesture()&&(this._state&=-105,this._state&=-17,this._stopLongpressTimeout(),!this._waitingRelease))switch(this._releaseStart=Date.now(),this._waitingRelease=!0,this._tracked.length){case 1:this._state&=-7;break;case 2:this._state&=-6;break}if(this._waitingRelease){Date.now()-this._releaseStart>Zi&&(this._state=ee),this._tracked.some(r=>Date.now()-r.started>Mr)&&(this._state=ee);let n=this._tracked.find(r=>r.id===e);if(n.active=!1,this._hasDetectedGesture())this._pushEvent("gesturestart");else if(this._state!==ee)return}this._hasDetectedGesture()&&this._pushEvent("gestureend");for(let n=0;n<this._tracked.length;n++)this._tracked[n].active&&this._ignored.push(this._tracked[n].id);this._tracked=[],this._state=ee,this._ignored.indexOf(e)!==-1&&this._ignored.splice(this._ignored.indexOf(e),1),this._ignored.length===0&&(this._state=Pt,this._waitingRelease=!1)}_hasDetectedGesture(){return!(this._state===ee||this._state&this._state-1||this._state&(Vi|Wi|Gi)&&this._tracked.some(e=>e.active))}_startLongpressTimeout(){this._stopLongpressTimeout(),this._longpressTimeoutId=setTimeout(()=>this._longpressTimeout(),Rr)}_stopLongpressTimeout(){clearTimeout(this._longpressTimeoutId),this._longpressTimeoutId=null}_longpressTimeout(){if(this._hasDetectedGesture())throw new Error("A longpress gesture failed, conflict with a different gesture");this._state=Yi,this._pushEvent("gesturestart")}_startTwoTouchTimeout(){this._stopTwoTouchTimeout(),this._twoTouchTimeoutId=setTimeout(()=>this._twoTouchTimeout(),Ar)}_stopTwoTouchTimeout(){clearTimeout(this._twoTouchTimeoutId),this._twoTouchTimeoutId=null}_isTwoTouchTimeoutRunning(){return this._twoTouchTimeoutId!==null}_twoTouchTimeout(){if(this._tracked.length===0)throw new Error("A pinch or two drag gesture failed, no tracked touches");let e=this._getAverageMovement(),t=Math.abs(e.x),i=Math.abs(e.y),n=this._getAverageDistance(),r=Math.abs(Math.hypot(n.first.x,n.first.y)-Math.hypot(n.last.x,n.last.y));i<r&&t<r?this._state=it:this._state=tt,this._pushEvent("gesturestart"),this._pushEvent("gesturemove")}_pushEvent(e){let t={type:this._stateToGesture(this._state)},i=this._getPosition(),n=i.last;switch(e==="gesturestart"&&(n=i.first),this._state){case tt:case it:n=i.first;break}if(t.clientX=n.x,t.clientY=n.y,this._state===it){let a=this._getAverageDistance();e==="gesturestart"?(t.magnitudeX=a.first.x,t.magnitudeY=a.first.y):(t.magnitudeX=a.last.x,t.magnitudeY=a.last.y)}else if(this._state===tt)if(e==="gesturestart")t.magnitudeX=0,t.magnitudeY=0;else{let a=this._getAverageMovement();t.magnitudeX=a.x,t.magnitudeY=a.y}let r=new CustomEvent(e,{detail:t});this._target.dispatchEvent(r)}_stateToGesture(e){switch(e){case Vi:return"onetap";case Wi:return"twotap";case Gi:return"threetap";case Kr:return"drag";case Yi:return"longpress";case tt:return"twodrag";case it:return"pinch"}throw new Error("Unknown gesture state: "+e)}_getPosition(){if(this._tracked.length===0)throw new Error("Failed to get gesture position, no tracked touches");let e=this._tracked.length,t=0,i=0,n=0,r=0;for(let a=0;a<this._tracked.length;a++)t+=this._tracked[a].firstX,i+=this._tracked[a].firstY,n+=this._tracked[a].lastX,r+=this._tracked[a].lastY;return{first:{x:t/e,y:i/e},last:{x:n/e,y:r/e}}}_getAverageMovement(){if(this._tracked.length===0)throw new Error("Failed to get gesture movement, no tracked touches");let e,t;e=t=0;let i=this._tracked.length;for(let n=0;n<this._tracked.length;n++)e+=this._tracked[n].lastX-this._tracked[n].firstX,t+=this._tracked[n].lastY-this._tracked[n].firstY;return{x:e/i,y:t/i}}_getAverageDistance(){if(this._tracked.length===0)throw new Error("Failed to get gesture distance, no tracked touches");let e=this._tracked[0],t=this._tracked[this._tracked.length-1],i=Math.abs(t.firstX-e.firstX),n=Math.abs(t.firstY-e.firstY),r=Math.abs(t.lastX-e.lastX),a=Math.abs(t.lastY-e.lastY);return{first:{x:i,y:n},last:{x:r,y:a}}}}const ye=!Ns||_s;class Tr{constructor(){this._target=null,this._canvas=document.createElement("canvas"),this._canvas.style.position="fixed",this._canvas.style.zIndex="65535",this._canvas.style.pointerEvents="none",this._canvas.style.visibility="hidden",this._useFallback=ye,this._position={x:0,y:0},this._hotSpot={x:0,y:0},this._eventHandlers={mouseover:this._handleMouseOver.bind(this),mouseleave:this._handleMouseLeave.bind(this),mousemove:this._handleMouseMove.bind(this),mouseup:this._handleMouseUp.bind(this)}}attach(e){if(this._target&&this.detach(),this._target=e,document.body.appendChild(this._canvas),ye){const t={capture:!0,passive:!0};this._target.addEventListener("mouseover",this._eventHandlers.mouseover,t),this._target.addEventListener("mouseleave",this._eventHandlers.mouseleave,t),this._target.addEventListener("mousemove",this._eventHandlers.mousemove,t),this._target.addEventListener("mouseup",this._eventHandlers.mouseup,t)}this.clear()}detach(){if(this._target){if(ye){const e={capture:!0,passive:!0};this._target.removeEventListener("mouseover",this._eventHandlers.mouseover,e),this._target.removeEventListener("mouseleave",this._eventHandlers.mouseleave,e),this._target.removeEventListener("mousemove",this._eventHandlers.mousemove,e),this._target.removeEventListener("mouseup",this._eventHandlers.mouseup,e)}document.body.removeChild(this._canvas),this._target=null}}change(e,t,i,n,r){if(n===0||r===0){this.clear();return}this._position.x=this._position.x+this._hotSpot.x-t,this._position.y=this._position.y+this._hotSpot.y-i,this._hotSpot.x=t,this._hotSpot.y=i;let a=this._canvas.getContext("2d");this._canvas.width=n,this._canvas.height=r;let h=new ImageData(new Uint8ClampedArray(e),n,r);if(a.clearRect(0,0,n,r),a.putImageData(h,0,0),(this._useFallback||ye)&&this._updatePosition(),!ye){let l=this._canvas.toDataURL();this._target.style.cursor="url("+l+")"+t+" "+i+", default"}}clear(){this._target.style.cursor="none",this._canvas.width=0,this._canvas.height=0,this._position.x=this._position.x+this._hotSpot.x,this._position.y=this._position.y+this._hotSpot.y,this._hotSpot.x=0,this._hotSpot.y=0}move(e,t){if(!this._useFallback)return;window.visualViewport?(this._position.x=e+window.visualViewport.offsetLeft,this._position.y=t+window.visualViewport.offsetTop):(this._position.x=e,this._position.y=t),this._updatePosition();let i=document.elementFromPoint(e,t);this._updateVisibility(i)}setEmulateCursor(e){ye||(this._useFallback=e,this._useFallback?this._showCursor():this._hideCursor())}_handleMouseOver(e){this._handleMouseMove(e)}_handleMouseLeave(e){this._updateVisibility(e.relatedTarget)}_handleMouseMove(e){this._updateVisibility(e.target),this._position.x=e.clientX-this._hotSpot.x,this._position.y=e.clientY-this._hotSpot.y,this._updatePosition()}_handleMouseUp(e){let t=document.elementFromPoint(e.clientX,e.clientY);this._updateVisibility(t),this._captureIsActive()&&window.setTimeout(()=>{this._target&&(t=document.elementFromPoint(e.clientX,e.clientY),this._updateVisibility(t))},0)}_showCursor(){this._canvas.style.visibility==="hidden"&&(this._canvas.style.visibility="")}_hideCursor(){this._canvas.style.visibility!=="hidden"&&(this._canvas.style.visibility="hidden")}_shouldShowCursor(e){return e?e===this._target?!0:!(!this._target.contains(e)||window.getComputedStyle(e).cursor!=="none"):!1}_updateVisibility(e){this._captureIsActive()&&(e=document.captureElement),this._shouldShowCursor(e)?this._showCursor():this._hideCursor()}_updatePosition(){this._canvas.style.left=this._position.x+"px",this._canvas.style.top=this._position.y+"px"}_captureIsActive(){return document.captureElement&&document.documentElement.contains(document.captureElement)}}const Ut=40*1024*1024,$i={CONNECTING:"connecting",OPEN:"open"},st={CONNECTING:[WebSocket.CONNECTING,$i.CONNECTING],OPEN:[WebSocket.OPEN,$i.OPEN]},qi=["send","close","binaryType","onerror","onmessage","onopen","protocol","readyState"];class Lr{constructor(){this._websocket=null,this._rQi=0,this._rQlen=0,this._rQbufferSize=1024*1024*4,this._rQ=null,this._sQbufferSize=1024*10,this._sQlen=0,this._sQ=null,this._eventHandlers={message:()=>{},open:()=>{},close:()=>{},error:()=>{}}}get sQ(){return this._sQ}get rQ(){return this._rQ}get rQi(){return this._rQi}set rQi(e){this._rQi=e}get rQlen(){return this._rQlen-this._rQi}rQpeek8(){return this._rQ[this._rQi]}rQskipBytes(e){this._rQi+=e}rQshift8(){return this._rQshift(1)}rQshift16(){return this._rQshift(2)}rQshift32(){return this._rQshift(4)}_rQshift(e){let t=0;for(let i=e-1;i>=0;i--)t+=this._rQ[this._rQi++]<<i*8;return t}rQshiftStr(e){typeof e>"u"&&(e=this.rQlen);let t="";for(let i=0;i<e;i+=4096){let n=this.rQshiftBytes(Math.min(4096,e-i));t+=String.fromCharCode.apply(null,n)}return t}rQshiftBytes(e){return typeof e>"u"&&(e=this.rQlen),this._rQi+=e,new Uint8Array(this._rQ.buffer,this._rQi-e,e)}rQshiftTo(e,t){t===void 0&&(t=this.rQlen),e.set(new Uint8Array(this._rQ.buffer,this._rQi,t)),this._rQi+=t}rQslice(e,t=this.rQlen){return new Uint8Array(this._rQ.buffer,this._rQi+e,t-e)}rQwait(e,t,i){if(this.rQlen<t){if(i){if(this._rQi<i)throw new Error("rQwait cannot backup "+i+" bytes");this._rQi-=i}return!0}return!1}flush(){this._sQlen>0&&st.OPEN.indexOf(this._websocket.readyState)>=0&&(this._websocket.send(this._encodeMessage()),this._sQlen=0)}send(e){this._sQ.set(e,this._sQlen),this._sQlen+=e.length,this.flush()}sendString(e){this.send(e.split("").map(t=>t.charCodeAt(0)))}off(e){this._eventHandlers[e]=()=>{}}on(e,t){this._eventHandlers[e]=t}_allocateBuffers(){this._rQ=new Uint8Array(this._rQbufferSize),this._sQ=new Uint8Array(this._sQbufferSize)}init(){this._allocateBuffers(),this._rQi=0,this._websocket=null}open(e,t){this.attach(new WebSocket(e,t))}attach(e){this.init();const t=[...Object.keys(e),...Object.getOwnPropertyNames(Object.getPrototypeOf(e))];for(let r=0;r<qi.length;r++){const a=qi[r];if(t.indexOf(a)<0)throw new Error("Raw channel missing property: "+a)}this._websocket=e,this._websocket.binaryType="arraybuffer",this._websocket.onmessage=this._recvMessage.bind(this);const i=()=>{C(">> WebSock.onopen"),this._websocket.protocol&&I("Server choose sub-protocol: "+this._websocket.protocol),this._eventHandlers.open(),C("<< WebSock.onopen")};st.OPEN.indexOf(this._websocket.readyState)>=0?i():this._websocket.onopen=i,this._websocket.onclose=r=>{C(">> WebSock.onclose"),this._eventHandlers.close(r),C("<< WebSock.onclose")},this._websocket.onerror=r=>{C(">> WebSock.onerror: "+r),this._eventHandlers.error(r),C("<< WebSock.onerror: "+r)}}close(){this._websocket&&((st.CONNECTING.indexOf(this._websocket.readyState)>=0||st.OPEN.indexOf(this._websocket.readyState)>=0)&&(I("Closing WebSocket connection"),this._websocket.close()),this._websocket.onmessage=()=>{})}_encodeMessage(){return new Uint8Array(this._sQ.buffer,0,this._sQlen)}_expandCompactRQ(e){const t=(this._rQlen-this._rQi+e)*8,i=this._rQbufferSize<t;if(i&&(this._rQbufferSize=Math.max(this._rQbufferSize*2,t)),this._rQbufferSize>Ut&&(this._rQbufferSize=Ut,this._rQbufferSize-this.rQlen<e))throw new Error("Receive Queue buffer exceeded "+Ut+" bytes, and the new message could not fit");if(i){const n=this._rQ.buffer;this._rQ=new Uint8Array(this._rQbufferSize),this._rQ.set(new Uint8Array(n,this._rQi,this._rQlen-this._rQi))}else this._rQ.copyWithin(0,this._rQi,this._rQlen);this._rQlen=this._rQlen-this._rQi,this._rQi=0}_DecodeMessage(e){const t=new Uint8Array(e);t.length>this._rQbufferSize-this._rQlen&&this._expandCompactRQ(t.length),this._rQ.set(t,this._rQlen),this._rQlen+=t.length}_insertIntoMiddle(e){const t=new Uint8Array(e);t.length>this._rQbufferSize-this._rQlen&&this._expandCompactRQ(t.length),this._rQ.copyWithin(this._rQi+t.length,this._rQi,this._rQlen-this._rQi),this._rQ.set(t,this._rQi),this._rQlen+=t.length}_recvMessage(e){this._DecodeMessage(e.data),this.rQlen>0?(this._eventHandlers.message(),this._rQlen==this._rQi&&(this._rQlen=0,this._rQi=0)):C("Ignoring empty message")}}const Ji=[13,16,10,23,0,4,2,27,14,5,20,9,22,18,11,3,25,7,15,6,26,19,12,1,40,51,30,36,46,54,29,39,50,44,32,47,43,48,38,55,33,52,45,41,49,35,28,31],Qr=[1,2,4,6,8,10,12,14,15,17,19,21,23,25,27,28],d=0;let g,b,w,m,y,k;g=65536;b=1<<24;w=g|b;m=4;y=1024;k=m|y;const es=[w|y,d|d,g|d,w|k,w|m,g|k,d|m,g|d,d|y,w|y,w|k,d|y,b|k,w|m,b|d,d|m,d|k,b|y,b|y,g|y,g|y,w|d,w|d,b|k,g|m,b|m,b|m,g|m,d|d,d|k,g|k,b|d,g|d,w|k,d|m,w|d,w|y,b|d,b|d,d|y,w|m,g|d,g|y,b|m,d|y,d|m,b|k,g|k,w|k,g|m,w|d,b|k,b|m,d|k,g|k,w|y,d|k,b|y,b|y,d|d,g|m,g|y,d|d,w|m];g=1<<20;b=1<<31;w=g|b;m=32;y=32768;k=m|y;const ts=[w|k,b|y,d|y,g|k,g|d,d|m,w|m,b|k,b|m,w|k,w|y,b|d,b|y,g|d,d|m,w|m,g|y,g|m,b|k,d|d,b|d,d|y,g|k,w|d,g|m,b|m,d|d,g|y,d|k,w|y,w|d,d|k,d|d,g|k,w|m,g|d,b|k,w|d,w|y,d|y,w|d,b|y,d|m,w|k,g|k,d|m,d|y,b|d,d|k,w|y,g|d,b|m,g|m,b|k,b|m,g|m,g|y,d|d,b|y,d|k,b|d,w|m,w|k,g|y];g=1<<17;b=1<<27;w=g|b;m=8;y=512;k=m|y;const is=[d|k,w|y,d|d,w|m,b|y,d|d,g|k,b|y,g|m,b|m,b|m,g|d,w|k,g|m,w|d,d|k,b|d,d|m,w|y,d|y,g|y,w|d,w|m,g|k,b|k,g|y,g|d,b|k,d|m,w|k,d|y,b|d,w|y,b|d,g|m,d|k,g|d,w|y,b|y,d|d,d|y,g|m,w|k,b|y,b|m,d|y,d|d,w|m,b|k,g|d,b|d,w|k,d|m,g|k,g|y,b|m,w|d,b|k,d|k,w|d,g|k,d|m,w|m,g|y];g=8192;b=1<<23;w=g|b;m=1;y=128;k=m|y;const ss=[w|m,g|k,g|k,d|y,w|y,b|k,b|m,g|m,d|d,w|d,w|d,w|k,d|k,d|d,b|y,b|m,d|m,g|d,b|d,w|m,d|y,b|d,g|m,g|y,b|k,d|m,g|y,b|y,g|d,w|y,w|k,d|k,b|y,b|m,w|d,w|k,d|k,d|d,d|d,w|d,g|y,b|y,b|k,d|m,w|m,g|k,g|k,d|y,w|k,d|k,d|m,g|d,b|m,g|m,w|y,b|k,g|m,g|y,b|d,w|m,d|y,b|d,g|d,w|y];g=1<<25;b=1<<30;w=g|b;m=256;y=1<<19;k=m|y;const ns=[d|m,g|k,g|y,w|m,d|y,d|m,b|d,g|y,b|k,d|y,g|m,b|k,w|m,w|y,d|k,b|d,g|d,b|y,b|y,d|d,b|m,w|k,w|k,g|m,w|y,b|m,d|d,w|d,g|k,g|d,w|d,d|k,d|y,w|m,d|m,g|d,b|d,g|y,w|m,b|k,g|m,b|d,w|y,g|k,b|k,d|m,g|d,w|y,w|k,d|k,w|d,w|k,g|y,d|d,b|y,w|d,d|k,g|m,b|m,d|y,d|d,b|y,g|k,b|m];g=1<<22;b=1<<29;w=g|b;m=16;y=16384;k=m|y;const rs=[b|m,w|d,d|y,w|k,w|d,d|m,w|k,g|d,b|y,g|k,g|d,b|m,g|m,b|y,b|d,d|k,d|d,g|m,b|k,d|y,g|y,b|k,d|m,w|m,w|m,d|d,g|k,w|y,d|k,g|y,w|y,b|d,b|y,d|m,w|m,g|y,w|k,g|d,d|k,b|m,g|d,b|y,b|d,d|k,b|m,w|k,g|y,w|d,g|k,w|y,d|d,w|m,d|m,d|y,w|d,g|k,d|y,g|m,b|k,d|d,w|y,b|d,g|m,b|k];g=1<<21;b=1<<26;w=g|b;m=2;y=2048;k=m|y;const as=[g|d,w|m,b|k,d|d,d|y,b|k,g|k,w|y,w|k,g|d,d|d,b|m,d|m,b|d,w|m,d|k,b|y,g|k,g|m,b|y,b|m,w|d,w|y,g|m,w|d,d|y,d|k,w|k,g|y,d|m,b|d,g|y,b|d,g|y,g|d,b|k,b|k,w|m,w|m,d|m,g|m,b|d,b|y,g|d,w|y,d|k,g|k,w|y,d|k,b|m,w|k,w|d,g|y,d|d,d|m,w|k,d|d,g|k,w|d,d|y,b|m,b|y,d|y,g|m];g=1<<18;b=1<<28;w=g|b;m=64;y=4096;k=m|y;const os=[b|k,d|y,g|d,w|k,b|d,b|k,d|m,b|d,g|m,w|d,w|k,g|y,w|y,g|k,d|y,d|m,w|d,b|m,b|y,d|k,g|y,g|m,w|m,w|y,d|k,d|d,d|d,w|m,b|m,b|y,g|k,g|d,g|k,g|d,w|y,d|y,d|m,w|m,d|y,g|k,b|y,d|m,b|m,w|d,w|m,b|d,g|d,b|k,d|d,w|k,g|m,b|m,w|d,b|y,b|k,d|d,w|k,g|y,g|y,d|k,d|k,g|m,b|d,w|y];class Ir{constructor(e){this.keys=[];const t=[],i=[],n=[];for(let r=0,a=56;r<56;++r,a-=8){a+=a<-5?65:a<-3?31:a<-1?63:a===27?35:0;const h=a&7;t[r]=(e[a>>>3]&1<<h)!==0?1:0}for(let r=0;r<16;++r){const a=r<<1,h=a+1;n[a]=n[h]=0;for(let l=28;l<59;l+=28)for(let o=l-28;o<l;++o){const c=o+Qr[r];i[o]=c<l?t[c]:t[c-28]}for(let l=0;l<24;++l)i[Ji[l]]!==0&&(n[a]|=1<<23-l),i[Ji[l+24]]!==0&&(n[h]|=1<<23-l)}for(let r=0,a=0,h=0;r<16;++r){const l=n[a++],o=n[a++];this.keys[h]=(l&16515072)<<6,this.keys[h]|=(l&4032)<<10,this.keys[h]|=(o&16515072)>>>10,this.keys[h]|=(o&4032)>>>6,++h,this.keys[h]=(l&258048)<<12,this.keys[h]|=(l&63)<<16,this.keys[h]|=(o&258048)>>>4,this.keys[h]|=o&63,++h}}enc8(e){const t=e.slice();let i=0,n,r,a;n=t[i++]<<24|t[i++]<<16|t[i++]<<8|t[i++],r=t[i++]<<24|t[i++]<<16|t[i++]<<8|t[i++],a=(n>>>4^r)&252645135,r^=a,n^=a<<4,a=(n>>>16^r)&65535,r^=a,n^=a<<16,a=(r>>>2^n)&858993459,n^=a,r^=a<<2,a=(r>>>8^n)&16711935,n^=a,r^=a<<8,r=r<<1|r>>>31&1,a=(n^r)&2863311530,n^=a,r^=a,n=n<<1|n>>>31&1;for(let h=0,l=0;h<8;++h){a=r<<28|r>>>4,a^=this.keys[l++];let o=as[a&63];o|=ns[a>>>8&63],o|=is[a>>>16&63],o|=es[a>>>24&63],a=r^this.keys[l++],o|=os[a&63],o|=rs[a>>>8&63],o|=ss[a>>>16&63],o|=ts[a>>>24&63],n^=o,a=n<<28|n>>>4,a^=this.keys[l++],o=as[a&63],o|=ns[a>>>8&63],o|=is[a>>>16&63],o|=es[a>>>24&63],a=n^this.keys[l++],o|=os[a&63],o|=rs[a>>>8&63],o|=ss[a>>>16&63],o|=ts[a>>>24&63],r^=o}for(r=r<<31|r>>>1,a=(n^r)&2863311530,n^=a,r^=a,n=n<<31|n>>>1,a=(n>>>8^r)&16711935,r^=a,n^=a<<8,a=(n>>>2^r)&858993459,r^=a,n^=a<<2,a=(r>>>16^n)&65535,n^=a,r^=a<<16,a=(r>>>4^n)&252645135,n^=a,r^=a<<4,a=[r,n],i=0;i<8;i++)t[i]=(a[i>>>2]>>>8*(3-i%4))%256,t[i]<0&&(t[i]+=256);return t}encrypt(e){return this.enc8(e.slice(0,8)).concat(this.enc8(e.slice(8,16)))}}const Pr={Again:57349,AltLeft:56,AltRight:57400,ArrowDown:57424,ArrowLeft:57419,ArrowRight:57421,ArrowUp:57416,AudioVolumeDown:57390,AudioVolumeMute:57376,AudioVolumeUp:57392,Backquote:41,Backslash:43,Backspace:14,BracketLeft:26,BracketRight:27,BrowserBack:57450,BrowserFavorites:57446,BrowserForward:57449,BrowserHome:57394,BrowserRefresh:57447,BrowserSearch:57445,BrowserStop:57448,CapsLock:58,Comma:51,ContextMenu:57437,ControlLeft:29,ControlRight:57373,Convert:121,Copy:57464,Cut:57404,Delete:57427,Digit0:11,Digit1:2,Digit2:3,Digit3:4,Digit4:5,Digit5:6,Digit6:7,Digit7:8,Digit8:9,Digit9:10,Eject:57469,End:57423,Enter:28,Equal:13,Escape:1,F1:59,F10:68,F11:87,F12:88,F13:93,F14:94,F15:95,F16:85,F17:57347,F18:57463,F19:57348,F2:60,F20:90,F21:116,F22:57465,F23:109,F24:111,F3:61,F4:62,F5:63,F6:64,F7:65,F8:66,F9:67,Find:57409,Help:57461,Hiragana:119,Home:57415,Insert:57426,IntlBackslash:86,IntlRo:115,IntlYen:125,KanaMode:112,Katakana:120,KeyA:30,KeyB:48,KeyC:46,KeyD:32,KeyE:18,KeyF:33,KeyG:34,KeyH:35,KeyI:23,KeyJ:36,KeyK:37,KeyL:38,KeyM:50,KeyN:49,KeyO:24,KeyP:25,KeyQ:16,KeyR:19,KeyS:31,KeyT:20,KeyU:22,KeyV:47,KeyW:17,KeyX:45,KeyY:21,KeyZ:44,Lang1:114,Lang2:113,Lang3:120,Lang4:119,Lang5:118,LaunchApp1:57451,LaunchApp2:57377,LaunchMail:57452,MediaPlayPause:57378,MediaSelect:57453,MediaStop:57380,MediaTrackNext:57369,MediaTrackPrevious:57360,MetaLeft:57435,MetaRight:57436,Minus:12,NonConvert:123,NumLock:69,Numpad0:82,Numpad1:79,Numpad2:80,Numpad3:81,Numpad4:75,Numpad5:76,Numpad6:77,Numpad7:71,Numpad8:72,Numpad9:73,NumpadAdd:78,NumpadComma:126,NumpadDecimal:83,NumpadDivide:57397,NumpadEnter:57372,NumpadEqual:89,NumpadMultiply:55,NumpadParenLeft:57462,NumpadParenRight:57467,NumpadSubtract:74,Open:100,PageDown:57425,PageUp:57417,Paste:101,Pause:57414,Period:52,Power:57438,PrintScreen:84,Props:57350,Quote:40,ScrollLock:70,Semicolon:39,ShiftLeft:42,ShiftRight:54,Slash:53,Sleep:57439,Space:57,Suspend:57381,Tab:15,Undo:57351,WakeUp:57443},X={encodingRaw:0,encodingCopyRect:1,encodingRRE:2,encodingHextile:5,encodingTight:7,encodingTightPNG:-260,encodingUDP:-261,pseudoEncodingQualityLevel0:-32,pseudoEncodingDesktopSize:-223,pseudoEncodingLastRect:-224,pseudoEncodingCursor:-239,pseudoEncodingQEMUExtendedKeyEvent:-258,pseudoEncodingDesktopName:-307,pseudoEncodingExtendedDesktopSize:-308,pseudoEncodingXvp:-309,pseudoEncodingFence:-312,pseudoEncodingContinuousUpdates:-313,pseudoEncodingCompressLevel0:-256,pseudoEncodingWEBP:-1024,pseudoEncodingJpegVideoQualityLevel0:-1023,pseudoEncodingWebpVideoQualityLevel0:-1013,pseudoEncodingTreatLosslessLevel0:-1003,pseudoEncodingPreferBandwidth:-992,pseudoEncodingDynamicQualityMinLevel0:-991,pseudoEncodingDynamicQualityMaxLevel0:-981,pseudoEncodingVideoAreaLevel1:-971,pseudoEncodingVideoTimeLevel0:-870,pseudoEncodingFrameRateLevel10:-2048,pseudoEncodingMaxVideoResolution:-1997,pseudoEncodingVideoScalingLevel0:-1996,pseudoEncodingVideoOutTimeLevel1:-1986,pseudoEncodingQOI:-1886,pseudoEncodingVMwareCursor:1464686180,pseudoEncodingVMwareCursorPosition:1464686182,pseudoEncodingExtendedClipboard:3231835598},ta={LEFT_BUTTON:1,MIDDLE_BUTTON:2,RIGHT_BUTTON:3,BACK_BUTTON:8,FORWARD_BUTTON:9};function nt(s){return 1<<s-1}class ia{constructor(){this.map=new Map}get(e){return this.map.has(e)?this.map.get(e):e}set(e,t){return this.map.set(e,t)}delete(e){return this.map.delete(e)}dump(){return JSON.stringify(this.map,this._replacer)}load(e){this.map=JSON.parse(e,this._reviver)}_replacer(e,t){return t instanceof Map?{dataType:"Map",value:Array.from(t.entries())}:t}_reviver(e,t){return typeof t=="object"&&t!==null&&t.dataType==="Map"?new Map(t.value):t}}class Ur{constructor(){this._lines=0}decodeRect(e,t,i,n,r,a,h,l){if(i===0||n===0)return!0;this._lines===0&&(this._lines=n);const o=h==8?1:4,c=i*o;if(r.rQwait("RAW",c))return!1;const u=t+(n-this._lines),x=Math.min(this._lines,Math.floor(r.rQlen/c)),f=i*x;let p=r.rQ,F=r.rQi;if(h==8){const E=new Uint8Array(f*4);for(let K=0;K<f;K++)E[K*4+0]=(p[F+K]>>0&3)*255/3,E[K*4+1]=(p[F+K]>>2&3)*255/3,E[K*4+2]=(p[F+K]>>4&3)*255/3,E[K*4+3]=255;p=E,F=0}for(let E=0;E<f;E++)p[E*4+3]=255;return a.blitImage(e,u,i,x,p,F,l),r.rQskipBytes(x*c),this._lines-=x,!(this._lines>0)}}class Br{decodeRect(e,t,i,n,r,a,h,l){if(r.rQwait("COPYRECT",4))return!1;let o=r.rQshift16(),c=r.rQshift16();return i===0||n===0||a.copyImage(o,c,e,t,i,n,l),!0}}class Hr{constructor(){this._subrects=0}decodeRect(e,t,i,n,r,a,h,l){if(this._subrects===0){if(r.rQwait("RRE",8))return!1;this._subrects=r.rQshift32();let o=r.rQshiftBytes(4);a.fillRect(e,t,i,n,o)}for(;this._subrects>0;){if(r.rQwait("RRE",12))return!1;let o=r.rQshiftBytes(4),c=r.rQshift16(),u=r.rQshift16(),x=r.rQshift16(),f=r.rQshift16();a.fillRect(e+c,t+u,x,f,o,l),this._subrects--}return!0}}class Nr{constructor(){this._tiles=0,this._lastsubencoding=0,this._tileBuffer=new Uint8Array(16*16*4)}decodeRect(e,t,i,n,r,a,h,l){for(this._tiles===0&&(this._tilesX=Math.ceil(i/16),this._tilesY=Math.ceil(n/16),this._totalTiles=this._tilesX*this._tilesY,this._tiles=this._totalTiles);this._tiles>0;){let o=1;if(r.rQwait("HEXTILE",o))return!1;let c=r.rQ,u=r.rQi,x=c[u];if(x>30)throw new Error("Illegal hextile subencoding (subencoding: "+x+")");const f=this._totalTiles-this._tiles,p=f%this._tilesX,F=Math.floor(f/this._tilesX),E=e+p*16,K=t+F*16,Q=Math.min(16,e+i-E),D=Math.min(16,t+n-K);if(x&1)o+=Q*D*4;else if(x&2&&(o+=4),x&4&&(o+=4),x&8){if(o++,r.rQwait("HEXTILE",o))return!1;let S=c[u+o-1];x&16?o+=S*6:o+=S*2}if(r.rQwait("HEXTILE",o))return!1;if(u++,x===0)this._lastsubencoding&1?C("     Ignoring blank after RAW"):a.fillRect(E,K,Q,D,this._background,l);else if(x&1){let S=Q*D;for(let L=0;L<S;L++)c[u+L*4+3]=255;a.blitImage(E,K,Q,D,c,u,l),u+=o-1}else{if(x&2&&(this._background=[c[u],c[u+1],c[u+2],c[u+3]],u+=4),x&4&&(this._foreground=[c[u],c[u+1],c[u+2],c[u+3]],u+=4),this._startTile(E,K,Q,D,this._background),x&8){let S=c[u];u++;for(let L=0;L<S;L++){let z;x&16?(z=[c[u],c[u+1],c[u+2],c[u+3]],u+=4):z=this._foreground;const M=c[u];u++;const B=M>>4,H=M&15,T=c[u];u++;const W=(T>>4)+1,te=(T&15)+1;this._subTile(B,H,W,te,z)}}this._finishTile(a,l)}r.rQi=u,this._lastsubencoding=x,this._tiles--}return!0}_startTile(e,t,i,n,r){this._tileX=e,this._tileY=t,this._tileW=i,this._tileH=n;const a=r[0],h=r[1],l=r[2],o=this._tileBuffer;for(let c=0;c<i*n*4;c+=4)o[c]=a,o[c+1]=h,o[c+2]=l,o[c+3]=255}_subTile(e,t,i,n,r){const a=r[0],h=r[1],l=r[2],o=e+i,c=t+n,u=this._tileBuffer,x=this._tileW;for(let f=t;f<c;f++)for(let p=e;p<o;p++){const F=(p+f*x)*4;u[F]=a,u[F+1]=h,u[F+2]=l,u[F+3]=255}}_finishTile(e,t){e.blitImage(this._tileX,this._tileY,this._tileW,this._tileH,this._tileBuffer,0,t)}}class Hs{constructor(e){this._ctl=null,this._filter=null,this._numColors=0,this._palette=new Uint8Array(1024),this._len=0,this._enableQOI=!1,this._displayGlobal=e,this._lastTransparentRectHash="",this._lastTransparentRectInfo="",this._zlibs=[];for(let t=0;t<4;t++)this._zlibs[t]=new ut;this._itzlib=new ut}get enableQOI(){return this._enableQOI}set enableQOI(e){this._enableQOI!==e&&(e?this._enableQOI=this._enableQOIWorkers():(this._enableQOI=!1,this._disableQOIWorkers()))}decodeRect(e,t,i,n,r,a,h,l){if(this._ctl===null){if(r.rQwait("TIGHT compression-control",1))return!1;this._ctl=r.rQshift8();for(let c=0;c<4;c++)this._ctl>>c&1&&(this._zlibs[c].reset(),I("Reset zlib stream "+c));this._ctl=this._ctl>>4}let o;if(this._ctl===8)o=this._fillRect(e,t,i,n,r,a,h,l);else if(this._ctl===9)o=this._jpegRect(e,t,i,n,r,a,h,l);else if(this._ctl===10)o=this._pngRect(e,t,i,n,r,a,h,l);else if((this._ctl&8)==0)o=this._basicRect(this._ctl,e,t,i,n,r,a,h,l);else if(this._ctl===11)o=this._webpRect(e,t,i,n,r,a,h,l);else if(this._ctl===12)o=this._qoiRect(e,t,i,n,r,a,h,l);else if(this._ctl===13)o=this._itRect(e,t,i,n,r,a,h,l);else throw new Error("Illegal tight compression received (ctl: "+this._ctl+")");return o&&(this._ctl=null),o}_fillRect(e,t,i,n,r,a,h,l){if(r.rQwait("TIGHT",3))return!1;const o=r.rQi,c=r.rQ;return a.fillRect(e,t,i,n,[c[o],c[o+1],c[o+2]],l,!1),r.rQskipBytes(3),!0}_jpegRect(e,t,i,n,r,a,h,l){let o=this._readData(r);return o===null?!1:(a.imageRect(e,t,i,n,"image/jpeg",o,l),!0)}_webpRect(e,t,i,n,r,a,h,l){let o=this._readData(r);return o===null?!1:(a.imageRect(e,t,i,n,"image/webp",o,l),!0)}_processRectQ(){for(;this._availableWorkers.length>0&&this._qoiRects.length>0;){let t=this._availableWorkers.pop(),i=this._workers[t],n=this._qoiRects.shift();var e=new ArrayBuffer(n.data.length);new Uint8Array(e).set(new Uint8Array(n.data)),i.postMessage({x:n.x,y:n.y,width:n.width,height:n.height,depth:n.depth,frame_id:n.frame_id,image:e},[e])}}_qoiRect(e,t,i,n,r,a,h,l){let o=this._readData(r);if(o===null)return!1;if(this._enableQOI){let c=new Uint8Array(o),u={x:e,y:t,width:i,height:n,data:c,depth:h,frame_id:l};this._qoiRects.length<1e3?(this._qoiRects.push(u),this._processRectQ()):(V("QOI queue exceeded limit."),this._qoiRects.splice(0,500))}return!0}_itRect(e,t,i,n,r,a,h,l){let o=this._readData(r);if(o===null)return!1;let c=Ae(o),u=`${e}.${t}.${i}.${n}`;if(c===this._lastTransparentRectHash&&u===this._lastTransparentRectInfo)a.dummyRect(e,t,i,n,l);else{const x=o[0],f=o[1],p=o[2],F=o[3],E=Math.floor(i*n/2+1);this._itzlib.reset(),this._itzlib.setInput(o.slice(4)),o=this._itzlib.inflate(E),this._itzlib.setInput(null);let K=new Uint8Array(i*n*4+4);for(let D=0,S=0;D<E;D++,S+=8){let L=o[D];K[S+0]=x,K[S+1]=f,K[S+2]=p,K[S+3]=F*((L&15)<<4)/255,K[S+4]=x,K[S+5]=f,K[S+6]=p,K[S+7]=F*(L&240)/255}let Q=new ImageData(new Uint8ClampedArray(K.buffer,0,i*n*4),i,n);a.transparentRect(e,t,i,n,Q,l,c),this._lastTransparentRectHash=c,this._lastTransparentRectInfo=u}return!0}_pngRect(e,t,i,n,r,a,h,l){throw new Error("PNG received in standard Tight rect")}_basicRect(e,t,i,n,r,a,h,l,o){if(this._filter===null)if(e&4){if(a.rQwait("TIGHT",1))return!1;this._filter=a.rQshift8()}else this._filter=0;let c=e&3,u;switch(this._filter){case 0:u=this._copyFilter(c,t,i,n,r,a,h,l,o);break;case 1:u=this._paletteFilter(c,t,i,n,r,a,h,l,o);break;case 2:u=this._gradientFilter(c,t,i,n,r,a,h,l,o);break;default:throw new Error("Illegal tight filter received (ctl: "+this._filter+")")}return u&&(this._filter=null),u}_copyFilter(e,t,i,n,r,a,h,l,o){const c=n*r*3;let u;if(c===0)return!0;if(c<12){if(a.rQwait("TIGHT",c))return!1;u=a.rQshiftBytes(c)}else{if(u=this._readData(a),u===null)return!1;this._zlibs[e].setInput(u),u=this._zlibs[e].inflate(c),this._zlibs[e].setInput(null)}let x=new Uint8Array(n*r*4);for(let f=0,p=0;f<n*r*4;f+=4,p+=3)x[f]=u[p],x[f+1]=u[p+1],x[f+2]=u[p+2],x[f+3]=255;return h.blitImage(t,i,n,r,x,0,o,!1),!0}_paletteFilter(e,t,i,n,r,a,h,l,o){if(this._numColors===0){if(a.rQwait("TIGHT palette",1))return!1;const p=a.rQpeek8()+1,F=p*3;if(a.rQwait("TIGHT palette",1+F))return!1;this._numColors=p,a.rQskipBytes(1),a.rQshiftTo(this._palette,F)}const c=this._numColors<=2?1:8,x=Math.floor((n*c+7)/8)*r;let f;if(x===0)return!0;if(x<12){if(a.rQwait("TIGHT",x))return!1;f=a.rQshiftBytes(x)}else{if(f=this._readData(a),f===null)return!1;this._zlibs[e].setInput(f),f=this._zlibs[e].inflate(x),this._zlibs[e].setInput(null)}return this._numColors==2?this._monoRect(t,i,n,r,f,this._palette,h,o):this._paletteRect(t,i,n,r,f,this._palette,h,o),this._numColors=0,!0}_monoRect(e,t,i,n,r,a,h,l){const o=this._getScratchBuffer(i*n*4),c=Math.floor((i+7)/8),u=Math.floor(i/8);for(let x=0;x<n;x++){let f,p,F;for(F=0;F<u;F++)for(let E=7;E>=0;E--)f=(x*i+F*8+7-E)*4,p=(r[x*c+F]>>E&1)*3,o[f]=a[p],o[f+1]=a[p+1],o[f+2]=a[p+2],o[f+3]=255;for(let E=7;E>=8-i%8;E--)f=(x*i+F*8+7-E)*4,p=(r[x*c+F]>>E&1)*3,o[f]=a[p],o[f+1]=a[p+1],o[f+2]=a[p+2],o[f+3]=255}h.blitImage(e,t,i,n,o,0,l,!1)}_paletteRect(e,t,i,n,r,a,h,l){const o=this._getScratchBuffer(i*n*4),c=i*n*4;for(let u=0,x=0;u<c;u+=4,x++){const f=r[x]*3;o[u]=a[f],o[u+1]=a[f+1],o[u+2]=a[f+2],o[u+3]=255}h.blitImage(e,t,i,n,o,0,l,!1)}_gradientFilter(e,t,i,n,r,a,h,l,o){throw new Error("Gradient filter not implemented")}_readData(e){if(this._len===0){if(e.rQwait("TIGHT",3))return null;let i;i=e.rQshift8(),this._len=i&127,i&128&&(i=e.rQshift8(),this._len|=(i&127)<<7,i&128&&(i=e.rQshift8(),this._len|=i<<14))}if(e.rQwait("TIGHT",this._len))return null;let t=e.rQshiftBytes(this._len);return this._len=0,t}_getScratchBuffer(e){return(!this._scratchBuffer||this._scratchBuffer.length<e)&&(this._scratchBuffer=new Uint8Array(e)),this._scratchBuffer}async _disableQOIWorkers(){if(this._workers){this._enableQOI=!1,this._availableWorkers=null,this._qoiRects=null,this._rectQlooping=null;for await(let e of Array.from(Array(this._threads).keys()))this._workers[e].terminate(),delete this._workers[e];this._workers=null}}_enableQOIWorkers(){let e=window.location.pathname,t=e.substring(0,e.lastIndexOf("/")+1);window.navigator.hardwareConcurrency&&window.navigator.hardwareConcurrency>=4?this._threads=16:this._threads=8,this._workers=[],this._availableWorkers=[],this._qoiRects=[],this._rectQlooping=!1;for(let i=0;i<this._threads;i++)this._workers.push(new Worker("core/decoders/qoi/decoder.js")),this._workers[i].onmessage=n=>{switch(this._availableWorkers.push(i),n.data.result){case 0:n.data.freemem=null;let r=new Uint8ClampedArray(n.data.data),a=new ImageData(r,n.data.img.width,n.data.img.height,{colorSpace:n.data.img.colorSpace});this._displayGlobal.blitQoi(n.data.x,n.data.y,n.data.width,n.data.height,a,0,n.data.frame_id,!1),this._processRectQ(),this._workers[i].postMessage({freemem:n.data.data});break;case 1:I("QOI Worker is now available.");break;case 2:I("Error on worker: "+n.error);break}};for(let i=0;i<this._threads;i++)this._workers[i].postMessage({path:t});return!0}}class Or extends Hs{_pngRect(e,t,i,n,r,a,h,l){let o=this._readData(r);return o===null?!1:(a.imageRect(e,t,i,n,"image/png",o,l),!0)}_basicRect(e,t,i,n,r,a,h,l){throw new Error("BasicCompression received in TightPNG rect")}}class zr{constructor(){this._filter=null,this._palette=new Uint8Array(1024),this._directDraw=!1,this._zlibs=[];for(let e=0;e<4;e++)this._zlibs[e]=new ut}decodeRect(e,t,i,n,r,a,h,l){let o=r[12];o=o>>4;let c;if(o===8)c=this._fillRect(e,t,i,n,r,a,h,l);else if(o===9)c=this._jpegRect(e,t,i,n,r,a,h,l);else if(o===10)c=this._pngRect(e,t,i,n,r,a,h,l);else if((o&8)==0)c=this._basicRect(o,e,t,i,n,r,a,h,l);else if(o===11)c=this._webpRect(e,t,i,n,r,a,h,l);else throw new Error("Illegal udp compression received (ctl: "+o+")");return c}_fillRect(e,t,i,n,r,a,h,l){return a.fillRect(e,t,i,n,[r[13],r[14],r[15]],l,this._directDraw),!0}_jpegRect(e,t,i,n,r,a,h,l){let o=this._readData(r);return o===null?!1:(a.imageRect(e,t,i,n,"image/jpeg",o,l,this._directDraw),!0)}_webpRect(e,t,i,n,r,a,h,l){let o=this._readData(r);return o===null?!1:(a.imageRect(e,t,i,n,"image/webp",o,l,this._directDraw),!0)}_pngRect(e,t,i,n,r,a,h,l){A("PNG received in UDP rect")}_basicRect(e,t,i,n,r,a,h,l,o){let c=a[12];for(let F=0;F<4;F++)c>>F&1&&this._zlibs[F].reset();let u=a[13],x=14,f=e&3;e&4||(u=0,x=13);let p;switch(u){case 0:p=this._copyFilter(f,t,i,n,r,a,h,l,o,x);break;case 1:p=this._paletteFilter(f,t,i,n,r,a,h,l,o);break;case 2:p=this._gradientFilter(f,t,i,n,r,a,h,l,o);break;default:throw new Error("Illegal tight filter received (ctl: "+this._filter+")")}return p}_copyFilter(e,t,i,n,r,a,h,l,o,c=14){const u=n*r*3;if(u===0)return!0;if(u<12)a=a.slice(c,c+u);else{if(a=this._readData(a,c),a===null)return!1;this._zlibs[e].setInput(a),a=this._zlibs[e].inflate(u),this._zlibs[e].setInput(null)}let x=new Uint8Array(n*r*4);for(let f=0,p=0;f<n*r*4;f+=4,p+=3)x[f]=a[p],x[f+1]=a[p+1],x[f+2]=a[p+2],x[f+3]=255;return h.blitImage(t,i,n,r,x,0,o,this._directDraw),!0}_paletteFilter(e,t,i,n,r,a,h,l,o){const c=a[14]+1,u=c*3;let x=a.slice(15,15+u);const f=c<=2?1:8,F=Math.floor((n*f+7)/8)*r;let E=15+u;if(F===0)return!0;if(F<12)a=a.slice(E,E+F);else{if(a=this._readData(a,E),a===null)return!1;this._zlibs[e].setInput(a),a=this._zlibs[e].inflate(F),this._zlibs[e].setInput(null)}return c==2?this._monoRect(t,i,n,r,a,x,h,o):this._paletteRect(t,i,n,r,a,x,h,o),!0}_monoRect(e,t,i,n,r,a,h,l){const o=this._getScratchBuffer(i*n*4),c=Math.floor((i+7)/8),u=Math.floor(i/8);for(let x=0;x<n;x++){let f,p,F;for(F=0;F<u;F++)for(let E=7;E>=0;E--)f=(x*i+F*8+7-E)*4,p=(r[x*c+F]>>E&1)*3,o[f]=a[p],o[f+1]=a[p+1],o[f+2]=a[p+2],o[f+3]=255;for(let E=7;E>=8-i%8;E--)f=(x*i+F*8+7-E)*4,p=(r[x*c+F]>>E&1)*3,o[f]=a[p],o[f+1]=a[p+1],o[f+2]=a[p+2],o[f+3]=255}h.blitImage(e,t,i,n,o,0,l,this._directDraw)}_paletteRect(e,t,i,n,r,a,h,l){const o=this._getScratchBuffer(i*n*4),c=i*n*4;for(let u=0,x=0;u<c;u+=4,x++){const f=r[x]*3;o[u]=a[f],o[u+1]=a[f+1],o[u+2]=a[f+2],o[u+3]=255}h.blitImage(e,t,i,n,o,0,l,this._directDraw)}_gradientFilter(e,t,i,n,r,a,h,l,o){throw new Error("Gradient filter not implemented")}_readData(e,t=13){if(e.length<t+2)return A("UDP Decoder, readData, invalid data len"),null;let i=t,n=e[i++],r=n&127;return n&128&&(n=e[i++],r|=(n&127)<<7,n&128&&(n=e[i++],r|=n<<14)),e.length!==r+i&&console.log("Rect of size "+r+" with data size "+e.length+" index of "+i),e.slice(i)}_getScratchBuffer(e){return(!this._scratchBuffer||this._scratchBuffer.length<e)&&(this._scratchBuffer=new Uint8Array(e)),this._scratchBuffer}}const Vr=3,Wr="rgb(40, 40, 40)",hs=17;let ls=19;const rt=75,ve=50,Gr=1e3,Yr=50,ae=1,cs=1<<24,ht=1<<25,ds=1<<26,lt=1<<27,ct=1<<28;class R extends sn{constructor(e,t,i,n,r){if(!e)throw new Error("Must specify target");if(!i&&r)throw new Error("Must specify URL, WebSocket or RTCDataChannel");super(),this._target=e,typeof i=="string"?this._url=i:(this._url=null,this._rawChannel=i),n=n||{},this._rfbCredentials=n.credentials||{},this._shared="shared"in n?!!n.shared:!0,this._repeaterID=n.repeaterID||"",this._wsProtocols=n.wsProtocols||["binary"],this._isPrimaryDisplay=r!==!1,this._rfbConnectionState="",this._rfbInitState="",this._rfbAuthScheme=-1,this._rfbCleanDisconnect=!0,this._rfbVersion=0,this._rfbMaxVersion=3.8,this._rfbTightVNC=!1,this._rfbVeNCryptState=0,this._rfbXvpVer=0,this._fbWidth=0,this._fbHeight=0,this._fbName="",this._capabilities={power:!1},this._supportsFence=!1,this._supportsContinuousUpdates=!1,this._enabledContinuousUpdates=!1,this._supportsSetDesktopSize=!1,this._connectionID=window.location.href.split("?")[0].match(/^(.+)(\/)/)[0],this._screenFlags=0,this._qemuExtKeyEventSupported=!1,this._jpegVideoQuality=5,this._webpVideoQuality=5,this._treatLossless=7,this._preferBandwidth=!0,this._dynamicQualityMin=3,this._dynamicQualityMax=9,this._videoArea=65,this._videoTime=5,this._videoOutTime=3,this._videoScaling=2,this._frameRate=30,this._maxVideoResolutionX=960,this._maxVideoResolutionY=540,this._forcedResolutionX=null,this._forcedResolutionY=null,this._clipboardBinary=!0,this._resendClipboardNextUserDrivenEvent=!0,this._useUdp=!0,this._hiDpi="hiDpi"in n?!!n.hiDpi:!1,this._enableQOI=!1,this._videoQuality=2,this._enableWebP=!1,this.TransitConnectionStates={Tcp:Symbol("tcp"),Udp:Symbol("udp"),Upgrading:Symbol("upgrading"),Downgrading:Symbol("downgrading"),Failure:Symbol("failure")},this._transitConnectionState=this.TransitConnectionStates.Tcp,this._lastTransition=null,this._udpConnectFailures=0,this._udpTransitFailures=0,this._trackFrameStats=!1,this._clipboardText=null,this._clipboardServerCapabilitiesActions={},this._clipboardServerCapabilitiesFormats={},this._sock=null,this._display=null,this._flushing=!1,this._keyboard=null,this._gestures=null,this._disconnTimer=null,this._resizeTimeout=null,this._mouseMoveTimer=null,this._forceFullFrameUpdateTimeout=null,this._decoders={},this._FBU={rects:0,x:0,y:0,width:0,height:0,encoding:null,frame_id:0,rect_total:0},this._mousePos={},this._mouseButtonMask=0,this._mouseLastMoveTime=0,this._pointerLock=!1,this._pointerLockPos={x:0,y:0},this._pointerRelativeEnabled=!1,this._mouseLastPinchAndZoomTime=0,this._viewportDragging=!1,this._viewportDragPos={},this._viewportHasMoved=!1,this._accumulatedWheelDeltaX=0,this._accumulatedWheelDeltaY=0,this.mouseButtonMapper=null,this._mouseLastScreenIndex=-1,this._sendLeftClickonNextMove=!1,this._gestureLastTapTime=null,this._gestureFirstDoubleTapEv=null,this._gestureLastMagnitudeX=0,this._gestureLastMagnitudeY=0,this._supportsBroadcastChannel=typeof BroadcastChannel<"u",this._supportsBroadcastChannel&&(this._controlChannel=new BroadcastChannel(this._connectionID),this._controlChannel.addEventListener("message",this._handleControlMessage.bind(this)),C("Attached to registrationChannel for secondary displays.")),this._isPrimaryDisplay||(this._screenIndex=2),this._eventHandlers={updateHiddenKeyboard:this._updateHiddenKeyboard.bind(this),focusCanvas:this._focusCanvas.bind(this),windowResize:this._windowResize.bind(this),handleMouse:this._handleMouse.bind(this),handlePointerLockChange:this._handlePointerLockChange.bind(this),handlePointerLockError:this._handlePointerLockError.bind(this),handleWheel:this._handleWheel.bind(this),handleGesture:this._handleGesture.bind(this),handleFocusChange:this._handleFocusChange.bind(this),handleMouseOut:this._handleMouseOut.bind(this),handleVisibilityChange:this._handleVisibilityChange.bind(this)},C(">> RFB.constructor"),this._screen=document.createElement("div"),this._screen.style.display="flex",this._screen.style.width="100%",this._screen.style.height="100%",this._screen.style.overflow="auto",this._screen.style.background=Wr,this._canvas=document.createElement("canvas"),this._canvas.style.margin="auto",this._canvas.style.outline="none",this._canvas.width=0,this._canvas.height=0,this._canvas.tabIndex=-1,this._canvas.overflow="hidden",this._screen.appendChild(this._canvas),this._cursor=new Tr,this._cursorImage=R.cursors.none;try{this._display=new an(this._canvas,this._isPrimaryDisplay)}catch(a){throw A("Display exception: "+a),a}this._display.onflush=this._onFlush.bind(this),this._decoders[X.encodingRaw]=new Ur,this._decoders[X.encodingCopyRect]=new Br,this._decoders[X.encodingRRE]=new Hr,this._decoders[X.encodingHextile]=new Nr,this._decoders[X.encodingTight]=new Hs(this._display),this._decoders[X.encodingTightPNG]=new Or,this._decoders[X.encodingUDP]=new zr,this._keyboard=new Js(this._canvas,t),this._keyboard.onkeyevent=this._handleKeyEvent.bind(this),this._gestures=new Dr,this._isPrimaryDisplay&&this._setupWebSocket(),C("<< RFB.constructor"),this.dragViewport=!1,this.focusOnClick=!0,this.lastActiveAt=Date.now(),this._viewOnly=!1,this._clipViewport=!1,this._scaleViewport=!1,this._resizeSession=!1,this._lastVisibilityState="visible",this._showDotCursor=!1,n.showDotCursor!==void 0&&(V("Specifying showDotCursor as a RFB constructor argument is deprecated"),this._showDotCursor=n.showDotCursor),this._qualityLevel=6,this._compressionLevel=2,this._clipHash=0}get connectionID(){return this._connectionID}get translateShortcuts(){return this._keyboard.translateShortcuts}set translateShortcuts(e){this._keyboard.translateShortcuts=e}get pointerLock(){return this._pointerLock}set pointerLock(e){this._pointerLock?window.document.exitPointerLock?(window.document.exitPointerLock(),this._pointerLockChanging=!0):window.document.mozExitPointerLock&&(window.document.mozExitPointerLock(),this._pointerLockChanging=!0):this._canvas.requestPointerLock?(this._canvas.requestPointerLock(),this._pointerLockChanging=!0):this._canvas.mozRequestPointerLock&&(this._canvas.mozRequestPointerLock(),this._pointerLockChanging=!0)}get pointerRelative(){return this._pointerRelativeEnabled}set pointerRelative(e){if(this._pointerRelativeEnabled=e,e){let t=this._display.scale===1?this._fbWidth:this._fbWidth*this._display.scale,i=this._display.scale===1?this._fbHeight:this._fbHeight*this._display.scale;this._pointerLockPos.x=Math.floor(t/2),this._pointerLockPos.y=Math.floor(i/2),this._mousePos={x:this._pointerLockPos.x,y:this._pointerLockPos.y},this._cursor.move(this._pointerLockPos.x,this._pointerLockPos.y)}}get keyboard(){return this._keyboard}get clipboardBinary(){return this._clipboardMode}set clipboardBinary(e){this._clipboardMode=e}get videoQuality(){return this._videoQuality}set videoQuality(e){(this._videoQuality<=1||e<=1)&&(this._pendingApplyResolutionChange=!0),this._videoQuality=e,this._pendingApplyEncodingChanges=!0}get preferBandwidth(){return this._preferBandwidth}set preferBandwidth(e){this._preferBandwidth=e,this._pendingApplyEncodingChanges=!0}get viewOnly(){return this._viewOnly}set viewOnly(e){this._viewOnly=e,(this._rfbConnectionState==="connecting"||this._rfbConnectionState==="connected")&&(e?this._keyboard.ungrab():this._keyboard.grab())}get capabilities(){return this._capabilities}get touchButton(){return 0}set touchButton(e){V("Using old API!")}get clipViewport(){return this._clipViewport}set clipViewport(e){this._clipViewport=e}get scaleViewport(){return this._scaleViewport}set scaleViewport(e){this._scaleViewport!==e&&(this._scaleViewport=e,this._pendingApplyResolutionChange=!0)}get resizeSession(){return this._resizeSession}set resizeSession(e){this._resizeSession=e,e&&(this.scaleViewport=!0,this._pendingApplyResolutionChange=!0)}get showDotCursor(){return this._showDotCursor}set showDotCursor(e){this._showDotCursor=e,this._refreshCursor()}get background(){return this._screen.style.background}set background(e){this._screen.style.background=e}get enableWebP(){return this._enableWebP}set enableWebP(e){this._enableWebP!==e&&(this._enableWebP=e,this._pendingApplyEncodingChanges=!0)}get enableQOI(){return this._enableQOI}set enableQOI(e){this._enableQOI!==e&&(this._decoders[X.encodingTight].enableQOI=e,this._enableQOI=this._decoders[X.encodingTight].enableQOI,this._enableQOI===e&&(this._pendingApplyEncodingChanges=!0))}get antiAliasing(){return this._display.antiAliasing}set antiAliasing(e){this._display.antiAliasing=e}get jpegVideoQuality(){return this._jpegVideoQuality}set jpegVideoQuality(e){if(!Number.isInteger(e)||e<0||e>9){A("qualityLevel must be an integer between 0 and 9");return}this._jpegVideoQuality!==e&&(this._jpegVideoQuality=e,this._pendingApplyEncodingChanges=!0)}get webpVideoQuality(){return this._webpVideoQuality}set webpVideoQuality(e){if(!Number.isInteger(e)||e<0||e>9){A("qualityLevel must be an integer between 0 and 9");return}this._webpVideoQuality!==e&&(this._webpVideoQuality=e,this._pendingApplyEncodingChanges=!0)}get treatLossless(){return this._treatLossless}set treatLossless(e){if(!Number.isInteger(e)||e<0||e>9){A("qualityLevel must be an integer between 0 and 9");return}this._treatLossless!==e&&(this._treatLossless=e)}get dynamicQualityMin(){return this._dynamicQualityMin}set dynamicQualityMin(e){if(!Number.isInteger(e)||e<0||e>9){A("qualityLevel must be an integer between 0 and 9");return}this._dynamicQualityMin!==e&&(this._dynamicQualityMin=e,this._pendingApplyEncodingChanges=!0)}get dynamicQualityMax(){return this._dynamicQualityMax}set dynamicQualityMax(e){if(!Number.isInteger(e)||e<0||e>9){A("qualityLevel must be an integer between 0 and 9");return}this._dynamicQualityMax!==e&&(this._dynamicQualityMax=e,this._pendingApplyEncodingChanges=!0)}get videoArea(){return this._videoArea}set videoArea(e){if(!Number.isInteger(e)||e<0||e>100){A("video area must be an integer between 0 and 100");return}this._videoArea!==e&&(this._videoArea=e,this._pendingApplyEncodingChanges=!0)}get videoTime(){return this._videoTime}set videoTime(e){if(!Number.isInteger(e)||e<0||e>100){A("video time must be an integer between 0 and 100");return}this._videoTime!==e&&(this._videoTime=e,this._pendingApplyEncodingChanges=!0)}get videoOutTime(){return this._videoOutTime}set videoOutTime(e){if(!Number.isInteger(e)||e<0||e>100){A("video out time must be an integer between 0 and 100");return}this._videoOutTime!==e&&(this._videoOutTime=e,this._pendingApplyEncodingChanges=!0)}get videoScaling(){return this._videoScaling}set videoScaling(e){if(!Number.isInteger(e)||e<0||e>2){A("video scaling must be an integer between 0 and 2");return}this._videoScaling!==e&&(this._videoScaling=e,this._pendingApplyEncodingChanges=!0)}get frameRate(){return this._frameRate}set frameRate(e){if(!Number.isInteger(e)||e<1||e>120){A("frame rate must be an integer between 1 and 120");return}this._frameRate!==e&&(this._frameRate=e,this._pendingApplyEncodingChanges=!0)}get maxVideoResolutionX(){return this._maxVideoResolutionX}set maxVideoResolutionX(e){if(!Number.isInteger(e)||e<100){A("max video resolution must be an integer greater than 100");return}this._maxVideoResolutionX!==e&&(this._maxVideoResolutionX=e,this._pendingApplyVideoRes=!0)}get maxVideoResolutionY(){return this._maxVideoResolutionY}set maxVideoResolutionY(e){if(!Number.isInteger(e)||e<100){A("max video resolution must be an integer greater than 100");return}this._maxVideoResolutionY!==e&&(this._maxVideoResolutionY=e,this._pendingApplyVideoRes=!0)}get forcedResolutionX(){return this._forcedResolutionX}set forcedResolutionX(e){e!==this._forcedResolutionX&&(this._forcedResolutionX=e,this._pendingApplyResolutionChange=!0)}get forcedResolutionY(){return this._forcedResolutionY}set forcedResolutionY(e){e!==this._forcedResolutionY&&(this._forcedResolutionY=e,this._pendingApplyResolutionChange=!0)}get qualityLevel(){return this._qualityLevel}set qualityLevel(e){if(!Number.isInteger(e)||e<0||e>9){A("qualityLevel must be an integer between 0 and 9");return}this._qualityLevel!==e&&(this._qualityLevel=e,this._pendingApplyEncodingChanges=!0)}get compressionLevel(){return this._compressionLevel}set compressionLevel(e){if(!Number.isInteger(e)||e<0||e>9){A("compressionLevel must be an integer between 0 and 9");return}this._compressionLevel!==e&&(this._compressionLevel=e,this._rfbConnectionState==="connected"&&this._sendEncodings())}get statsFps(){return this._display.fps}get enableWebRTC(){return this._useUdp}set enableWebRTC(e){this._useUdp=e,e?this._rfbConnectionState==="connected"&&this._transitConnectionState!==this.TransitConnectionStates.Udp&&this._sendUdpUpgrade():this._rfbConnectionState==="connected"&&this._transitConnectionState!==this.TransitConnectionStates.Tcp&&this._sendUdpDowngrade()}get enableHiDpi(){return this._hiDpi}set enableHiDpi(e){e!==this._hiDpi&&(this._hiDpi=e,this._pendingApplyResolutionChange=!0,this._display.applyServerResolution(0,0,0))}refreshSecondaryDisplays(){this._display.screens.length>1&&this._proxyRFBMessage("applySettings",[this._hiDpi,this._clipViewport,this._scaleViewport,this._resizeSession,this._videoQuality,this._forcedResolutionX,this._forcedResolutionY])}attachSecondaryDisplay(e){this._updateConnectionState("connecting");const t=this._registerSecondaryDisplay(!1,e);return this._updateConnectionState("connected"),t}reattachSecondaryDisplay(e,t){return this._updateConnectionState("connecting"),this._registerSecondaryDisplay(e,t),this._updateConnectionState("connected"),e}applyScreenPlan(e){if(this._isPrimaryDisplay){let t=this._screenSize(),i=Number.MAX_SAFE_INTEGER,n=Number.MAX_SAFE_INTEGER,r=0;for(let h=0;h<e.screens.length;h++){i=Math.min(i,e.screens[h].x),n=Math.min(n,e.screens[h].y);for(let l=0;l<t.screens.length;l++)e.screens[h].screenID==t.screens[l].screenID&&r++}if(i!==0||n!==0)throw new Error("Screen plan invalid, improper coordinates provided.");if(r>t.screens.length)throw new Error("Screen plan contained more screens then there are registered.");if(r<t.screens.length)throw new Error("Screen plan contained fewer screens then there are registered.");let a=this._display.applyScreenPlan(e);if(a){for(let h=0;h<e.screens.length;h++)for(let l=1;l<t.screens.length;l++)e.screens[h].screenID==t.screens[l].screenID&&this._proxyRFBMessage("applyScreenPlan",[t.screens[l].screenID,t.screens[l].screenIndex,e.screens[h].width,e.screens[h].height,e.screens[h].x,e.screens[h].y]);this._pendingApplyResolutionChange=!0}else C("Screen plan did not apply, no changes detected.");return a}}getScreenPlan(){let e=this._screenSize(),t={screens:[],serverWidth:e.serverWidth,serverHeight:e.serverHeight};for(let i=0;i<e.screens.length;i++)t.screens.push({screenID:e.screens[i].screenID,serverWidth:e.screens[i].serverWidth,serverHeight:e.screens[i].serverHeight,x:e.screens[i].x,y:e.screens[i].y,pixelRatio:e.screens[i].pixelRatio});return t}updateConnectionSettings(){this._rfbConnectionState==="connected"&&this._isPrimaryDisplay?(this._pendingApplyVideoRes&&R.messages.setMaxVideoResolution(this._sock,this._maxVideoResolutionX,this._maxVideoResolutionY),this._pendingApplyResolutionChange&&(this._screenSize(),this._scaleViewport&&this._clipViewport&&this._updateClip(),this._updateScale(),!this._scaleViewport&&this._clipViewport&&this._updateClip(),this._display.screens.length>1&&this.refreshSecondaryDisplays(),(this._resizeSession||this._forcedResolutionX&&this._forcedResolutionY)&&(this.dispatchEvent(new CustomEvent("screenregistered",{})),clearTimeout(this._resizeTimeout),this._resizeTimeout=setTimeout(this._requestRemoteResize.bind(this),500))),this._pendingApplyEncodingChanges&&this._sendEncodings(),this._pendingApplyVideoRes=!1,this._pendingApplyEncodingChanges=!1,this._pendingApplyResolutionChange=!1):this._isPrimaryDisplay||(this._pendingApplyResolutionChange&&(this._scaleViewport&&this._clipViewport&&this._updateClip(),this._updateScale(),!this._scaleViewport&&this._clipViewport&&this._updateClip()),(this._resizeSession||this._forcedResolutionX&&this._forcedResolutionY)&&this._requestRemoteResize())}disconnect(){this._isPrimaryDisplay?(this._updateConnectionState("disconnecting"),this._sock.off("error"),this._sock.off("message"),this._sock.off("open"),this._proxyRFBMessage("disconnect")):(this._updateConnectionState("disconnecting"),this._unregisterSecondaryDisplay(),this._rfbConnectionState="")}terminate(){this._isPrimaryDisplay&&(this._updateConnectionState("disconnecting"),this._sock.off("error"),this._sock.off("message"),this._sock.off("open"),this._proxyRFBMessage("terminate"))}sendCtrlAltDel(){this._rfbConnectionState!=="connected"||this._viewOnly||(I("Sending Ctrl-Alt-Del"),this.sendKey(_.XK_Control_L,"ControlLeft",!0),this.sendKey(_.XK_Alt_L,"AltLeft",!0),this.sendKey(_.XK_Delete,"Delete",!0),this.sendKey(_.XK_Delete,"Delete",!1),this.sendKey(_.XK_Alt_L,"AltLeft",!1),this.sendKey(_.XK_Control_L,"ControlLeft",!1))}machineShutdown(){this._xvpOp(1,2)}machineReboot(){this._xvpOp(1,3)}machineReset(){this._xvpOp(1,4)}sendKey(e,t,i){if(this._rfbConnectionState!=="connected"||this._viewOnly)return;if(t!==null&&this._setLastActive(),i===void 0){this.sendKey(e,t,!0),this.sendKey(e,t,!1);return}const n=Pr[t];if(this._qemuExtKeyEventSupported&&n)e=e||0,I("Sending key ("+(i?"down":"up")+"): keysym "+e+", scancode "+n),this._isPrimaryDisplay?R.messages.QEMUExtendedKeyEvent(this._sock,e,i,n):this._proxyRFBMessage("QEMUExtendedKeyEvent",[e,i,n]);else{if(!e)return;I("Sending keysym ("+(i?"down":"up")+"): "+e),this._isPrimaryDisplay?R.messages.keyEvent(this._sock,e,i?1:0):this._proxyRFBMessage("keyEvent",[e,i?1:0])}}focus(){this._keyboard.focus()}blur(){this._keyboard.blur()}checkLocalClipboard(){this.clipboardUp&&this.clipboardSeamless&&this._resendClipboardNextUserDrivenEvent&&(this._resendClipboardNextUserDrivenEvent=!1,this.clipboardBinary?navigator.clipboard.read().then(e=>{this.clipboardPasteDataFrom(e)},e=>{C("No data in clipboard: "+e)}):navigator.clipboard&&navigator.clipboard.readText&&navigator.clipboard.readText().then((function(e){this.clipboardPasteFrom(e)}).bind(this)).catch(function(){return C("Failed to read system clipboard")}))}clipboardPasteFrom(e){if(this._rfbConnectionState!=="connected"||this._viewOnly||!(typeof e=="string"&&e.length>0))return;let t=new TextEncoder().encode(e),i=Ae(t);if(i===this._clipHash){C("No clipboard changes");return}else this._clipHash=i;let n=[],r=["text/plain"];n.push(t),this._isPrimaryDisplay?R.messages.sendBinaryClipboard(this._sock,n,r):this._proxyRFBMessage("sendBinaryClipboard",[n,r])}async clipboardPasteDataFrom(e){if(this._rfbConnectionState!=="connected"||this._viewOnly)return;let t=[],i=[],n=0;for(let r=0;r<e.length;r++)for(let a=0;a<e[r].types.length;a++){let h=e[r].types[a];switch(h){case"image/png":case"text/plain":case"text/html":let l=await e[r].getType(h);if(!l)continue;let o=await l.arrayBuffer(),c=new Uint8Array(o);if(!n)if(n=Ae(c),n===this._clipHash){C("No clipboard changes");return}else this._clipHash=n;if(i.includes(h))continue;i.push(h),t.push(c),C("Sending mime type: "+h);break;default:I("skipping clip send mime type: "+h)}}if(i.includes("image/png")&&!i.includes("text/plain")){let r=i.indexOf("image/png");i=i.slice(r,r+1),t=t.slice(r,r+1)}else if(i.includes("image/png")&&i.includes("text/plain")){let r=i.indexOf("image/png");i.splice(r,1),t.splice(r,1)}t.length>0&&(this._isPrimaryDisplay?R.messages.sendBinaryClipboard(this._sock,t,i):this._proxyRFBMessage("sendBinaryClipboard",[t,i]))}requestBottleneckStats(){this._isPrimaryDisplay&&R.messages.requestStats(this._sock)}subscribeUnixRelay(e,t){this._isPrimaryDisplay&&(this._unixRelays=this._unixRelays||{},this._unixRelays[e]=t,R.messages.sendSubscribeUnixRelay(this._sock,e))}sendUnixRelayData(e,t){this._isPrimaryDisplay&&R.messages.sendUnixRelay(this._sock,e,t)}_setLastActive(){this.lastActiveAt=Date.now()}_changeTransitConnectionState(e){I("Transit state change from "+this._transitConnectionState.toString()+" to "+e.toString()),this._transitConnectionState=e}_setupWebSocket(){this._sock=new Lr,this._sock.on("message",()=>{this._handleMessage()}),this._sock.on("open",()=>{this._rfbConnectionState==="connecting"&&this._rfbInitState===""?(this._rfbInitState="ProtocolVersion",C("Starting VNC handshake")):this._fail("Unexpected server connection while "+this._rfbConnectionState)}),this._sock.on("close",e=>{C("WebSocket on-close event");let t="";switch(e.code&&(t="(code: "+e.code,e.reason&&(t+=", reason: "+e.reason),t+=")"),this._rfbConnectionState){case"connecting":this._fail("Connection closed "+t);break;case"connected":this._updateConnectionState("disconnecting"),this._updateConnectionState("disconnected");break;case"disconnecting":this._updateConnectionState("disconnected");break;case"disconnected":this._fail("Unexpected server disconnect when already disconnected "+t);break;default:this._fail("Unexpected server disconnect before connecting "+t);break}this._sock.off("close"),this._rawChannel=null}),this._sock.on("error",e=>V("WebSocket on-error event")),setTimeout(this._updateConnectionState.bind(this,"connecting"))}_connect(){if(C(">> RFB.connect"),this._url&&this._isPrimaryDisplay)try{I(`connecting to ${this._url}`),this._sock.open(this._url,this._wsProtocols),this._setLastActive()}catch(e){e.name==="SyntaxError"?this._fail("Invalid host or port ("+e+")"):this._fail("Error when opening socket ("+e+")")}else if(this._isPrimaryDisplay)try{I(`attaching ${this._rawChannel} to Websock`),this._sock.attach(this._rawChannel)}catch(e){this._fail("Error attaching channel ("+e+")")}if(this._target.appendChild(this._screen),this._gestures.attach(this._canvas),this._cursor.attach(this._canvas),this._refreshCursor(),window.addEventListener("resize",this._eventHandlers.windowResize),this._canvas.addEventListener("mousedown",this._eventHandlers.focusCanvas),this._canvas.addEventListener("touchstart",this._eventHandlers.focusCanvas),this._canvas.addEventListener("focus",this._eventHandlers.handleFocusChange),window.addEventListener("focus",this._eventHandlers.handleFocusChange),window.addEventListener("blur",this._eventHandlers.handleFocusChange),document.addEventListener("visibilitychange",this._eventHandlers.handleVisibilityChange),window.addEventListener("mouseover",this._eventHandlers.handleMouseOut),Ce()&&this._canvas.addEventListener("touchend",this._eventHandlers.updateHiddenKeyboard),this._canvas.addEventListener("mousedown",this._eventHandlers.handleMouse),this._canvas.addEventListener("mouseup",this._eventHandlers.handleMouse),this._canvas.addEventListener("mousemove",this._eventHandlers.handleMouse),this._canvas.addEventListener("click",this._eventHandlers.handleMouse),this._canvas.addEventListener("contextmenu",this._eventHandlers.handleMouse),document.onpointerlockchange!==void 0?(document.addEventListener("pointerlockchange",this._eventHandlers.handlePointerLockChange,!1),document.addEventListener("pointerlockerror",this._eventHandlers.handlePointerLockError,!1)):document.onmozpointerlockchange!==void 0&&(document.addEventListener("mozpointerlockchange",this._eventHandlers.handlePointerLockChange,!1),document.addEventListener("mozpointerlockerror",this._eventHandlers.handlePointerLockError,!1)),this._canvas.addEventListener("wheel",this._eventHandlers.handleWheel),this._canvas.addEventListener("gesturestart",this._eventHandlers.handleGesture),this._canvas.addEventListener("gesturemove",this._eventHandlers.handleGesture),this._canvas.addEventListener("gestureend",this._eventHandlers.handleGesture),this._resendClipboardNextUserDrivenEvent=!0,typeof RTCPeerConnection<"u"&&this._isPrimaryDisplay){this._udpBuffer=new Map,this._udpPeer=new RTCPeerConnection({iceServers:[{urls:["stun:stun.l.google.com:19302"]}]});let e=this._udpPeer;e.onicecandidate=function(n){n.candidate?C("received ice candidate",n.candidate):C("all candidates received")},e.ondatachannel=function(n){C("peer connection on data channel",n)},this._udpChannel=e.createDataChannel("webudp",{ordered:!1,maxRetransmits:0}),this._udpChannel.binaryType="arraybuffer",this._udpChannel.onerror=function(n){A("data channel error "+n.message),this._udpTransitFailures+=1,this._sendUdpDowngrade()},this._sock;let t=this._udpBuffer,i=this;this._udpChannel.onmessage=function(n){const r=new Uint8Array(n.data),a=parseInt(r[0]+(r[1]<<8)+(r[2]<<16)+(r[3]<<24),10),h=parseInt(r[4]+(r[5]<<8)+(r[6]<<16)+(r[7]<<24),10),l=parseInt(r[8]+(r[9]<<8)+(r[10]<<16)+(r[11]<<24),10);parseInt(r[12]+(r[13]<<8)+(r[14]<<16)+(r[15]<<24),10);const o=parseInt(r[16]+(r[17]<<8)+(r[18]<<16)+(r[19]<<24),10);if(i._transitConnectionState!==i.TransitConnectionStates.Udp&&(i._display.clear(),i._changeTransitConnectionState(i.TransitConnectionStates.Udp)),l==1)i._handleUdpRect(r.slice(20),o);else{const u=Date.now();if(t.has(a)){let x=t.get(a);if(x.recieved_pieces+=1,x.data[h]=r.slice(20),x.total_bytes+=x.data[h].length,x.total_pieces==x.recieved_pieces){var c=new Uint8Array(x.total_bytes);let f=0;for(let p=0;p<x.data.length;p++)c.set(x.data[p],f),f+=x.data[p].length;t.delete(a),i._handleUdpRect(c,o)}}else{let x={total_pieces:l,arrival:u,recieved_pieces:1,total_bytes:0,data:new Array(l)};x.data[h]=r.slice(20),x.total_bytes=x.data[h].length,t.set(a,x)}}}}this._useUdp&&typeof RTCPeerConnection<"u"&&this._isPrimaryDisplay&&setTimeout((function(){this._sendUdpUpgrade()}).bind(this),3e3),C("<< RFB.connect")}_disconnect(){C(">> RFB.disconnect"),this._cursor.detach(),this._canvas.removeEventListener("gesturestart",this._eventHandlers.handleGesture),this._canvas.removeEventListener("gesturemove",this._eventHandlers.handleGesture),this._canvas.removeEventListener("gestureend",this._eventHandlers.handleGesture),this._canvas.removeEventListener("wheel",this._eventHandlers.handleWheel),this._canvas.removeEventListener("mousedown",this._eventHandlers.handleMouse),this._canvas.removeEventListener("mouseup",this._eventHandlers.handleMouse),this._canvas.removeEventListener("mousemove",this._eventHandlers.handleMouse),this._canvas.removeEventListener("click",this._eventHandlers.handleMouse),this._canvas.removeEventListener("contextmenu",this._eventHandlers.handleMouse),document.onpointerlockchange!==void 0?(document.removeEventListener("pointerlockchange",this._eventHandlers.handlePointerLockChange),document.removeEventListener("pointerlockerror",this._eventHandlers.handlePointerLockError)):document.onmozpointerlockchange!==void 0&&(document.removeEventListener("mozpointerlockchange",this._eventHandlers.handlePointerLockChange),document.removeEventListener("mozpointerlockerror",this._eventHandlers.handlePointerLockError)),this._canvas.removeEventListener("mousedown",this._eventHandlers.focusCanvas),this._canvas.removeEventListener("touchstart",this._eventHandlers.focusCanvas),this._canvas.removeEventListener("focus",this._eventHandlers.handleFocusChange),window.removeEventListener("resize",this._eventHandlers.windowResize),window.removeEventListener("focus",this._eventHandlers.handleFocusChange),document.removeEventListener("visibilitychange",this._eventHandlers.handleVisibilityChange),this._keyboard.ungrab(),this._gestures.detach(),this._isPrimaryDisplay?this._sock.close():this._primaryDisplayChannel&&(this._primaryDisplayChannel.postMessage({eventType:"unregister",screenID:this._display.screenID}),this._primaryDisplayChannel.removeEventListener("message",this._handleSecondaryDisplayMessage),this._primaryDisplayChannel.close(),this._primaryDisplayChannel=null);try{this._target.removeChild(this._screen)}catch(e){if(e.name!=="NotFoundError")throw e}this._display.dispose(),clearTimeout(this._resizeTimeout),clearTimeout(this._mouseMoveTimer),window.localStorage.removeItem("lastWindow"),C("<< RFB.disconnect")}_updateHiddenKeyboard(e){const t=Math.max(0,e.pageY-50);document.querySelector("#noVNC_keyboardinput").style.top=`${t}px`}_handleFocusChange(e){if(this._resendClipboardNextUserDrivenEvent=!0,e.type=="focus"&&e.currentTarget instanceof Window)if(this._lastVisibilityState==="visible"){const t=window.localStorage.getItem("lastWindow");C("Window focused while user switched between windows."),t!=e.currentTarget.name&&(this._sendLeftClickonNextMove=!0,window.localStorage.setItem("lastWindow",e.currentTarget.name))}else C("Window focused while user switched between tabs.");document.visibilityState==="visible"&&this._lastVisibilityState==="hidden"&&(C("Window is now visible."),this._lastVisibilityState=document.visibilityState)}_handleVisibilityChange(e){document.visibilityState==="hidden"&&(this._lastVisibilityState=document.visibilityState,C("Window is not visible."))}_focusCanvas(e){window.parent.postMessage({action:"enable_audio",value:null},"*"),!this._pointerLock&&this._pointerRelativeEnabled&&(this.pointerLock=!0),this._resendClipboardNextUserDrivenEvent&&this.checkLocalClipboard(),this.focusOnClick&&this.focus()}_setDesktopName(e){this._fbName=e,this.dispatchEvent(new CustomEvent("desktopname",{detail:{name:this._fbName}}))}_windowResize(e){window.requestAnimationFrame(()=>{this._screenSize(),this._updateClip(),this._updateScale()}),this.dispatchEvent(new CustomEvent("screenregistered",{})),this._resizeSession&&(clearTimeout(this._resizeTimeout),this._resizeTimeout=setTimeout(this._requestRemoteResize.bind(this),500))}_updateClip(){const e=this._display.clipViewport;let t=this._clipViewport;if(this._scaleViewport&&(t=!1),e!==t&&(this._display.clipViewport=t),t){const i=this._screenSize();this._display.viewportChangeSize(i.screens[0].serverWidth,i.screens[0].serverHeight),this._fixScrollbars()}}_updateScale(){if(!this._scaleViewport)this._display.scale=1;else{const e=this._screenSize();this._display.autoscale(e.screens[0].width,e.screens[0].height,e.screens[0].scale)}this._fixScrollbars()}_requestRemoteResize(){if(clearTimeout(this._resizeTimeout),this._resizeTimeout=null,this._isPrimaryDisplay){if(this._viewOnly||!this._supportsSetDesktopSize||!this._resizeSession&&!this._forcedResolutionX&&!this._forcedResolutionY)return;for(let t=0;t<this._display.screens.length;t++)this._display.applyServerResolution(0,0,this._display.screens[t].screenIndex);const e=this._screenSize();this._forceFullFrameUpdateAfterResize=!0,R.messages.setDesktopSize(this._sock,e,this._screenFlags),C("Requested new desktop size: "+e.serverWidth+"x"+e.serverHeight)}else if(this._display.screenIndex>0){let e=null;window.localStorage.getItem("autoPlacement")===null&&(e={left:window.screenLeft,top:window.screenTop}),this._registerSecondaryDisplay(this._display.screens[0],e)}}_screenSize(e){return this._display.getScreenSize(this.videoQuality,this.forcedResolutionX,this.forcedResolutionY,this._hiDpi,e,!this._resizeSession)}_fixScrollbars(){const e=this._screen.style.overflow;this._screen.style.overflow="hidden",this._screen.getBoundingClientRect(),this._screen.style.overflow=e}_updateConnectionState(e){const t=this._rfbConnectionState;if(e===t){C("Already in state '"+e+"', ignoring");return}if(t==="disconnected"){A("Tried changing state of a disconnected RFB object");return}switch(e){case"connected":if(t!=="connecting"){A("Bad transition to connected state, previous connection state: "+t);return}break;case"disconnected":if(t!=="disconnecting"){A("Bad transition to disconnected state, previous connection state: "+t);return}break;case"connecting":if(t!==""){A("Bad transition to connecting state, previous connection state: "+t);return}break;case"disconnecting":if(t!=="connected"&&t!=="connecting"){A("Bad transition to disconnecting state, previous connection state: "+t);return}break;case"proxied":break;default:A("Unknown connection state: "+e);return}switch(this._rfbConnectionState=e,C("New state '"+e+"', was '"+t+"'."),this._disconnTimer&&e!=="disconnecting"&&(C("Clearing disconnect timer"),clearTimeout(this._disconnTimer),this._disconnTimer=null,this._isPrimaryDisplay&&this._sock.off("close")),e){case"connecting":this._connect();break;case"connected":this.dispatchEvent(new CustomEvent("connect",{detail:{}}));break;case"disconnecting":this._disconnect(),this._disconnTimer=setTimeout(()=>{A("Disconnection timed out."),this._updateConnectionState("disconnected"),this._proxyRFBMessage("secondarydisconnected")},Vr*1e3);break;case"disconnected":this.dispatchEvent(new CustomEvent("disconnect",{detail:{clean:this._rfbCleanDisconnect}}));break}}_fail(e){switch(this._rfbConnectionState){case"disconnecting":A("Failed when disconnecting: "+e);break;case"connected":A("Failed while connected: "+e);break;case"connecting":A("Failed when connecting: "+e);break;default:A("RFB failure: "+e);break}return this._rfbCleanDisconnect=!1,this._updateConnectionState("disconnecting"),this._updateConnectionState("disconnected"),!1}_setCapability(e,t){this._capabilities[e]=t,this.dispatchEvent(new CustomEvent("capabilities",{detail:{capabilities:this._capabilities}}))}_proxyRFBMessage(e,t){let i={eventType:e,args:t,screenID:this._display.screenID,screenIndex:this._display.screenIndex,mouseLastScreenIndex:this._mouseLastScreenIndex};this._controlChannel.postMessage(i)}_handleControlMessage(e){if(this._isPrimaryDisplay){let t;switch(e.data.eventType){case"register":const i={...e.data.details,screenID:e.data.screenID};let n=this._display.addScreen(e.data.screenID,e.data.width,e.data.height,e.data.pixelRatio,e.data.containerHeight,e.data.containerWidth,e.data.scale,e.data.serverWidth,e.data.serverHeight,e.data.x,e.data.y);this._proxyRFBMessage("screenRegistrationConfirmed",[this._display.screens[n].screenID,n]),this._sendEncodings(),clearTimeout(this._resizeTimeout),this._resizeTimeout=setTimeout(this._requestRemoteResize.bind(this),500),this.dispatchEvent(new CustomEvent("screenregistered",{detail:i})),I(`Secondary monitor (${e.data.screenID}) has been registered.`);break;case"reattach":this._display.addScreen(e.data.screenID,e.data.width,e.data.height,e.data.pixelRatio,e.data.containerHeight,e.data.containerWidth,e.data.scale,e.data.serverWidth,e.data.serverHeight,e.data.x,e.data.y),clearTimeout(this._resizeTimeout),this._resizeTimeout=setTimeout(this._requestRemoteResize.bind(this),500),this.dispatchEvent(new CustomEvent("screenregistered",{})),I(`Secondary monitor (${e.data.screenID}) has been reattached.`);break;case"unregister":if(this._display.removeScreen(e.data.screenID)){this.dispatchEvent(new CustomEvent("screenregistered",{})),I(`Secondary monitor (${e.data.screenID}) has been removed.`);const r=this._screenSize();R.messages.setDesktopSize(this._sock,r,this._screenFlags),this._sendEncodings(),this._updateContinuousUpdates(),this.dispatchEvent(new CustomEvent("screenregistered",{}))}else I(`Secondary monitor (${e.data.screenID}) not found.`);break;case"mousemove":t=this._display.getServerRelativeCoordinates(e.data.screenIndex,e.data.args[0],e.data.args[1]),this._mouseLastScreenIndex=e.data.screenIndex,this._mousePos={x:t[0],y:t[1]},this._mouseButtonMask!==0&&!e.data.args[2]&&(this._mouseButtonMask=0),R.messages.pointerEvent(this._sock,this._mousePos.x,this._mousePos.y,this._mouseButtonMask),e.data.args[3]&&(this._mouseButtonMask|=1,R.messages.pointerEvent(this._sock,this._mousePos.x,this._mousePos.y,this._mouseButtonMask),this._mouseButtonMask&=-2,R.messages.pointerEvent(this._sock,this._mousePos.x,this._mousePos.y,this._mouseButtonMask),C("Simulated Left Click on secondary display."));break;case"mousedown":t=this._display.getServerRelativeCoordinates(e.data.screenIndex,e.data.args[0],e.data.args[1]),this._mouseLastScreenIndex=e.data.screenIndex,this._mousePos={x:t[0],y:t[1]},this._mouseButtonMask|=e.data.args[2],R.messages.pointerEvent(this._sock,this._mousePos.x,this._mousePos.y,this._mouseButtonMask);break;case"mouseup":t=this._display.getServerRelativeCoordinates(e.data.screenIndex,e.data.args[0],e.data.args[1]),this._mouseLastScreenIndex=e.data.screenIndex,this._mousePos={x:t[0],y:t[1]},this._mouseButtonMask&=~e.data.args[2],R.messages.pointerEvent(this._sock,this._mousePos.x,this._mousePos.y,this._mouseButtonMask);break;case"scroll":t=this._display.getServerRelativeCoordinates(e.data.screenIndex,e.data.args[0],e.data.args[1]),this._mouseLastScreenIndex=e.data.screenIndex,this._mousePos={x:t[0],y:t[1]},R.messages.pointerEvent(this._sock,this._mousePos.x,this._mousePos.y,0,e.data.args[2],e.data.args[3]);break;case"keyEvent":R.messages.keyEvent(this._sock,...e.data.args);break;case"sendBinaryClipboard":R.messages.sendBinaryClipboard(this._sock,...e.data.args);break}}else switch(e.data.eventType){case"updateCursor":this._updateCursor(...e.data.args),this._mouseLastScreenIndex=e.data.mouseLastScreenIndex;break;case"receivedClipboard":e.data.mouseLastScreenIndex===this._display.screenIndex&&this._write_binary_clipboard(...e.data.args);break;case"disconnect":this.disconnect();break;case"terminate":this.disconnect(),window.close();break;case"applySettings":this._isPrimaryDisplay||(this.enableHiDpi=e.data.args[0],this.clipViewport=e.data.args[1],this.scaleViewport=e.data.args[2],this.resizeSession=e.data.args[3],this.videoQuality=e.data.args[4],this.scaleViewport=e.data.args[3],this.updateConnectionSettings());break;case"applyScreenPlan":e.data.args[0]==this._display.screenID&&(this._display.screens[0].screenIndex=e.data.args[1],this._display.screens[0].width=e.data.args[2],this._display.screens[0].height=e.data.args[3],this._display.screens[0].x=e.data.args[4],this._display.screens[0].y=e.data.args[5],this.updateConnectionSettings());break;case"screenRegistrationConfirmed":e.data.args[0]==this._display.screenID&&(this._display.screens[0].screenIndex=e.data.args[1]);break}}_unregisterSecondaryDisplay(){if(!this._isPrimaryDisplay){let e={eventType:"unregister",screenID:this._display.screenID};this._controlChannel.postMessage(e)}}_registerSecondaryDisplay(e=!1,t=null){if(!this._isPrimaryDisplay){const i=e?"reattach":"register";let n=this._screenSize();this._display.resize(n.screens[0].serverWidth,n.screens[0].serverHeight),this._display.autoscale(n.screens[0].serverWidth,n.screens[0].serverHeight,n.screens[0].scale);let r=n.screens[0],a={eventType:i,screenID:r.screenID,width:r.width,height:r.height,x:e.x||0,y:e.y||0,pixelRatio:r.pixelRatio,scale:r.scale,serverWidth:r.serverWidth,serverHeight:r.serverHeight,containerWidth:r.containerWidth,containerHeight:r.containerHeight,channel:null,details:t};return this._controlChannel.postMessage(a),this._viewOnly||this._keyboard.grab(),r}}identify(e){let t={eventType:"identify",screens:e};this._controlChannel.postMessage(t)}_handleSecondaryDisplayMessage(e){this._isPrimaryDisplay}_handleMessage(){if(this._sock.rQlen===0){V("handleMessage called on an empty receive queue");return}switch(this._rfbConnectionState){case"disconnected":A("Got data while disconnected");break;case"connected":for(;!(this._flushing||!this._normalMsg()||this._sock.rQlen===0););break;default:this._initMsg();break}}_handleKeyEvent(e,t,i){this.sendKey(e,t,i)}_handleMouseOut(e){e.toElement!==null&&e.relatedTarget===null&&e.fromElement===null&&this._display.screens[0].pixelRatio!==window.devicePixelRatio&&(C("Window moved to another screen with different pixel ratio, sending resize request."),this._isPrimaryDisplay&&this._display.screens.length>1?this.dispatchEvent(new CustomEvent("screenregistered",{})):this._requestRemoteResize())}_handleMouse(e){if(e.type==="click"&&e.target!==this._canvas)return;if(e.stopPropagation(),e.type==="click"||e.type==="contextmenu"){e.preventDefault();return}let t;if(this._pointerLock&&!this._pointerRelativeEnabled){let n=this._display.scale===1?this._fbWidth:this._fbWidth*this._display.scale,r=this._display.scale===1?this._fbHeight:this._fbHeight*this._display.scale;t={x:this._mousePos.x+e.movementX,y:this._mousePos.y+e.movementY},t.x<0?t.x=0:t.x>n&&(t.x=n),t.y<0?t.y=0:t.y>r&&(t.y=r),this._cursor.move(t.x,t.y)}else this._pointerLock&&this._pointerRelativeEnabled?t={x:this._mousePos.x+e.movementX,y:this._mousePos.y+e.movementY}:t=Xe(e.clientX,e.clientY,this._canvas);this._mouseLastScreenIndex=this._display.screenIndex,this._setLastActive();const i=this.mouseButtonMapper.get(e.button);switch(e.type){case"mousedown":(this._display.screens.length===0||window.self===window.top)&&e.preventDefault(),Ys(this._canvas),ue()&&e.metaKey&&(this._keyboard._keyDownList.MetaLeft||this._keyboard._keyDownList.MetaRight)&&(this._keyboard._sendKeyEvent(this._keyboard._keyDownList.MetaLeft,"MetaLeft",!1),this._keyboard._sendKeyEvent(this._keyboard._keyDownList.MetaRight,"MetaRight",!1),this._keyboard._sendKeyEvent(_.XK_Control_L,"ControlLeft",!0)),this._keyboard.clearKeysDown(e),this._isPrimaryDisplay?this._handleMouseButton(t.x,t.y,!0,nt(i)):this._proxyRFBMessage("mousedown",[t.x,t.y,nt(i)]),C("Mouse Down");break;case"mouseup":e.preventDefault(),this._isPrimaryDisplay?this._handleMouseButton(t.x,t.y,!1,nt(i)):this._proxyRFBMessage("mouseup",[t.x,t.y,nt(i)]),C("Mouse Up");break;case"mousemove":e.preventDefault(),this._isPrimaryDisplay?this._handleMouseMove(t.x,t.y,e.buttons>0):(this._proxyRFBMessage("mousemove",[t.x,t.y,e.buttons>0,this._sendLeftClickonNextMove]),this._sendLeftClickonNextMove=!1);break;default:e.preventDefault();break}}_handleMouseButton(e,t,i,n){if(this.dragViewport)if(i&&!this._viewportDragging){this._viewportDragging=!0,this._viewportDragPos={x:e,y:t},this._viewportHasMoved=!1;return}else{if(this._viewportDragging=!1,this._viewportHasMoved)return;this._sendMouse(e,t,n)}this._mouseMoveTimer!==null&&(clearTimeout(this._mouseMoveTimer),this._mouseMoveTimer=null,this._sendMouse(e,t,this._mouseButtonMask)),i?this._mouseButtonMask|=n:this._mouseButtonMask&=~n,this._sendMouse(e,t,this._mouseButtonMask),this._sendLeftClickonNextMove=!1}_handleMouseMove(e,t,i,n=!1){if(this._viewportDragging){const r=this._viewportDragPos.x-e,a=this._viewportDragPos.y-t;(this._viewportHasMoved||Math.abs(r)>Jt||Math.abs(a)>Jt)&&(this._viewportHasMoved=!0,this._viewportDragPos={x:e,y:t},this._display.viewportChangePos(r,a));return}if(this._display.screens.length>1&&this._mouseButtonMask!==0&&!i&&!n&&zs()&&(this._mouseButtonMask=0,C("Mouse event button down mismatch with current mask, resetting mask to 0.")),this._mousePos={x:e,y:t},this._mouseMoveTimer==null){const r=Date.now()-this._mouseLastMoveTime;r>hs?(this._sendMouse(e,t,this._mouseButtonMask),this._mouseLastMoveTime=Date.now()):this._mouseMoveTimer=setTimeout(()=>{this._handleDelayedMouseMove()},hs-r)}this._sendLeftClickonNextMove&&this._display.screens.length>1&&(this._sendLeftClickonNextMove=!1,this._handleMouseButton(this._mousePos.x,this._mousePos.y,!0,1),this._handleMouseButton(this._mousePos.x,this._mousePos.y,!1,1))}_handleDelayedMouseMove(){this._mouseMoveTimer=null,this._sendMouse(this._mousePos.x,this._mousePos.y,this._mouseButtonMask),this._mouseLastMoveTime=Date.now()}_handlePointerLockChange(e){document.pointerLockElement===this._canvas||document.mozPointerLockElement===this._canvas?(this._pointerLock=!0,this._cursor.setEmulateCursor(!0)):(this._pointerLock=!1,this._cursor.setEmulateCursor(!1)),this.dispatchEvent(new CustomEvent("inputlock",{detail:{pointer:this._pointerLock}}))}_handlePointerLockError(){this._pointerLockChanging=!1,this.dispatchEvent(new CustomEvent("inputlockerror",{detail:{pointer:this._pointerLock}}))}_sendMouse(e,t,i){if(this._rfbConnectionState==="connected"&&!this._viewOnly&&this._isPrimaryDisplay)if(this._pointerLock&&this._pointerRelativeEnabled){var n=ii(e-this._pointerLockPos.x),r=ii(t-this._pointerLockPos.y);R.messages.pointerEvent(this._sock,n,r,i),this._mousePos={x:this._pointerLockPos.x,y:this._pointerLockPos.y},this._cursor.move(this._pointerLockPos.x,this._pointerLockPos.y)}else R.messages.pointerEvent(this._sock,this._display.absX(e),this._display.absY(t),i)}_sendScroll(e,t,i,n){this._rfbConnectionState==="connected"&&(this._viewOnly||(this._isPrimaryDisplay?R.messages.pointerEvent(this._sock,this._display.absX(e),this._display.absY(t),0,i,n):this._proxyRFBMessage("scroll",[e,t,i,n])))}_handleWheel(e){if(this._rfbConnectionState!=="connected"||this._viewOnly)return;e.stopPropagation(),e.preventDefault(),this._keyboard.clearKeysDown(e),ue()&&(this._keyboard._keyDownList.MetaLeft||this._keyboard._keyDownList.MetaRight)&&(this._keyboard._sendKeyEvent(this._keyboard._keyDownList.MetaLeft,"MetaLeft",!1),this._keyboard._sendKeyEvent(this._keyboard._keyDownList.MetaRight,"MetaRight",!1),this._keyboard._sendKeyEvent(_.XK_Control_L,"ControlLeft",!0)),e.ctrlKey&&!this._keyboard._keyDownList.ControlLeft&&(this._keyboard._sendKeyEvent(_.XK_Control_L,"ControlLeft",!0),this._watchForPinchAndZoom=this._watchForPinchAndZoom||setInterval(()=>{+new Date-this._mouseLastPinchAndZoomTime>250&&(clearInterval(this._watchForPinchAndZoom),this._keyboard._sendKeyEvent(_.XK_Control_L,"ControlLeft",!1),this._watchForPinchAndZoom=null,this._mouseLastPinchAndZoomTime=0)},10)),this._watchForPinchAndZoom&&(this._mouseLastPinchAndZoomTime=+new Date);let t=e.deltaX,i=e.deltaY;e.deltaMode!==0&&(t*=ls,i*=ls);const n=Xe(e.clientX,e.clientY,this._canvas);this._sendScroll(n.x,n.y,t,i)}_fakeMouseMove(e,t,i){this._isPrimaryDisplay?(this._handleMouseMove(t,i,!1,!0),this._cursor.move(e.detail.clientX,e.detail.clientY)):(this._proxyRFBMessage("mousemove",[t,i,!0,!1]),this._cursor.move(e.detail.clientX,e.detail.clientY))}_handleTapEvent(e,t){let i=Xe(e.detail.clientX,e.detail.clientY,this._canvas);if(this._gestureLastTapTime!==null&&Date.now()-this._gestureLastTapTime<Gr&&this._gestureFirstDoubleTapEv.detail.type===e.detail.type){let n=this._gestureFirstDoubleTapEv.detail.clientX-e.detail.clientX,r=this._gestureFirstDoubleTapEv.detail.clientY-e.detail.clientY;Math.hypot(n,r)<Yr?i=Xe(this._gestureFirstDoubleTapEv.detail.clientX,this._gestureFirstDoubleTapEv.detail.clientY,this._canvas):this._gestureFirstDoubleTapEv=e}else this._gestureFirstDoubleTapEv=e;this._gestureLastTapTime=Date.now(),this._fakeMouseMove(this._gestureFirstDoubleTapEv,i.x,i.y),this._fakeMouseButton(i.x,i.y,!0,t),this._fakeMouseButton(i.x,i.y,!1,t)}_fakeMouseButton(e,t,i,n){this._isPrimaryDisplay?this._handleMouseButton(e,t,i,n):i?this._proxyRFBMessage("mousedown",[e,t,n]):this._proxyRFBMessage("mouseup",[e,t,n])}_handleGesture(e){let t,i=Xe(e.detail.clientX,e.detail.clientY,this._canvas);switch(e.type){case"gesturestart":switch(e.detail.type){case"onetap":this._handleTapEvent(e,1);break;case"twotap":this._handleTapEvent(e,4);break;case"threetap":this._handleTapEvent(e,2);break;case"drag":this._fakeMouseMove(e,i.x,i.y),this._fakeMouseButton(i.x,i.y,!0,1);break;case"longpress":this._fakeMouseMove(e,i.x,i.y),this._fakeMouseButton(i.x,i.y,!0,4);break;case"twodrag":this._gestureLastMagnitudeX=e.detail.magnitudeX,this._gestureLastMagnitudeY=e.detail.magnitudeY,this._fakeMouseMove(e,i.x,i.y);break;case"pinch":this._gestureLastMagnitudeX=Math.hypot(e.detail.magnitudeX,e.detail.magnitudeY),this._fakeMouseMove(e,i.x,i.y);break}break;case"gesturemove":switch(e.detail.type){case"onetap":case"twotap":case"threetap":break;case"drag":case"longpress":this._fakeMouseMove(e,i.x,i.y);break;case"twodrag":for(this._fakeMouseMove(e,i.x,i.y);e.detail.magnitudeY-this._gestureLastMagnitudeY>ve;)this._fakeMouseButton(i.x,i.y,!0,8),this._fakeMouseButton(i.x,i.y,!1,8),this._gestureLastMagnitudeY+=ve;for(;e.detail.magnitudeY-this._gestureLastMagnitudeY<-50;)this._fakeMouseButton(i.x,i.y,!0,16),this._fakeMouseButton(i.x,i.y,!1,16),this._gestureLastMagnitudeY-=ve;for(;e.detail.magnitudeX-this._gestureLastMagnitudeX>ve;)this._fakeMouseButton(i.x,i.y,!0,32),this._fakeMouseButton(i.x,i.y,!1,32),this._gestureLastMagnitudeX+=ve;for(;e.detail.magnitudeX-this._gestureLastMagnitudeX<-50;)this._fakeMouseButton(i.x,i.y,!0,64),this._fakeMouseButton(i.x,i.y,!1,64),this._gestureLastMagnitudeX-=ve;break;case"pinch":if(this._fakeMouseMove(e,i.x,i.y),t=Math.hypot(e.detail.magnitudeX,e.detail.magnitudeY),Math.abs(t-this._gestureLastMagnitudeX)>rt){for(this._handleKeyEvent(_.XK_Control_L,"ControlLeft",!0);t-this._gestureLastMagnitudeX>rt;)this._fakeMouseButton(i.x,i.y,!0,8),this._fakeMouseButton(i.x,i.y,!1,8),this._gestureLastMagnitudeX+=rt;for(;t-this._gestureLastMagnitudeX<-75;)this._fakeMouseButton(i.x,i.y,!0,16),this._fakeMouseButton(i.x,i.y,!1,16),this._gestureLastMagnitudeX-=rt}this._handleKeyEvent(_.XK_Control_L,"ControlLeft",!1);break}break;case"gestureend":switch(e.detail.type){case"onetap":case"twotap":case"threetap":case"pinch":case"twodrag":break;case"drag":this._fakeMouseMove(e,i.x,i.y),this._fakeMouseButton(i.x,i.y,!1,1);break;case"longpress":this._fakeMouseMove(e,i.x,i.y),this._fakeMouseButton(i.x,i.y,!1,4);break}break}}_negotiateProtocolVersion(){if(this._sock.rQwait("version",12))return!1;const e=this._sock.rQshiftStr(12).substr(4,7);I("Server ProtocolVersion: "+e);let t=0;switch(e){case"000.000":t=1;break;case"003.003":case"003.006":case"003.889":this._rfbVersion=3.3;break;case"003.007":this._rfbVersion=3.7;break;case"003.008":case"004.000":case"004.001":case"005.000":this._rfbVersion=3.8;break;default:return this._fail("Invalid server version "+e)}if(t){let n="ID:"+this._repeaterID;for(;n.length<250;)n+="\0";return this._sock.sendString(n),!0}this._rfbVersion>this._rfbMaxVersion&&(this._rfbVersion=this._rfbMaxVersion);const i="00"+parseInt(this._rfbVersion,10)+".00"+this._rfbVersion*10%10;this._sock.sendString("RFB "+i+`
`),C("Sent ProtocolVersion: "+i),this._rfbInitState="Security"}_negotiateSecurity(){if(this._rfbVersion>=3.7){const e=this._sock.rQshift8();if(this._sock.rQwait("security type",e,1))return!1;if(e===0)return this._rfbInitState="SecurityReason",this._securityContext="no security types",this._securityStatus=1,this._initMsg();const t=this._sock.rQshiftBytes(e);if(C("Server security types: "+t),t.includes(1))this._rfbAuthScheme=1;else if(t.includes(22))this._rfbAuthScheme=22;else if(t.includes(16))this._rfbAuthScheme=16;else if(t.includes(2))this._rfbAuthScheme=2;else if(t.includes(19))this._rfbAuthScheme=19;else return this._fail("Unsupported security types (types: "+t+")");this._sock.send([this._rfbAuthScheme])}else{if(this._sock.rQwait("security scheme",4))return!1;if(this._rfbAuthScheme=this._sock.rQshift32(),this._rfbAuthScheme==0)return this._rfbInitState="SecurityReason",this._securityContext="authentication scheme",this._securityStatus=1,this._initMsg()}return this._rfbInitState="Authentication",C("Authenticating using scheme: "+this._rfbAuthScheme),this._initMsg()}_handleSecurityReason(){if(this._sock.rQwait("reason length",4))return!1;const e=this._sock.rQshift32();let t="";if(e>0){if(this._sock.rQwait("reason",e,4))return!1;t=this._sock.rQshiftStr(e)}return t!==""?(this.dispatchEvent(new CustomEvent("securityfailure",{detail:{status:this._securityStatus,reason:t}})),this._fail("Security negotiation failed on "+this._securityContext+" (reason: "+t+")")):(this.dispatchEvent(new CustomEvent("securityfailure",{detail:{status:this._securityStatus}})),this._fail("Security negotiation failed on "+this._securityContext))}_negotiateXvpAuth(){if(this._rfbCredentials.username===void 0||this._rfbCredentials.password===void 0||this._rfbCredentials.target===void 0)return this.dispatchEvent(new CustomEvent("credentialsrequired",{detail:{types:["username","password","target"]}})),!1;const e=String.fromCharCode(this._rfbCredentials.username.length)+String.fromCharCode(this._rfbCredentials.target.length)+this._rfbCredentials.username+this._rfbCredentials.target;return this._sock.sendString(e),this._rfbAuthScheme=2,this._negotiateAuthentication()}_negotiateVeNCryptAuth(){if(this._rfbVeNCryptState==0){if(this._sock.rQwait("vencrypt version",2))return!1;const e=this._sock.rQshift8(),t=this._sock.rQshift8();if(!(e==0&&t==2))return this._fail("Unsupported VeNCrypt version "+e+"."+t);this._sock.send([0,2]),this._rfbVeNCryptState=1}if(this._rfbVeNCryptState==1){if(this._sock.rQwait("vencrypt ack",1))return!1;const e=this._sock.rQshift8();if(e!=0)return this._fail("VeNCrypt failure "+e);this._rfbVeNCryptState=2}if(this._rfbVeNCryptState==2){if(this._sock.rQwait("vencrypt subtypes length",1))return!1;const e=this._sock.rQshift8();if(e<1)return this._fail("VeNCrypt subtypes empty");this._rfbVeNCryptSubtypesLength=e,this._rfbVeNCryptState=3}if(this._rfbVeNCryptState==3){if(this._sock.rQwait("vencrypt subtypes",4*this._rfbVeNCryptSubtypesLength))return!1;const e=[];for(let t=0;t<this._rfbVeNCryptSubtypesLength;t++)e.push(this._sock.rQshift32());if(e.indexOf(256)!=-1)this._sock.send([0,0,1,0]),this._rfbVeNCryptState=4;else return this._fail("VeNCrypt Plain subtype not offered by server")}if(this._rfbVeNCryptState==4){if(this._rfbCredentials.username===void 0||this._rfbCredentials.password===void 0)return this.dispatchEvent(new CustomEvent("credentialsrequired",{detail:{types:["username","password"]}})),!1;const e=Ht(this._rfbCredentials.username),t=Ht(this._rfbCredentials.password);return this._sock.send([e.length>>24&255,e.length>>16&255,e.length>>8&255,e.length&255]),this._sock.send([t.length>>24&255,t.length>>16&255,t.length>>8&255,t.length&255]),this._sock.sendString(e),this._sock.sendString(t),this._rfbInitState="SecurityResult",!0}}_negotiateStdVNCAuth(){if(this._sock.rQwait("auth challenge",16))return!1;this._rfbCredentials.password="";const e=Array.prototype.slice.call(this._sock.rQshiftBytes(16)),t=R.genDES(this._rfbCredentials.password,e);return this._sock.send(t),this._rfbInitState="SecurityResult",!0}_negotiateTightUnixAuth(){return this._rfbCredentials.username===void 0||this._rfbCredentials.password===void 0?(this.dispatchEvent(new CustomEvent("credentialsrequired",{detail:{types:["username","password"]}})),!1):(this._sock.send([0,0,0,this._rfbCredentials.username.length]),this._sock.send([0,0,0,this._rfbCredentials.password.length]),this._sock.sendString(this._rfbCredentials.username),this._sock.sendString(this._rfbCredentials.password),this._rfbInitState="SecurityResult",!0)}_negotiateTightTunnels(e){const t={0:{vendor:"TGHT",signature:"NOTUNNEL"}},i={};for(let n=0;n<e;n++){const r=this._sock.rQshift32(),a=this._sock.rQshiftStr(4),h=this._sock.rQshiftStr(8);i[r]={vendor:a,signature:h}}return C("Server Tight tunnel types: "+i),i[1]&&i[1].vendor==="SICR"&&i[1].signature==="SCHANNEL"&&(C("Detected Siemens server. Assuming NOTUNNEL support."),i[0]={vendor:"TGHT",signature:"NOTUNNEL"}),i[0]?i[0].vendor!=t[0].vendor||i[0].signature!=t[0].signature?this._fail("Client's tunnel type had the incorrect vendor or signature"):(C("Selected tunnel type: "+t[0]),this._sock.send([0,0,0,0]),!1):this._fail("Server wanted tunnels, but doesn't support the notunnel type")}_negotiateTightAuth(){if(!this._rfbTightVNC){if(this._sock.rQwait("num tunnels",4))return!1;const n=this._sock.rQshift32();if(n>0&&this._sock.rQwait("tunnel capabilities",16*n,4))return!1;if(this._rfbTightVNC=!0,n>0)return this._negotiateTightTunnels(n),!1}if(this._sock.rQwait("sub auth count",4))return!1;const e=this._sock.rQshift32();if(e===0)return this._rfbInitState="SecurityResult",!0;if(this._sock.rQwait("sub auth capabilities",16*e,4))return!1;const t={STDVNOAUTH__:1,STDVVNCAUTH_:2,TGHTULGNAUTH:129},i=[];for(let n=0;n<e;n++){this._sock.rQshift32();const r=this._sock.rQshiftStr(12);i.push(r)}C("Server Tight authentication types: "+i);for(let n in t)if(i.indexOf(n)!=-1)switch(this._sock.send([0,0,0,t[n]]),C("Selected authentication type: "+n),n){case"STDVNOAUTH__":return this._rfbInitState="SecurityResult",!0;case"STDVVNCAUTH_":return this._rfbAuthScheme=2,this._initMsg();case"TGHTULGNAUTH":return this._rfbAuthScheme=129,this._initMsg();default:return this._fail("Unsupported tiny auth scheme (scheme: "+n+")")}return this._fail("No supported sub-auth types!")}_negotiateAuthentication(){switch(this._rfbAuthScheme){case 1:return this._rfbVersion>=3.8?(this._rfbInitState="SecurityResult",!0):(this._rfbInitState="ClientInitialisation",this._initMsg());case 22:return this._negotiateXvpAuth();case 2:return this._negotiateStdVNCAuth();case 16:return this._negotiateTightAuth();case 19:return this._negotiateVeNCryptAuth();case 129:return this._negotiateTightUnixAuth();default:return this._fail("Unsupported auth scheme (scheme: "+this._rfbAuthScheme+")")}}_handleSecurityResult(){if(this._sock.rQwait("VNC auth response ",4))return!1;const e=this._sock.rQshift32();return e===0?(this._rfbInitState="ClientInitialisation",C("Authentication OK"),this._initMsg()):this._rfbVersion>=3.8?(this._rfbInitState="SecurityReason",this._securityContext="security result",this._securityStatus=e,this._initMsg()):(this.dispatchEvent(new CustomEvent("securityfailure",{detail:{status:e}})),this._fail("Security handshake failed"))}_negotiateServerInit(){if(this._sock.rQwait("server initialization",24))return!1;const e=this._sock.rQshift16(),t=this._sock.rQshift16(),i=this._sock.rQshift8(),n=this._sock.rQshift8(),r=this._sock.rQshift8(),a=this._sock.rQshift8(),h=this._sock.rQshift16(),l=this._sock.rQshift16(),o=this._sock.rQshift16(),c=this._sock.rQshift8(),u=this._sock.rQshift8(),x=this._sock.rQshift8();this._sock.rQskipBytes(3);const f=this._sock.rQshift32();if(this._sock.rQwait("server init name",f,24))return!1;let p=this._sock.rQshiftStr(f);if(p=yt(p,!0),this._rfbTightVNC){if(this._sock.rQwait("TightVNC extended server init header",8,24+f))return!1;const F=this._sock.rQshift16(),E=this._sock.rQshift16(),K=this._sock.rQshift16();this._sock.rQskipBytes(2);const Q=(F+E+K)*16;if(this._sock.rQwait("TightVNC extended server init header",Q,32+f))return!1;this._sock.rQskipBytes(16*F),this._sock.rQskipBytes(16*E),this._sock.rQskipBytes(16*K)}return I("Screen: "+e+"x"+t+", bpp: "+i+", depth: "+n+", bigEndian: "+r+", trueColor: "+a+", redMax: "+h+", greenMax: "+l+", blueMax: "+o+", redShift: "+c+", greenShift: "+u+", blueShift: "+x),this._setDesktopName(p),this._resize(e,t),this._viewOnly||this._keyboard.grab(),this._fbDepth=24,this._fbName==="Intel(r) AMT KVM"&&(V("Intel AMT KVM only supports 8/16 bit depths. Using low color mode."),this._fbDepth=8),R.messages.pixelFormat(this._sock,this._fbDepth,!0),this._sendEncodings(),R.messages.fbUpdateRequest(this._sock,!1,0,0,this._fbWidth,this._fbHeight),this._updateConnectionState("connected"),Er(this),!0}_hasWebp(){if(!this.enableWebP)return!1;var e=navigator.userAgent.toLowerCase(),t=e.match(/firefox\/([0-9]+)\./);return!!(t&&parseInt(t[1])>=65||(t=e.match(/chrome\/([0-9]+)\./),t&&parseInt(t[1])>=23))}_sendEncodings(){const e=[];this._display.screens.length===1?e.push(X.encodingCopyRect):C("Multiple displays detected, disabling copyrect encoding."),this._fbDepth==24&&(e.push(X.encodingTight),e.push(X.encodingTightPNG),e.push(X.encodingHextile),e.push(X.encodingRRE)),e.push(X.encodingRaw),e.push(X.pseudoEncodingQualityLevel0+this._qualityLevel),e.push(X.pseudoEncodingCompressLevel0+this._compressionLevel),e.push(X.pseudoEncodingDesktopSize),e.push(X.pseudoEncodingLastRect),e.push(X.pseudoEncodingQEMUExtendedKeyEvent),e.push(X.pseudoEncodingExtendedDesktopSize),e.push(X.pseudoEncodingXvp),e.push(X.pseudoEncodingFence),e.push(X.pseudoEncodingContinuousUpdates),e.push(X.pseudoEncodingDesktopName),e.push(X.pseudoEncodingExtendedClipboard),this._hasWebp()&&e.push(X.pseudoEncodingWEBP),this._enableQOI&&e.push(X.pseudoEncodingQOI),e.push(X.pseudoEncodingJpegVideoQualityLevel0+this.jpegVideoQuality),e.push(X.pseudoEncodingWebpVideoQualityLevel0+this.webpVideoQuality),e.push(X.pseudoEncodingTreatLosslessLevel0+this.treatLossless),e.push(X.pseudoEncodingDynamicQualityMinLevel0+this.dynamicQualityMin),e.push(X.pseudoEncodingDynamicQualityMaxLevel0+this.dynamicQualityMax),e.push(X.pseudoEncodingVideoAreaLevel1+this.videoArea-1),e.push(X.pseudoEncodingVideoTimeLevel0+this.videoTime),e.push(X.pseudoEncodingVideoOutTimeLevel1+this.videoOutTime-1),e.push(X.pseudoEncodingVideoScalingLevel0+this.videoScaling),e.push(X.pseudoEncodingFrameRateLevel10+this.frameRate-10),e.push(X.pseudoEncodingMaxVideoResolution),this.preferBandwidth&&e.push(X.pseudoEncodingPreferBandwidth),this._fbDepth==24&&(e.push(X.pseudoEncodingVMwareCursor),e.push(X.pseudoEncodingCursor)),e.push(X.pseudoEncodingVMwareCursorPosition),R.messages.clientEncodings(this._sock,e)}_initMsg(){switch(this._rfbInitState){case"ProtocolVersion":return this._negotiateProtocolVersion();case"Security":return this._negotiateSecurity();case"Authentication":return this._negotiateAuthentication();case"SecurityResult":return this._handleSecurityResult();case"SecurityReason":return this._handleSecurityReason();case"ClientInitialisation":return this._sock.send([this._shared?1:0]),this._rfbInitState="ServerInitialisation",!0;case"ServerInitialisation":return this._negotiateServerInit();default:return this._fail("Unknown init state (state: "+this._rfbInitState+")")}}_handleSetColourMapMsg(){return C("SetColorMapEntries"),this._fail("Unexpected SetColorMapEntries message")}_handleServerCutText(){if(C("ServerCutText"),this._sock.rQwait("ServerCutText header",7,1))return!1;this._sock.rQskipBytes(3);let e=this._sock.rQshift32();if(e=Re(e),this._sock.rQwait("ServerCutText content",Math.abs(e),8))return!1;if(e>=0){const t=this._sock.rQshiftStr(e);if(this._viewOnly)return!0;this.dispatchEvent(new CustomEvent("clipboard",{detail:{text:t}})),this._clipHash=0}else{e=Math.abs(e);const t=this._sock.rQshift32();let i=t&65535,n=t&4278190080;if(!!(n&cs)){this._clipboardServerCapabilitiesFormats={},this._clipboardServerCapabilitiesActions={};for(let h=0;h<=15;h++){let l=1<<h;i&l&&(this._clipboardServerCapabilitiesFormats[l]=!0,this._sock.rQshift32())}for(let h=24;h<=31;h++){let l=1<<h;this._clipboardServerCapabilitiesActions[l]=!!(n&l)}let a=[cs,ht,ds,lt,ct];R.messages.extendedClipboardCaps(this._sock,a,{extendedClipboardFormatText:0})}else if(n===ht){if(this._viewOnly)return!0;this._clipboardText!=null&&this._clipboardServerCapabilitiesActions[ct]&&i&ae&&R.messages.extendedClipboardProvide(this._sock,[ae],[this._clipboardText])}else if(n===ds){if(this._viewOnly)return!0;this._clipboardServerCapabilitiesActions[lt]&&(this._clipboardText!=null?R.messages.extendedClipboardNotify(this._sock,[ae]):R.messages.extendedClipboardNotify(this._sock,[]))}else if(n===lt){if(this._viewOnly)return!0;this._clipboardServerCapabilitiesActions[ht]&&i&ae&&R.messages.extendedClipboardRequest(this._sock,[ae])}else if(n===ct){if(this._viewOnly||!(i&ae))return!0;this._clipboardText=null;let a=this._sock.rQshiftBytes(e-4),h=new ut,l=null;h.setInput(a);for(let o=0;o<=15;o++){let c=1<<o;if(i&c){let u=0,x=h.inflate(4);u|=x[0]<<24,u|=x[1]<<16,u|=x[2]<<8,u|=x[3];let f=h.inflate(u);c===ae&&(l=f)}}if(h.setInput(null),l!==null){let o="";for(let c=0;c<l.length;c++)o+=String.fromCharCode(l[c]);l=o,l=yt(l),l.length>0&&l.charAt(l.length-1)==="\0"&&(l=l.slice(0,-1)),l=l.replace(`\r
`,`
`),this.dispatchEvent(new CustomEvent("clipboard",{detail:{text:l}}))}}else return this._fail("Unexpected action in extended clipboard message: "+n)}return!0}_handleBinaryClipboard(){if(C("HandleBinaryClipboard"),this._sock.rQwait("Binary Clipboard header",2,1))return!1;let e=this._sock.rQshift8(),t={},i=2,n="";I(e+" Clipboard items recieved."),C("Started clipbooard processing with Client sockjs buffer size "+this._sock.rQlen);for(let r=0;r<e;r++){if(this._sock.rQwait("Binary Clipboard op id",4,i))return!1;i+=4;let a=this._sock.rQshift32();if(this._sock.rQwait("Binary Clipboard mimelen",1,i))return!1;i++;let h=this._sock.rQshift8();if(this._sock.rQwait("Binary Clipboard mime",Math.abs(h),i))return!1;i+=h;let l=this._sock.rQshiftStr(h);if(this._sock.rQwait("Binary Clipboard data len",4,i))return!1;i+=4;let o=this._sock.rQshift32();if(this._sock.rQwait("Binary Clipboard data",Math.abs(o),i))return!1;let c=this._sock.rQshiftBytes(o);switch(i+=o,l){case"image/png":case"text/html":case"text/plain":if(l=="text/plain"&&(n=new TextDecoder().decode(c),n.length>0&&n.charAt(n.length-1)==="\0"&&(n=n.slice(0,-1)),C("Plain text clipboard recieved and placed in text element, size: "+n.length),this.dispatchEvent(new CustomEvent("clipboard",{detail:{text:n}}))),I("Processed binary clipboard (ID: "+a+")  of MIME "+l+" of length "+o),!this.clipboardBinary)continue;t[l]=new Blob([c],{type:l});break;default:C("Mime type skipped: "+l);break}}return C("Finished processing binary clipboard with client sockjs buffer size "+this._sock.rQlen),Object.keys(t).length>0&&this.clipboardBinary&&(this._clipHash=0,this._mouseLastScreenIndex===0?this._write_binary_clipboard(t,n):this._proxyRFBMessage("receivedClipboard",[t,n])),!0}_write_binary_clipboard(e,t){navigator.clipboard.write([new ClipboardItem(e)]).then(()=>{t&&(this._clipHash=Ae(t))},i=>{A("Error writing to client clipboard: "+i),t.length>0&&navigator.clipboard.writeText(t).then(()=>{this._clipHash=Ae(t)},n=>{A("Error writing text to client clipboard: "+n)})})}_handle_server_stats_msg(){this._sock.rQskipBytes(3);const e=this._sock.rQshift32();if(this._sock.rQwait("KASM bottleneck stats",e,8))return!1;const t=this._sock.rQshiftStr(e);return C("Received KASM bottleneck stats:"),C(t),this.dispatchEvent(new CustomEvent("bottleneck_stats",{detail:{text:t}})),!0}_handleServerFenceMsg(){if(this._sock.rQwait("ServerFence header",8,1))return!1;this._sock.rQskipBytes(3);let e=this._sock.rQshift32(),t=this._sock.rQshift8();if(this._sock.rQwait("ServerFence payload",t,9))return!1;t>64&&(V("Bad payload length ("+t+") in fence response"),t=64);const i=this._sock.rQshiftStr(t);return this._supportsFence=!0,e&1<<31?(e&=3,R.messages.clientFence(this._sock,e,i),!0):this._fail("Unexpected fence response")}_handleXvpMsg(){if(this._sock.rQwait("XVP version and message",3,1))return!1;this._sock.rQskipBytes(1);const e=this._sock.rQshift8(),t=this._sock.rQshift8();switch(t){case 0:A("XVP Operation Failed");break;case 1:this._rfbXvpVer=e,I("XVP extensions enabled (version "+this._rfbXvpVer+")"),this._setCapability("power",!0);break;default:this._fail("Illegal server XVP message (msg: "+t+")");break}return!0}_normalMsg(){let e;this._FBU.rects>0?e=0:e=this._sock.rQshift8();let t,i;switch(e){case 0:return this._display.renderMs=0,i=this._framebufferUpdate(),i&&!this._enabledContinuousUpdates&&R.messages.fbUpdateRequest(this._sock,!0,0,0,this._fbWidth,this._fbHeight),this._trackFrameStats&&(R.messages.sendFrameStats(this._sock,this._display.fps,this._display.renderMs),this._trackFrameStats=!1),i;case 1:return this._handleSetColourMapMsg();case 2:return C("Bell"),this.dispatchEvent(new CustomEvent("bell",{detail:{}})),!0;case 3:return this._handleServerCutText();case 150:return t=!this._supportsContinuousUpdates,this._supportsContinuousUpdates=!0,this._enabledContinuousUpdates=!1,t&&(this._enabledContinuousUpdates=!0,this._updateContinuousUpdates(),I("Enabling continuous updates.")),!0;case 178:return this._handle_server_stats_msg();case 179:return this._trackFrameStats=!0,!0;case 180:return this._handleBinaryClipboard();case 181:return this._handleUdpUpgrade();case 182:return this._handleSubscribeUnixRelay();case 183:return this._handleUnixRelay();case 248:return this._handleServerFenceMsg();case 250:return this._handleXvpMsg();default:return this._fail("Unexpected server message (type "+e+")"),C("sock.rQslice(0, 30): "+this._sock.rQslice(0,30)),!0}}_onFlush(){this._flushing=!1,this._sock.rQlen>0&&this._handleMessage()}_handleUdpRect(e,t){let i={x:(e[0]<<8)+e[1],y:(e[2]<<8)+e[3],width:(e[4]<<8)+e[5],height:(e[6]<<8)+e[7],encoding:parseInt((e[8]<<24)+(e[9]<<16)+(e[10]<<8)+e[11],10)};switch(i.encoding){case X.pseudoEncodingLastRect:this._display.flip(t,i.x+1),this._display.pending()&&this._display.flush(!1);break;case X.encodingTight:let n=this._decoders[X.encodingUDP];try{n.decodeRect(i.x,i.y,i.width,i.height,e,this._display,this._fbDepth,t)}catch(r){return this._fail("Error decoding rect: "+r),!1}break;default:return A("Invalid rect encoding via UDP: "+i.encoding),!1}return!0}_sendUdpUpgrade(){if(this._transitConnectionState==this.TransitConnectionStates.Upgrading)return;this._changeTransitConnectionState(this.TransitConnectionStates.Upgrading);let e=this._udpPeer,t=this._sock;e.createOffer().then(function(i){return e.setLocalDescription(i)}).then(function(){const i=t._sQ,n=t._sQlen,r=Uint8Array.from(Array.from(e.localDescription.sdp).map(a=>a.charCodeAt(0)));i[n]=181,i[n+1]=r.length>>8,i[n+2]=r.length,i.set(r,n+3),t._sQlen+=3+r.length,t.flush()}).catch(function(i){A("Failed to create offer "+i),this._changeTransitConnectionState(this.TransitConnectionStates.Tcp),this._udpConnectFailures++})}_sendUdpDowngrade(){this._changeTransitConnectionState(this.TransitConnectionStates.Downgrading);const e=this._sock._sQ,t=this._sock._sQlen;e[t]=181,e[t+1]=0,e[t+2]=0,this._sock._sQlen+=3,this._sock.flush()}_handleUdpUpgrade(){if(this._sock.rQwait("UdpUgrade header",2,1))return!1;let e=this._sock.rQshift16();if(this._sock.rQwait("UdpUpgrade payload",e,3))return!1;const t=this._sock.rQshiftStr(e);let i=this._udpPeer;var n=JSON.parse(t);C("UDP Upgrade recieved from server: "+t),i.setRemoteDescription(new RTCSessionDescription(n.answer)).then((function(){var r=new RTCIceCandidate(n.candidate);i.addIceCandidate(r).then((function(){C("success in addicecandidate")}).bind(this)).catch((function(a){A("Failure in addIceCandidate",a),this._changeTransitConnectionState(this.TransitConnectionStates.Failure),this._udpConnectFailures++}).bind(this))}).bind(this)).catch((function(r){A("Failure in setRemoteDescription",r),this._changeTransitConnectionState(this.TransitConnectionStates.Failure),this._udpConnectFailures++}).bind(this))}_handleSubscribeUnixRelay(){if(this._sock.rQwait("SubscribeUnixRelay header",2,1))return!1;let e=this._sock.rQshift8(),t=this._sock.rQshift8();if(this._sock.rQwait("SubscribeUnixRelay message",t,3))return!1;const i=this._sock.rQshiftStr(t);e?I("Unix relay subscription succeeded"):V("Unix relay subscription failed, "+i)}_handleUnixRelay(){if(this._sock.rQwait("UnixRelay header",1,1))return!1;let e=this._sock.rQshift8();if(this._sock.rQwait("UnixRelay name",e,2))return!1;const t=this._sock.rQshiftStr(e);if(this._sock.rQwait("UnixRelay len",4,2+e))return!1;let i=this._sock.rQshift32();if(this._sock.rQwait("UnixRelay data",i,6+e))return!1;const n=this._sock.rQshiftBytes(i),r=this._unixRelays[t];r&&r(n)}_framebufferUpdate(){if(this._FBU.rects===0){if(this._sock.rQwait("FBU header",3,1))return!1;if(this._sock.rQskipBytes(1),this._FBU.rects=this._sock.rQshift16(),this._FBU.frame_id++,this._FBU.rect_total=0,this._display.pending())return this._flushing=!0,this._display.flush(),!1}for(;this._FBU.rects>0;){if(this._FBU.encoding===null){if(this._sock.rQwait("rect header",12))return!1;const e=this._sock.rQshiftBytes(12);this._FBU.x=(e[0]<<8)+e[1],this._FBU.y=(e[2]<<8)+e[3],this._FBU.width=(e[4]<<8)+e[5],this._FBU.height=(e[6]<<8)+e[7],this._FBU.encoding=parseInt((e[8]<<24)+(e[9]<<16)+(e[10]<<8)+e[11],10)}if(!this._handleRect())return!1;this._FBU.rects--,this._FBU.encoding=null}return this._FBU.rect_total>1&&this._display.flip(this._FBU.frame_id,this._FBU.rect_total),!0}_handleRect(){switch(this._FBU.encoding){case X.pseudoEncodingLastRect:return this._FBU.rect_total++,this._FBU.rects=1,!0;case X.pseudoEncodingVMwareCursor:return this._handleVMwareCursor();case X.pseudoEncodingVMwareCursorPosition:return this._handleVMwareCursorPosition();case X.pseudoEncodingCursor:return this._handleCursor();case X.pseudoEncodingQEMUExtendedKeyEvent:return this._qemuExtKeyEventSupported=!0,!0;case X.pseudoEncodingDesktopName:return this._handleDesktopName();case X.pseudoEncodingDesktopSize:return this._resize(this._FBU.width,this._FBU.height),!0;case X.pseudoEncodingExtendedDesktopSize:return this._handleExtendedDesktopSize();default:return this._handleDataRect()?(this._FBU.rect_total++,!0):!1}}_handleVMwareCursor(){const e=this._FBU.x,t=this._FBU.y,i=this._FBU.width,n=this._FBU.height;if(this._sock.rQwait("VMware cursor encoding",1))return!1;const r=this._sock.rQshift8();this._sock.rQshift8();let a;const h=4;if(r==0){if(a=new Array(i*n*h),this._sock.rQwait("VMware cursor classic encoding",i*n*h*2,2))return!1;let o=new Array(i*n);for(let u=0;u<i*n;u++)o[u]=this._sock.rQshift32();let c=new Array(i*n);for(let u=0;u<i*n;u++)c[u]=this._sock.rQshift32();for(let u=0;u<i*n;u++)if(o[u]==0){let x=c[u],f=x>>8&255,p=x>>16&255,F=x>>24&255;a[u*h]=f,a[u*h+1]=p,a[u*h+2]=F,a[u*h+3]=255}else(o[u]&-256)==-256?c[u]==0?(a[u*h]=0,a[u*h+1]=0,a[u*h+2]=0,a[u*h+3]=0):(c[u]&-256,a[u*h]=0,a[u*h+1]=0,a[u*h+2]=0,a[u*h+3]=255):(a[u*h]=0,a[u*h+1]=0,a[u*h+2]=0,a[u*h+3]=255)}else if(r==1){if(this._sock.rQwait("VMware cursor alpha encoding",i*n*4,2))return!1;a=new Array(i*n*h);for(let l=0;l<i*n;l++){let o=this._sock.rQshift32();a[l*4]=o>>24&255,a[l*4+1]=o>>16&255,a[l*4+2]=o>>8&255,a[l*4+3]=o&255}}else return V("The given cursor type is not supported: "+r+" given."),!1;return this._updateCursor(a,e,t,i,n),!0}_handleVMwareCursorPosition(){const e=this._FBU.x,t=this._FBU.y;return this._pointerLock&&(this._mousePos={x:e,y:t}),!0}_handleCursor(){const e=this._FBU.x,t=this._FBU.y,i=this._FBU.width,n=this._FBU.height,r=i*n*4,a=Math.ceil(i/8)*n;let h=r+a;if(this._sock.rQwait("cursor encoding",h))return!1;const l=this._sock.rQshiftBytes(r),o=this._sock.rQshiftBytes(a);let c=new Uint8Array(i*n*4),u=0;for(let x=0;x<n;x++)for(let f=0;f<i;f++){let p=x*Math.ceil(i/8)+Math.floor(f/8),F=o[p]<<f%8&128?255:0;c[u]=l[u+2],c[u+1]=l[u+1],c[u+2]=l[u],c[u+3]=F,u+=4}return this._updateCursor(c,e,t,i,n),!0}_handleDesktopName(){if(this._sock.rQwait("DesktopName",4))return!1;let e=this._sock.rQshift32();if(this._sock.rQwait("DesktopName",e,4))return!1;let t=this._sock.rQshiftStr(e);return t=yt(t,!0),this._setDesktopName(t),!0}_handleExtendedDesktopSize(){if(this._sock.rQwait("ExtendedDesktopSize",4))return!1;const e=this._sock.rQpeek8();let t=4+e*16;if(this._sock.rQwait("ExtendedDesktopSize",t))return!1;const i=!this._supportsSetDesktopSize;this._supportsSetDesktopSize=!0,i&&(this._requestRemoteResize(),R.messages.setMaxVideoResolution(this._sock,this._maxVideoResolutionX,this._maxVideoResolutionY)),this._sock.rQskipBytes(1),this._sock.rQskipBytes(3);for(let n=0;n<e;n+=1){let r=this._sock.rQshift32(),a=this._sock.rQshift16(),h=this._sock.rQshift16(),l=this._sock.rQshift16(),o=this._sock.rQshift16();n==0?(this._screenIndex=0,this._screenFlags=this._sock.rQshiftBytes(4)):this._sock.rQskipBytes(4),this._display.applyServerResolution(l,o,n),C(`Server reported screen ${r} with resolution ${l}x${o} at ${a}x${h}`)}if(this._FBU.x===1&&this._FBU.y!==0){let n="";switch(this._FBU.y){case 1:n="Resize is administratively prohibited",this._resizeSession=!1,this._clipViewport=!1,this._scaleViewport=!1,this.updateConnectionSettings();break;case 2:n="Out of resources";break;case 3:n="Invalid screen layout";break;default:n="Unknown reason";break}V("Server did not accept the resize request: "+n)}else this._resize(this._FBU.width,this._FBU.height);return this._display.screens.length>1&&this._forceFullFrameUpdateAfterResize&&(this._forceFullFrameUpdateAfterResize=!1,clearTimeout(this._forceFullFrameUpdateTimeout),this._forceFullFrameUpdateTimeout=setTimeout((function(){R.messages.fbUpdateRequest(this._sock,!1,0,0,this._fbWidth,this._fbHeight)}).bind(this),500)),!0}_handleDataRect(){let e=this._decoders[this._FBU.encoding];if(!e)return this._fail("Unsupported encoding (encoding: "+this._FBU.encoding+")"),!1;try{return this._transitConnectionState==this.TransitConnectionStates.Udp||this._transitConnectionState==this.TransitConnectionStates.Failure?(this._transitConnectionState==this.TransitConnectionStates.Udp&&(V("Implicit UDP Transit Failure, TCP rects recieved while in UDP mode."),this._udpTransitFailures++),this._changeTransitConnectionState(this.TransitConnectionStates.Tcp),this._display.clear(),this._useUdp&&(this._udpConnectFailures<3&&this._udpTransitFailures<3?setTimeout((function(){V("Attempting to connect via UDP again after failure."),this.enableWebRTC=!0}).bind(this),3e3):V("UDP connection failures exceeded limit, remaining on TCP transit."))):this._transitConnectionState==this.TransitConnectionStates.Downgrading&&(this._display.clear(),this._changeTransitConnectionState(this.TransitConnectionStates.Tcp)),e.decodeRect(this._FBU.x,this._FBU.y,this._FBU.width,this._FBU.height,this._sock,this._display,this._fbDepth,this._FBU.frame_id)}catch(t){return this._fail("Error decoding rect: "+t),!1}}_updateContinuousUpdates(){this._enabledContinuousUpdates&&R.messages.enableContinuousUpdates(this._sock,!0,0,0,this._fbWidth,this._fbHeight)}_resize(e,t){this._fbWidth=e,this._fbHeight=t,this._display.resize(this._fbWidth,this._fbHeight),this._updateClip(),this._updateScale(),this._updateContinuousUpdates()}_xvpOp(e,t){this._rfbXvpVer<e||(I("Sending XVP operation "+t+" (version "+e+")"),R.messages.xvpOp(this._sock,e,t))}_updateCursor(e,t,i,n,r){this._cursorImage={rgbaPixels:e,hotx:t,hoty:i,w:n,h:r},this._refreshCursor(),this._isPrimaryDisplay&&this._proxyRFBMessage("updateCursor",[e,t,i,n,r])}_shouldShowDotCursor(){if(!this._showDotCursor)return!1;for(let e=3;e<this._cursorImage.rgbaPixels.length;e+=4)if(this._cursorImage.rgbaPixels[e])return!1;return!0}_refreshCursor(){if(this._rfbConnectionState!=="connecting"&&this._rfbConnectionState!=="connected")return;const e=this._shouldShowDotCursor()?R.cursors.dot:this._cursorImage;this._cursor.change(e.rgbaPixels,e.hotx,e.hoty,e.w,e.h)}static genDES(e,t){const i=e.split("").map(n=>n.charCodeAt(0));return new Ir(i).encrypt(t)}}R.messages={keyEvent(s,e,t){const i=s._sQ,n=s._sQlen;i[n]=4,i[n+1]=t,i[n+2]=0,i[n+3]=0,i[n+4]=e>>24,i[n+5]=e>>16,i[n+6]=e>>8,i[n+7]=e,s._sQlen+=8,s.flush()},QEMUExtendedKeyEvent(s,e,t,i){function n(l){const o=i>>8,c=i&255;return o===224&&c<127?c|128:l}const r=s._sQ,a=s._sQlen;r[a]=255,r[a+1]=0,r[a+2]=t>>8,r[a+3]=t,r[a+4]=e>>24,r[a+5]=e>>16,r[a+6]=e>>8,r[a+7]=e;const h=n(i);r[a+8]=h>>24,r[a+9]=h>>16,r[a+10]=h>>8,r[a+11]=h,s._sQlen+=12,s.flush()},pointerEvent(s,e,t,i,n=0,r=0){const a=s._sQ,h=s._sQlen;a[h]=5,a[h+1]=i>>8,a[h+2]=i,a[h+3]=e>>8,a[h+4]=e,a[h+5]=t>>8,a[h+6]=t,a[h+7]=n>>8,a[h+8]=n,a[h+9]=r>>8,a[h+10]=r,s._sQlen+=11,s.flush()},_buildExtendedClipboardFlags(s,e){let t=new Uint8Array(4),i=0,n=0;for(let r=0;r<s.length;r++)n|=s[r];for(let r=0;r<e.length;r++)i|=e[r];return t[0]=n>>24,t[1]=0,t[2]=0,t[3]=i,t},extendedClipboardProvide(s,e,t){let i=new Cr,n=[];for(let h=0;h<e.length;h++){if(e[h]!=ae)throw new Error("Unsupported extended clipboard format for Provide message.");t[h]=t[h].replace(/\r\n|\r|\n/gm,`\r
`);let l=Ht(t[h]+"\0");n.push(l.length>>24&255,l.length>>16&255,l.length>>8&255,l.length&255);for(let o=0;o<l.length;o++)n.push(l.charCodeAt(o))}let r=i.deflate(new Uint8Array(n)),a=new Uint8Array(4+r.length);a.set(R.messages._buildExtendedClipboardFlags([ct],e)),a.set(r,4),R.messages.clientCutText(s,a,!0)},extendedClipboardNotify(s,e){let t=R.messages._buildExtendedClipboardFlags([lt],e);R.messages.clientCutText(s,t,!0)},extendedClipboardRequest(s,e){let t=R.messages._buildExtendedClipboardFlags([ht],e);R.messages.clientCutText(s,t,!0)},extendedClipboardCaps(s,e,t){let i=Object.keys(t),n=new Uint8Array(4+4*i.length);i.map(a=>parseInt(a)),i.sort((a,h)=>a-h),n.set(R.messages._buildExtendedClipboardFlags(e,[]));let r=4;for(let a=0;a<i.length;a++)n[r]=t[i[a]]>>24,n[r+1]=t[i[a]]>>16,n[r+2]=t[i[a]]>>8,n[r+3]=t[i[a]]>>0,r+=4,n[3]|=1<<i[a];R.messages.clientCutText(s,n,!0)},clientCutText(s,e,t=!1){const i=s._sQ,n=s._sQlen;i[n]=6,i[n+1]=0,i[n+2]=0,i[n+3]=0;let r;t?r=en(-e.length):r=e.length,i[n+4]=r>>24,i[n+5]=r>>16,i[n+6]=r>>8,i[n+7]=r,s._sQlen+=8;let a=0,h=e.length;for(;h>0;){let l=Math.min(h,s._sQbufferSize-s._sQlen);for(let o=0;o<l;o++)i[s._sQlen+o]=e[a+o];s._sQlen+=l,s.flush(),h-=l,a+=l}},sendBinaryClipboard(s,e,t){const i=s._sQ;let n=s._sQlen;i[n]=180,i[n+1]=e.length,s._sQlen+=2,n+=2;for(let r=0;r<e.length;r++){let a=t[r],h=e[r];i[n++]=a.length;for(let u=0;u<a.length;u++)i[n++]=a.charCodeAt(u);let l=h.length;I("Clipboard data sent mime type "+a+" len "+l),i[n++]=l>>24,i[n++]=l>>16,i[n++]=l>>8,i[n++]=l,s._sQlen+=1+a.length+4;let o=0,c=h.length;for(;c>0;){let u=Math.min(c,s._sQbufferSize-s._sQlen);for(let x=0;x<u;x++)i[s._sQlen+x]=h[o+x];s._sQlen+=u,s.flush(),c-=u,o+=u}n=s._sQlen}},sendSubscribeUnixRelay(s,e){const t=s._sQ,i=s._sQlen;t[i]=182,t[i+1]=e.length;for(let n=0;n<e.length;n++)t[i+2+n]=e.charCodeAt(n);s._sQlen+=2+e.length,s.flush()},sendUnixRelay(s,e,t){const i=s._sQ;let n=s._sQlen;i[n++]=183,i[n++]=e.length;for(let l=0;l<e.length;l++)i[n++]=e.charCodeAt(l);let r=t.length;I("Sent unix relay data len "+r),i[n++]=r>>24,i[n++]=r>>16,i[n++]=r>>8,i[n++]=r,s._sQlen+=2+e.length+4;let a=0,h=t.length;for(;h>0;){let l=Math.min(h,s._sQbufferSize-s._sQlen);for(let o=0;o<l;o++)i[s._sQlen+o]=t[a+o];s._sQlen+=l,s.flush(),h-=l,a+=l}},setDesktopSize(s,e,t){const i=s._sQ,n=s._sQlen;i[n]=251,i[n+1]=0,i[n+2]=e.serverWidth>>8,i[n+3]=e.serverWidth,i[n+4]=e.serverHeight>>8,i[n+5]=e.serverHeight,i[n+6]=e.screens.length,i[n+7]=0;let r=8;for(let a=0;a<e.screens.length;a++)i[n+r++]=a>>24,i[n+r++]=a>>16,i[n+r++]=a>>8,i[n+r++]=a,i[n+r++]=e.screens[a].x>>8,i[n+r++]=e.screens[a].x,i[n+r++]=e.screens[a].y>>8,i[n+r++]=e.screens[a].y,i[n+r++]=e.screens[a].serverWidth>>8,i[n+r++]=e.screens[a].serverWidth,i[n+r++]=e.screens[a].serverHeight>>8,i[n+r++]=e.screens[a].serverHeight,i[n+r++]=t>>24,i[n+r++]=t>>16,i[n+r++]=t>>8,i[n+r++]=t;s._sQlen+=r,s.flush()},setMaxVideoResolution(s,e,t){const i=s._sQ,n=s._sQlen;i[n]=252,i[n+1]=e>>8,i[n+2]=e,i[n+3]=t>>8,i[n+4]=t,s._sQlen+=5,s.flush()},clientFence(s,e,t){const i=s._sQ,n=s._sQlen;i[n]=248,i[n+1]=0,i[n+2]=0,i[n+3]=0,i[n+4]=e>>24,i[n+5]=e>>16,i[n+6]=e>>8,i[n+7]=e;const r=t.length;i[n+8]=r;for(let a=0;a<r;a++)i[n+9+a]=t.charCodeAt(a);s._sQlen+=9+r,s.flush()},requestStats(s){const e=s._sQ,t=s._sQlen;e!=null&&(e[t]=178,e[t+1]=0,e[t+2]=0,e[t+3]=0,s._sQlen+=4,s.flush())},sendFrameStats(s,e,t){const i=s._sQ,n=s._sQlen;i!=null&&(i[n]=179,i[n+1]=0,i[n+2]=0,i[n+3]=0,i[n+4]=e>>24,i[n+5]=e>>16,i[n+6]=e>>8,i[n+7]=e,i[n+8]=t>>24,i[n+9]=t>>16,i[n+10]=t>>8,i[n+11]=t,s._sQlen+=12,s.flush())},enableContinuousUpdates(s,e,t,i,n,r){const a=s._sQ,h=s._sQlen;a[h]=150,a[h+1]=e,a[h+2]=t>>8,a[h+3]=t,a[h+4]=i>>8,a[h+5]=i,a[h+6]=n>>8,a[h+7]=n,a[h+8]=r>>8,a[h+9]=r,s._sQlen+=10,s.flush()},pixelFormat(s,e,t){const i=s._sQ,n=s._sQlen;let r;e>16?r=32:e>8?r=16:r=8;const a=Math.floor(e/3);i[n]=0,i[n+1]=0,i[n+2]=0,i[n+3]=0,i[n+4]=r,i[n+5]=e,i[n+6]=0,i[n+7]=t?1:0,i[n+8]=0,i[n+9]=(1<<a)-1,i[n+10]=0,i[n+11]=(1<<a)-1,i[n+12]=0,i[n+13]=(1<<a)-1,i[n+14]=a*0,i[n+15]=a*1,i[n+16]=a*2,i[n+17]=0,i[n+18]=0,i[n+19]=0,s._sQlen+=20,s.flush()},clientEncodings(s,e){const t=s._sQ,i=s._sQlen;t[i]=2,t[i+1]=0,t[i+2]=e.length>>8,t[i+3]=e.length;let n=i+4;for(let r=0;r<e.length;r++){const a=e[r];t[n]=a>>24,t[n+1]=a>>16,t[n+2]=a>>8,t[n+3]=a,n+=4}s._sQlen+=n-i,s.flush()},fbUpdateRequest(s,e,t,i,n,r){const a=s._sQ,h=s._sQlen;typeof t>"u"&&(t=0),typeof i>"u"&&(i=0),a[h]=3,a[h+1]=e?1:0,a[h+2]=t>>8&255,a[h+3]=t&255,a[h+4]=i>>8&255,a[h+5]=i&255,a[h+6]=n>>8&255,a[h+7]=n&255,a[h+8]=r>>8&255,a[h+9]=r&255,s._sQlen+=10,s.flush()},xvpOp(s,e,t){const i=s._sQ,n=s._sQlen;i[n]=250,i[n+1]=0,i[n+2]=e,i[n+3]=t,s._sQlen+=4,s.flush()}};R.cursors={none:{rgbaPixels:new Uint8Array,w:0,h:0,hotx:0,hoty:0},dot:{rgbaPixels:new Uint8Array([255,255,255,255,0,0,0,255,255,255,255,255,0,0,0,255,0,0,0,0,0,0,0,255,255,255,255,255,0,0,0,255,255,255,255,255]),w:3,h:3,hotx:1,hoty:1}};function sa(s){if(typeof s<"u")Bt(s);else{const e=document.location.href.match(/logging=([A-Za-z0-9._-]*)/);Bt(e||void 0)}}function jr(s,e){const t=new RegExp(".*[?&]"+s+"=([^&#]*)"),i=document.location.href.match(t);return typeof e>"u"&&(e=null),i?decodeURIComponent(i[1]):e}function Zr(s,e){const t=new RegExp(".*[&#]"+s+"=([^&]*)"),i=document.location.hash.match(t);return typeof e>"u"&&(e=null),i?decodeURIComponent(i[1]):e}function na(s,e){const t=Zr(s);return t===null?jr(s,e):t}let re={};function ra(){return!window.chrome||!window.chrome.storage?(re={},Promise.resolve()):new Promise(s=>window.chrome.storage.sync.get(s)).then(s=>{re=s})}function aa(s,e){re[s]=e}function oa(s,e){re[s]!==e&&(re[s]=e,window.chrome&&window.chrome.storage?window.chrome.storage.sync.set(re):localStorage.setItem(s,e))}function ha(s,e){let t;return s in re||window.chrome&&window.chrome.storage?t=re[s]:(t=localStorage.getItem(s),re[s]=t),typeof t>"u"&&(t=null),t===null&&typeof e<"u"?e:t}function la(){try{return window.self!==window.top}catch{return!0}}export{C as D,A as E,_ as K,ia as M,R,ta as X,la as a,qr as b,aa as c,ea as d,Ys as e,Jt as f,na as g,$r as h,sa as i,Gs as j,Os as k,_s as l,ra as m,ha as r,Jr as s,oa as w};
